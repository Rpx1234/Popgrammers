{"version":3,"sources":["../../../src/credentials/credentialsJson/update.ts"],"names":["updateAndroidCredentialsAsync","ctx","credentialsJsonFilePath","path","join","projectDir","rawCredentialsJsonObject","fs","pathExists","rawFile","readFile","JSON","parse","error","Log","experienceName","projectOwner","manifest","slug","keystore","android","fetchKeystore","isKeystoreComplete","keystorePassword","keyPassword","keyAlias","confirm","message","warn","keystorePath","log","updateFileAsync","shouldWarnKeystore","isFileUntrackedAsync","writeJson","spaces","shouldWarnCredentialsJson","newFilePaths","push","displayUntrackedFilesWarning","updateIosCredentialsAsync","bundleIdentifier","appLookupParams","accountName","projectName","pprofilePath","ios","provisioningProfilePath","distCertPath","distributionCertificate","appCredentials","getAppCredentials","distCredentials","getDistCert","credentials","provisioningProfile","areCredentialsComplete","certP12","certPassword","shouldWarnPProfile","shouldWarnDistCert","password","filePath","base64Data","absolutePath","isAbsolute","remove","mkdirp","dirname","writeFile","Buffer","from","withUntrackedFiles","showUntracked","trackedFiles","pathWithoutLeadingDot","replace","includes","length"],"mappings":"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","sourcesContent":["import fs from 'fs-extra';\nimport path from 'path';\n\nimport Log from '../../log';\nimport { confirmAsync } from '../../utils/prompts';\nimport { Context } from '../context';\nimport { gitStatusAsync } from '../utils/git';\n\nexport async function updateAndroidCredentialsAsync(ctx: Context) {\n  const credentialsJsonFilePath = path.join(ctx.projectDir, 'credentials.json');\n  let rawCredentialsJsonObject: any = {};\n  if (await fs.pathExists(credentialsJsonFilePath)) {\n    try {\n      const rawFile = await fs.readFile(credentialsJsonFilePath, 'utf-8');\n      rawCredentialsJsonObject = JSON.parse(rawFile);\n    } catch (error) {\n      Log.error(`There was an error while reading credentials.json [${error}]`);\n      Log.error('Make sure that file is correct (or remove it) and rerun this command.');\n      throw error;\n    }\n  }\n  const experienceName = `@${ctx.projectOwner}/${ctx.manifest.slug}`;\n  const keystore = await ctx.android.fetchKeystore(experienceName);\n  if (!keystore) {\n    Log.error('There are no credentials configured for this project on Expo servers');\n    return;\n  }\n\n  const isKeystoreComplete =\n    keystore.keystore && keystore.keystorePassword && keystore.keyPassword && keystore.keyAlias;\n\n  if (!isKeystoreComplete) {\n    const confirm = await confirmAsync({\n      message:\n        'Credentials on Expo servers might be invalid or incomplete. Are you sure you want to continue?',\n    });\n    if (!confirm) {\n      Log.warn('Aborting...');\n      return;\n    }\n  }\n\n  const keystorePath =\n    rawCredentialsJsonObject?.android?.keystore?.keystorePath ?? 'android/keystores/keystore.jks';\n  Log.log(`Writing Keystore to ${keystorePath}`);\n  await updateFileAsync(ctx.projectDir, keystorePath, keystore.keystore);\n  const shouldWarnKeystore = await isFileUntrackedAsync(keystorePath);\n\n  rawCredentialsJsonObject.android = {\n    keystore: {\n      keystorePath,\n      keystorePassword: keystore.keystorePassword,\n      keyAlias: keystore.keyAlias,\n      keyPassword: keystore.keyPassword,\n    },\n  };\n  await fs.writeJson(credentialsJsonFilePath, rawCredentialsJsonObject, {\n    spaces: 2,\n  });\n  const shouldWarnCredentialsJson = await isFileUntrackedAsync('credentials.json');\n\n  const newFilePaths = [];\n  if (shouldWarnKeystore) {\n    newFilePaths.push(keystorePath);\n  }\n  if (shouldWarnCredentialsJson) {\n    newFilePaths.push('credentials.json');\n  }\n  displayUntrackedFilesWarning(newFilePaths);\n}\n\nexport async function updateIosCredentialsAsync(ctx: Context, bundleIdentifier: string) {\n  const credentialsJsonFilePath = path.join(ctx.projectDir, 'credentials.json');\n  let rawCredentialsJsonObject: any = {};\n  if (await fs.pathExists(credentialsJsonFilePath)) {\n    try {\n      const rawFile = await fs.readFile(credentialsJsonFilePath, 'utf-8');\n      rawCredentialsJsonObject = JSON.parse(rawFile);\n    } catch (error) {\n      Log.error(`There was an error while reading credentials.json [${error}]`);\n      Log.error('Make sure that file is correct (or remove it) and rerun this command.');\n      throw error;\n    }\n  }\n\n  const appLookupParams = {\n    accountName: ctx.projectOwner,\n    projectName: ctx.manifest.slug,\n    bundleIdentifier,\n  };\n  const pprofilePath =\n    rawCredentialsJsonObject?.ios?.provisioningProfilePath ?? 'ios/certs/profile.mobileprovision';\n  const distCertPath =\n    rawCredentialsJsonObject?.ios?.distributionCertificate?.path ?? 'ios/certs/dist-cert.p12';\n  const appCredentials = await ctx.ios.getAppCredentials(appLookupParams);\n  const distCredentials = await ctx.ios.getDistCert(appLookupParams);\n  if (!appCredentials?.credentials?.provisioningProfile && !distCredentials) {\n    Log.error('There are no credentials configured for this project on Expo servers');\n    return;\n  }\n\n  const areCredentialsComplete =\n    appCredentials?.credentials?.provisioningProfile &&\n    distCredentials?.certP12 &&\n    distCredentials?.certPassword;\n\n  if (!areCredentialsComplete) {\n    const confirm = await confirmAsync({\n      message:\n        'Credentials on Expo servers might be invalid or incomplete. Are you sure you want to continue?',\n    });\n    if (!confirm) {\n      Log.warn('Aborting...');\n      return;\n    }\n  }\n\n  Log.log(`Writing Provisioning Profile to ${pprofilePath}`);\n  await updateFileAsync(\n    ctx.projectDir,\n    pprofilePath,\n    appCredentials?.credentials?.provisioningProfile\n  );\n  const shouldWarnPProfile = await isFileUntrackedAsync(pprofilePath);\n\n  Log.log(`Writing Distribution Certificate to ${distCertPath}`);\n  await updateFileAsync(ctx.projectDir, distCertPath, distCredentials?.certP12);\n  const shouldWarnDistCert = await isFileUntrackedAsync(distCertPath);\n\n  rawCredentialsJsonObject.ios = {\n    ...(appCredentials?.credentials?.provisioningProfile\n      ? { provisioningProfilePath: pprofilePath }\n      : {}),\n    ...(distCredentials?.certP12 && distCredentials?.certPassword\n      ? {\n          distributionCertificate: {\n            path: distCertPath,\n            password: distCredentials?.certPassword,\n          },\n        }\n      : {}),\n  };\n  await fs.writeJson(credentialsJsonFilePath, rawCredentialsJsonObject, {\n    spaces: 2,\n  });\n  const shouldWarnCredentialsJson = await isFileUntrackedAsync('credentials.json');\n\n  const newFilePaths = [];\n  if (shouldWarnPProfile) {\n    newFilePaths.push(pprofilePath);\n  }\n  if (shouldWarnDistCert) {\n    newFilePaths.push(distCertPath);\n  }\n  if (shouldWarnCredentialsJson) {\n    newFilePaths.push('credentials.json');\n  }\n  displayUntrackedFilesWarning(newFilePaths);\n}\n\nasync function updateFileAsync(projectDir: string, filePath: string, base64Data?: string) {\n  const absolutePath = path.isAbsolute(filePath) ? filePath : path.join(projectDir, filePath);\n  if (await fs.pathExists(absolutePath)) {\n    await fs.remove(absolutePath);\n  }\n  if (base64Data) {\n    await fs.mkdirp(path.dirname(filePath));\n    await fs.writeFile(filePath, Buffer.from(base64Data, 'base64'));\n  }\n}\n\nasync function isFileUntrackedAsync(path: string): Promise<boolean> {\n  const withUntrackedFiles = await gitStatusAsync({ showUntracked: true });\n  const trackedFiles = await gitStatusAsync({ showUntracked: false });\n  const pathWithoutLeadingDot = path.replace(/^\\.\\//, ''); // remove leading './' from path\n  return (\n    withUntrackedFiles.includes(pathWithoutLeadingDot) &&\n    !trackedFiles.includes(pathWithoutLeadingDot)\n  );\n}\n\nfunction displayUntrackedFilesWarning(newFilePaths: string[]) {\n  if (newFilePaths.length === 1) {\n    Log.warn(\n      `File ${newFilePaths[0]} is currently untracked, remember to add it to .gitignore or to encrypt it. (e.g. with git-crypt)`\n    );\n  } else if (newFilePaths.length > 1) {\n    Log.warn(\n      `Files ${newFilePaths.join(\n        ', '\n      )} are currently untracked, remember to add them to .gitignore or to encrypt them. (e.g. with git-crypt)`\n    );\n  }\n}\n"],"file":"update.js"}