{"version":3,"sources":["../../../../src/commands/run/ios/developmentCodeSigning.ts"],"names":["getLastDeveloperCodeSigningIdAsync","developmentCodeSigningId","UserSettings","readAsync","setLastDeveloperCodeSigningIdAsync","id","setAsync","catch","getCodeSigningInfoForPbxproj","projectRoot","project","IOSConfig","XcodeUtils","getPbxproj","targets","Target","findSignableTargets","signingInfo","nativeTargetId","nativeTarget","developmentTeams","provisioningProfiles","getBuildConfigurationsForListId","buildConfigurationList","filter","item","buildSettings","PRODUCT_NAME","forEach","DEVELOPMENT_TEAM","PROVISIONING_PROFILE","push","setAutoCodeSigningInfoForPbxproj","appleTeamId","quotedAppleTeamId","ensureQuotes","CODE_SIGN_IDENTITY","CODE_SIGN_STYLE","Object","entries","getProjectSection","isNotComment","attributes","TargetAttributes","DevelopmentTeam","ProvisioningStyle","fs","writeFileSync","filepath","writeSync","value","match","ensureDeviceIsCodeSignedForDeploymentAsync","allTargetsHaveTeams","values","reduce","prev","curr","length","teamList","concat","Log","log","chalk","dim","join","allTargetsHaveProfiles","Security","assertInstalledAsync","ids","findIdentitiesAsync","selectCertificateSigningIdentityAsync","codeSigningInfo","sortDefaultIdToBeginningAsync","identities","lastSelected","iterations","signingCertificateId","shift","addNewLineIfNone","bold","newLine","CommandError","program","nonInteractive","resolveCertificateSigningInfoAsync","preferred","resolveIdentitiesAsync","index","message","choices","map","i","format","title","appleTeamName","selected"],"mappings":";;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;;;AAEA,eAAeA,kCAAf,GAAoD;AAClD,QAAM;AAAEC,IAAAA;AAAF,MAA+B,MAAMC,oBAAaC,SAAb,EAA3C;AACA,SAAOF,wBAAP;AACD;;AAED,eAAeG,kCAAf,CAAkDC,EAAlD,EAA8D;AAC5D,QAAMH,oBAAaI,QAAb,CAAsB,0BAAtB,EAAkDD,EAAlD,EAAsDE,KAAtD,CAA4D,MAAM,CAAE,CAApE,CAAN;AACD;AAED;AACA;AACA;AACA;AACA;AACA;;;AACO,SAASC,4BAAT,CAAsCC,WAAtC,EAA2D;AAChE,QAAMC,OAAO,GAAGC,2BAAUC,UAAV,CAAqBC,UAArB,CAAgCJ,WAAhC,CAAhB;;AACA,QAAMK,OAAO,GAAGH,2BAAUI,MAAV,CAAiBC,mBAAjB,CAAqCN,OAArC,CAAhB;;AAEA,QAAMO,WAGL,GAAG,EAHJ;;AAIA,OAAK,MAAM,CAACC,cAAD,EAAiBC,YAAjB,CAAX,IAA6CL,OAA7C,EAAsD;AACpD,UAAMM,gBAA0B,GAAG,EAAnC;AACA,UAAMC,oBAA8B,GAAG,EAAvC;;AAEAV,+BAAUC,UAAV,CAAqBU,+BAArB,CACEZ,OADF,EAEES,YAAY,CAACI,sBAFf,EAIGC,MAJH,CAKI,CAAC,GAAGC,IAAH,CAAD,KACEA,IAAI,CAACC,aAAL,CAAmBC,YANzB,EAQGC,OARH,CAQW,CAAC,GAAGH,IAAH,CAAD,KAA8D;AACrE,YAAM;AAAEI,QAAAA,gBAAF;AAAoBC,QAAAA;AAApB,UAA6CL,IAAI,CAACC,aAAxD;;AACA,UACE,OAAOG,gBAAP,KAA4B,QAA5B,IACA;AACA,OAAC,CAACA,gBAFF,IAGA;AACAA,MAAAA,gBAAgB,KAAK,IALvB,EAME;AACAT,QAAAA,gBAAgB,CAACW,IAAjB,CAAsBF,gBAAtB;AACD;;AACD,UAAI,OAAOC,oBAAP,KAAgC,QAAhC,IAA4C,CAAC,CAACA,oBAAlD,EAAwE;AACtET,QAAAA,oBAAoB,CAACU,IAArB,CAA0BD,oBAA1B;AACD;AACF,KAtBH;;AAuBAb,IAAAA,WAAW,CAACC,cAAD,CAAX,GAA8B;AAC5BE,MAAAA,gBAD4B;AAE5BC,MAAAA;AAF4B,KAA9B;AAID;;AAED,SAAOJ,WAAP;AACD;AAED;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASe,gCAAT,CACEvB,WADF,EAEE;AAAEwB,EAAAA;AAAF,CAFF,EAGQ;AACN,QAAMvB,OAAO,GAAGC,2BAAUC,UAAV,CAAqBC,UAArB,CAAgCJ,WAAhC,CAAhB;;AACA,QAAMK,OAAO,GAAGH,2BAAUI,MAAV,CAAiBC,mBAAjB,CAAqCN,OAArC,CAAhB;;AAEA,QAAMwB,iBAAiB,GAAGC,YAAY,CAACF,WAAD,CAAtC;;AAEA,OAAK,MAAM,CAACf,cAAD,EAAiBC,YAAjB,CAAX,IAA6CL,OAA7C,EAAsD;AACpDH,+BAAUC,UAAV,CAAqBU,+BAArB,CACEZ,OADF,EAEES,YAAY,CAACI,sBAFf,EAIGC,MAJH,CAKI,CAAC,GAAGC,IAAH,CAAD,KACEA,IAAI,CAACC,aAAL,CAAmBC,YANzB,EAQGC,OARH,CAQW,CAAC,GAAGH,IAAH,CAAD,KAA8D;AACrEA,MAAAA,IAAI,CAACC,aAAL,CAAmBG,gBAAnB,GAAsCK,iBAAtC;AACAT,MAAAA,IAAI,CAACC,aAAL,CAAmBU,kBAAnB,GAAwC,qBAAxC;AACAX,MAAAA,IAAI,CAACC,aAAL,CAAmBW,eAAnB,GAAqC,WAArC;AACD,KAZH;;AAcAC,IAAAA,MAAM,CAACC,OAAP,CAAe5B,2BAAUC,UAAV,CAAqB4B,iBAArB,CAAuC9B,OAAvC,CAAf,EACGc,MADH,CACUb,2BAAUC,UAAV,CAAqB6B,YAD/B,EAEGb,OAFH,CAEW,CAAC,GAAGH,IAAH,CAAD,KAAwD;AAC/D,UAAI,CAACA,IAAI,CAACiB,UAAL,CAAgBC,gBAAhB,CAAiCzB,cAAjC,CAAL,EAAuD;AACrDO,QAAAA,IAAI,CAACiB,UAAL,CAAgBC,gBAAhB,CAAiCzB,cAAjC,IAAmD,EAAnD;AACD;;AAEDO,MAAAA,IAAI,CAACiB,UAAL,CAAgBC,gBAAhB,CAAiCzB,cAAjC,EAAiD0B,eAAjD,GAAmEV,iBAAnE;AACAT,MAAAA,IAAI,CAACiB,UAAL,CAAgBC,gBAAhB,CAAiCzB,cAAjC,EAAiD2B,iBAAjD,GAAqE,WAArE;AACD,KATH;AAUD;;AAEDC,EAAAA,EAAE,GAACC,aAAH,CAAiBrC,OAAO,CAACsC,QAAzB,EAAmCtC,OAAO,CAACuC,SAAR,EAAnC;AACD;;AAED,MAAMd,YAAY,GAAIe,KAAD,IAAmB;AACtC,MAAI,CAACA,KAAK,CAACC,KAAN,CAAY,OAAZ,CAAL,EAA2B;AACzB,WAAQ,IAAGD,KAAM,GAAjB;AACD;;AACD,SAAOA,KAAP;AACD,CALD;;AAOO,eAAeE,0CAAf,CACL3C,WADK,EAEmB;AACxB;AACA,QAAMQ,WAAW,GAAGT,4BAA4B,CAACC,WAAD,CAAhD;AAEA,QAAM4C,mBAAmB,GAAGf,MAAM,CAACgB,MAAP,CAAcrC,WAAd,EAA2BsC,MAA3B,CAAkC,CAACC,IAAD,EAAOC,IAAP,KAAgB;AAC5E,WAAOD,IAAI,IAAI,CAAC,CAACC,IAAI,CAACrC,gBAAL,CAAsBsC,MAAvC;AACD,GAF2B,EAEzB,IAFyB,CAA5B;;AAIA,MAAIL,mBAAJ,EAAyB;AACvB,UAAMM,QAAQ,GAAGrB,MAAM,CAACgB,MAAP,CAAcrC,WAAd,EAA2BsC,MAA3B,CAA4C,CAACC,IAAD,EAAOC,IAAP,KAAgB;AAC3E,aAAOD,IAAI,CAACI,MAAL,CAAY,CAACH,IAAI,CAACrC,gBAAL,CAAsB,CAAtB,CAAD,CAAZ,CAAP;AACD,KAFgB,EAEd,EAFc,CAAjB;;AAGAyC,mBAAIC,GAAJ,CAAQC,iBAAMC,GAAI,0CAAyCL,QAAQ,CAACM,IAAT,CAAc,IAAd,CAAoB,EAA/E;;AACA,WAAO,IAAP;AACD;;AAED,QAAMC,sBAAsB,GAAG5B,MAAM,CAACgB,MAAP,CAAcrC,WAAd,EAA2BsC,MAA3B,CAAkC,CAACC,IAAD,EAAOC,IAAP,KAAgB;AAC/E,WAAOD,IAAI,IAAI,CAAC,CAACC,IAAI,CAACpC,oBAAL,CAA0BqC,MAA3C;AACD,GAF8B,EAE5B,IAF4B,CAA/B;;AAGA,MAAIQ,sBAAJ,EAA4B;AAC1B;AACA,WAAO,IAAP;AACD,GAtBuB,CAwBxB;;;AACA,QAAMC,QAAQ,GAACC,oBAAT,EAAN;AAEA,QAAMC,GAAG,GAAG,MAAMF,QAAQ,GAACG,mBAAT,EAAlB;AAEA,QAAMjE,EAAE,GAAG,MAAMkE,qCAAqC,CAACF,GAAD,CAAtD;;AAEAR,iBAAIC,GAAJ,CAAS,6CAA4CzD,EAAE,CAACmE,eAAgB,EAAxE;;AAEAxC,EAAAA,gCAAgC,CAACvB,WAAD,EAAc;AAC5CwB,IAAAA,WAAW,EAAE5B,EAAE,CAAC4B;AAD4B,GAAd,CAAhC;AAGA,SAAO5B,EAAE,CAAC4B,WAAV;AACD;AAED;AACA;AACA;;;AACA,eAAewC,6BAAf,CACEC,UADF,EAEoE;AAClE,QAAMC,YAAY,GAAG,MAAM3E,kCAAkC,EAA7D;;AAEA,MAAI2E,YAAJ,EAAkB;AAChB,QAAIC,UAAU,GAAG,CAAjB;;AACA,WAAOF,UAAU,CAAC,CAAD,CAAV,CAAcG,oBAAd,KAAuCF,YAAvC,IAAuDC,UAAU,GAAGF,UAAU,CAAChB,MAAtF,EAA8F;AAC5FgB,MAAAA,UAAU,CAAC3C,IAAX,CAAgB2C,UAAU,CAACI,KAAX,EAAhB;AACAF,MAAAA,UAAU;AACX;AACF;;AACD,SAAO,CAACF,UAAD,EAAaC,YAAb,CAAP;AACD;;AAED,eAAeJ,qCAAf,CAAqDF,GAArD,EAAoE;AAClE;AACA,MAAI,CAACA,GAAG,CAACX,MAAT,EAAiB;AACf;AACAG,mBAAIkB,gBAAJ;;AACAlB,mBAAIC,GAAJ,CACG,0GAAyGC,iBAAMiB,IAAN,CACxG,+BAAU,sCAAV,CADwG,CAExG,EAHJ;;AAKAnB,mBAAIoB,OAAJ;;AACA,UAAM,KAAIC,uBAAJ,EAAiB,oDAAjB,CAAN;AACD,GAZiE,CAclE;AACA;AACA;;;AACA,MAAIb,GAAG,CAACX,MAAJ,KAAe,CAAf,IAAoByB,qBAAQC,cAAhC,EAAgD;AAC9C,WAAOjB,QAAQ,GAACkB,kCAAT,CAA4ChB,GAAG,CAAC,CAAD,CAA/C,CAAP;AACD,GAnBiE,CAqBlE;;;AACA,QAAM,CAACK,UAAD,EAAaY,SAAb,IAA0B,MAAMb,6BAA6B,CACjE,MAAMN,QAAQ,GAACoB,sBAAT,CAAgClB,GAAhC,CAD2D,CAAnE;AAIA,QAAMmB,KAAK,GAAG,MAAM,4BAAY;AAC9BC,IAAAA,OAAO,EAAE,sCADqB;AAE9BC,IAAAA,OAAO,EAAEhB,UAAU,CAACiB,GAAX,CAAe,CAACzC,KAAD,EAAQ0C,CAAR,KAAc;AACpC,YAAMC,MAAM,GACV3C,KAAK,CAAC2B,oBAAN,KAA+BS,SAA/B,GAA2CvB,iBAAMiB,IAAjD,GAAyDS,OAAD,IAAqBA,OAD/E;AAEA,aAAO;AACL;AACAK,QAAAA,KAAK,EAAED,MAAM,CACX,CAAC3C,KAAK,CAAC6C,aAAP,EAAuB,IAAG7C,KAAK,CAACjB,WAAY,KAA5C,EAAkDiB,KAAK,CAACsB,eAAxD,EAAyEP,IAAzE,CAA8E,GAA9E,CADW,CAFR;AAKLf,QAAAA,KAAK,EAAE0C;AALF,OAAP;AAOD,KAVQ;AAFqB,GAAZ,CAApB;AAeA,QAAMI,QAAQ,GAAGtB,UAAU,CAACc,KAAD,CAA3B,CAzCkE,CA2ClE;AACA;;AACA,QAAMpF,kCAAkC,CAAC4F,QAAQ,CAACnB,oBAAV,CAAxC;AAEA,SAAOmB,QAAP;AACD","sourcesContent":["import { IOSConfig } from '@expo/config-plugins';\nimport chalk from 'chalk';\nimport program from 'commander';\nimport * as fs from 'fs-extra';\nimport { UserSettings } from 'xdl';\n\nimport CommandError from '../../../CommandError';\nimport Log from '../../../log';\nimport { selectAsync } from '../../../utils/prompts';\nimport { learnMore } from '../../utils/TerminalLink';\nimport * as Security from '../utils/Security';\n\nasync function getLastDeveloperCodeSigningIdAsync() {\n  const { developmentCodeSigningId } = await UserSettings.readAsync();\n  return developmentCodeSigningId;\n}\n\nasync function setLastDeveloperCodeSigningIdAsync(id: string) {\n  await UserSettings.setAsync('developmentCodeSigningId', id).catch(() => {});\n}\n\n/**\n * Find the development team and provisioning profile that's currently in use by the Xcode project.\n *\n * @param projectRoot\n * @returns\n */\nexport function getCodeSigningInfoForPbxproj(projectRoot: string) {\n  const project = IOSConfig.XcodeUtils.getPbxproj(projectRoot);\n  const targets = IOSConfig.Target.findSignableTargets(project);\n\n  const signingInfo: Record<\n    string,\n    { developmentTeams: string[]; provisioningProfiles: string[] }\n  > = {};\n  for (const [nativeTargetId, nativeTarget] of targets) {\n    const developmentTeams: string[] = [];\n    const provisioningProfiles: string[] = [];\n\n    IOSConfig.XcodeUtils.getBuildConfigurationsForListId(\n      project,\n      nativeTarget.buildConfigurationList\n    )\n      .filter(\n        ([, item]: IOSConfig.XcodeUtils.ConfigurationSectionEntry) =>\n          item.buildSettings.PRODUCT_NAME\n      )\n      .forEach(([, item]: IOSConfig.XcodeUtils.ConfigurationSectionEntry) => {\n        const { DEVELOPMENT_TEAM, PROVISIONING_PROFILE } = item.buildSettings;\n        if (\n          typeof DEVELOPMENT_TEAM === 'string' &&\n          // If the user selects \"Team: none\" in Xcode, it'll be an empty string.\n          !!DEVELOPMENT_TEAM &&\n          // xcode package sometimes reads an empty string as a quoted empty string.\n          DEVELOPMENT_TEAM !== '\"\"'\n        ) {\n          developmentTeams.push(DEVELOPMENT_TEAM);\n        }\n        if (typeof PROVISIONING_PROFILE === 'string' && !!PROVISIONING_PROFILE) {\n          provisioningProfiles.push(PROVISIONING_PROFILE);\n        }\n      });\n    signingInfo[nativeTargetId] = {\n      developmentTeams,\n      provisioningProfiles,\n    };\n  }\n\n  return signingInfo;\n}\n\n/**\n * Set the development team and configure the Xcode project for automatic code signing,\n * this helps us resolve the code signing on subsequent runs and emulates Xcode behavior.\n *\n * @param projectRoot\n * @param props.appleTeamId\n */\nfunction setAutoCodeSigningInfoForPbxproj(\n  projectRoot: string,\n  { appleTeamId }: { appleTeamId: string }\n): void {\n  const project = IOSConfig.XcodeUtils.getPbxproj(projectRoot);\n  const targets = IOSConfig.Target.findSignableTargets(project);\n\n  const quotedAppleTeamId = ensureQuotes(appleTeamId);\n\n  for (const [nativeTargetId, nativeTarget] of targets) {\n    IOSConfig.XcodeUtils.getBuildConfigurationsForListId(\n      project,\n      nativeTarget.buildConfigurationList\n    )\n      .filter(\n        ([, item]: IOSConfig.XcodeUtils.ConfigurationSectionEntry) =>\n          item.buildSettings.PRODUCT_NAME\n      )\n      .forEach(([, item]: IOSConfig.XcodeUtils.ConfigurationSectionEntry) => {\n        item.buildSettings.DEVELOPMENT_TEAM = quotedAppleTeamId;\n        item.buildSettings.CODE_SIGN_IDENTITY = '\"Apple Development\"';\n        item.buildSettings.CODE_SIGN_STYLE = 'Automatic';\n      });\n\n    Object.entries(IOSConfig.XcodeUtils.getProjectSection(project))\n      .filter(IOSConfig.XcodeUtils.isNotComment)\n      .forEach(([, item]: IOSConfig.XcodeUtils.ProjectSectionEntry) => {\n        if (!item.attributes.TargetAttributes[nativeTargetId]) {\n          item.attributes.TargetAttributes[nativeTargetId] = {};\n        }\n\n        item.attributes.TargetAttributes[nativeTargetId].DevelopmentTeam = quotedAppleTeamId;\n        item.attributes.TargetAttributes[nativeTargetId].ProvisioningStyle = 'Automatic';\n      });\n  }\n\n  fs.writeFileSync(project.filepath, project.writeSync());\n}\n\nconst ensureQuotes = (value: string) => {\n  if (!value.match(/^['\"]/)) {\n    return `\"${value}\"`;\n  }\n  return value;\n};\n\nexport async function ensureDeviceIsCodeSignedForDeploymentAsync(\n  projectRoot: string\n): Promise<string | null> {\n  // Check if the app already has a development team defined.\n  const signingInfo = getCodeSigningInfoForPbxproj(projectRoot);\n\n  const allTargetsHaveTeams = Object.values(signingInfo).reduce((prev, curr) => {\n    return prev && !!curr.developmentTeams.length;\n  }, true);\n\n  if (allTargetsHaveTeams) {\n    const teamList = Object.values(signingInfo).reduce<string[]>((prev, curr) => {\n      return prev.concat([curr.developmentTeams[0]]);\n    }, []);\n    Log.log(chalk.dim`\\u203A Auto signing app using team(s): ${teamList.join(', ')}`);\n    return null;\n  }\n\n  const allTargetsHaveProfiles = Object.values(signingInfo).reduce((prev, curr) => {\n    return prev && !!curr.provisioningProfiles.length;\n  }, true);\n  if (allTargetsHaveProfiles) {\n    // this indicates that the user has manual code signing setup (possibly for production).\n    return null;\n  }\n\n  // Only assert if the project needs to be signed.\n  await Security.assertInstalledAsync();\n\n  const ids = await Security.findIdentitiesAsync();\n\n  const id = await selectCertificateSigningIdentityAsync(ids);\n\n  Log.log(`\\u203A Signing and building iOS app with: ${id.codeSigningInfo}`);\n\n  setAutoCodeSigningInfoForPbxproj(projectRoot, {\n    appleTeamId: id.appleTeamId!,\n  });\n  return id.appleTeamId!;\n}\n\n/**\n * Sort the code signing items so the last selected item (user's default) is the first suggested.\n */\nasync function sortDefaultIdToBeginningAsync(\n  identities: Security.CertificateSigningInfo[]\n): Promise<[Security.CertificateSigningInfo[], string | undefined]> {\n  const lastSelected = await getLastDeveloperCodeSigningIdAsync();\n\n  if (lastSelected) {\n    let iterations = 0;\n    while (identities[0].signingCertificateId !== lastSelected && iterations < identities.length) {\n      identities.push(identities.shift()!);\n      iterations++;\n    }\n  }\n  return [identities, lastSelected];\n}\n\nasync function selectCertificateSigningIdentityAsync(ids: string[]) {\n  // The user has no valid code signing identities.\n  if (!ids.length) {\n    // TODO: We can probably do this too.\n    Log.addNewLineIfNone();\n    Log.log(\n      `\\u203A Your computer requires some additional setup before you can build onto physical iOS devices.\\n  ${chalk.bold(\n        learnMore('https://expo.fyi/setup-xcode-signing')\n      )}`\n    );\n    Log.newLine();\n    throw new CommandError('No code signing certificates are available to use.');\n  }\n\n  //  One ID available 🤝 Program is not interactive\n  //\n  //     using the the first available option\n  if (ids.length === 1 || program.nonInteractive) {\n    return Security.resolveCertificateSigningInfoAsync(ids[0]);\n  }\n\n  // Get identities and sort by the one that the user is most likely to choose.\n  const [identities, preferred] = await sortDefaultIdToBeginningAsync(\n    await Security.resolveIdentitiesAsync(ids)\n  );\n\n  const index = await selectAsync({\n    message: 'Development team for signing the app',\n    choices: identities.map((value, i) => {\n      const format =\n        value.signingCertificateId === preferred ? chalk.bold : (message: string) => message;\n      return {\n        // Formatted like: `650 Industries, Inc. (A1BCDEF234) - Apple Development: Evan Bacon (AA00AABB0A)`\n        title: format(\n          [value.appleTeamName, `(${value.appleTeamId}) -`, value.codeSigningInfo].join(' ')\n        ),\n        value: i,\n      };\n    }),\n  });\n\n  const selected = identities[index];\n\n  // Store the last used value and suggest it as the first value\n  // next time the user has to select a code signing identity.\n  await setLastDeveloperCodeSigningIdAsync(selected.signingCertificateId);\n\n  return selected;\n}\n"],"file":"developmentCodeSigning.js"}