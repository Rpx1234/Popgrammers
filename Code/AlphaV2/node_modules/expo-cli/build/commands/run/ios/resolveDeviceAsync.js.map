{"version":3,"sources":["../../../../src/commands/run/ios/resolveDeviceAsync.ts"],"names":["getBuildDestinationsAsync","osType","devices","SimControl","listDevicesAsync","filter","device","deviceType","simulators","Simulator","sortDefaultDeviceToBeginningAsync","listSimulatorDevicesAsync","resolveDeviceAsync","ensureXcodeCommandLineToolsInstalledAsync","CommandError","simulator","ensureSimulatorOpenAsync","Log","debug","name","udid","spinner","AppleDevice","isEnabled","chalk","cyan","start","catch","stop","value","type","limit","message","choices","map","item","isConnected","isActive","state","symbol","format","bold","text","title","osVersion","dim","suggest","input","regex","RegExp","choice","test","log","find","isSimulator","startsWith","searchValue","toLowerCase","resolved"],"mappings":"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","sourcesContent":["import chalk from 'chalk';\nimport { AppleDevice, SimControl, Simulator } from 'xdl';\n\nimport CommandError from '../../../CommandError';\nimport Log from '../../../log';\nimport { ora } from '../../../utils/ora';\nimport prompt from '../../../utils/prompts';\nimport { profileMethod } from '../../utils/profileMethod';\n\nasync function getBuildDestinationsAsync({ osType }: { osType?: string } = {}) {\n  const devices = (\n    await profileMethod(SimControl.listDevicesAsync, 'SimControl.listDevicesAsync')()\n  ).filter(device => {\n    return device.deviceType === 'device';\n  });\n\n  const simulators = await Simulator.sortDefaultDeviceToBeginningAsync(\n    await profileMethod(SimControl.listSimulatorDevicesAsync)(),\n    osType\n  );\n\n  return [...devices, ...simulators];\n}\n\nexport async function resolveDeviceAsync(\n  device?: string | boolean,\n  { osType }: { osType?: string } = {}\n): Promise<SimControl.SimulatorDevice | SimControl.XCTraceDevice> {\n  if (!(await profileMethod(Simulator.ensureXcodeCommandLineToolsInstalledAsync)())) {\n    throw new CommandError('Unable to verify Xcode and Simulator installation.');\n  }\n\n  if (!device) {\n    const simulator = await profileMethod(\n      Simulator.ensureSimulatorOpenAsync,\n      'Simulator.ensureSimulatorOpenAsync'\n    )({ osType });\n    Log.debug(`Resolved default (${osType}) device:`, simulator.name, simulator.udid);\n    return simulator;\n  }\n\n  // Only use the spinner with xctrace since it's so slow (~2s), alternative\n  // method is very fast (~50ms) and the flicker makes it seem slower.\n  const spinner = AppleDevice.isEnabled()\n    ? null\n    : ora(`🔍 Finding ${device === true ? 'devices' : `device ${chalk.cyan(device)}`}`).start();\n  let devices: (SimControl.SimulatorDevice | SimControl.XCTraceDevice)[] = await profileMethod(\n    getBuildDestinationsAsync\n  )({ osType }).catch(() => []);\n\n  spinner?.stop();\n\n  if (device === true) {\n    // If osType is defined, then filter out ineligible simulators.\n    // Only do this inside of the device selection so users who pass the entire device udid can attempt to select any simulator (even if it's invalid).\n    if (osType) {\n      devices = devices.filter(device => {\n        // connected device\n        if (!('osType' in device)) {\n          return true;\n        }\n        return device.osType === osType;\n      });\n    }\n\n    // --device with no props after\n    const { value } = await prompt({\n      type: 'autocomplete',\n      name: 'value',\n      limit: 11,\n      message: 'Select a simulator',\n      choices: devices.map(item => {\n        const isConnected = 'deviceType' in item && item.deviceType === 'device';\n        const isActive = 'state' in item && item.state === 'Booted';\n        const symbol = isConnected ? '🔌 ' : '';\n        const format = isActive ? chalk.bold : (text: string) => text;\n        return {\n          title: `${symbol}${format(item.name)}${\n            item.osVersion ? chalk.dim(` (${item.osVersion})`) : ''\n          }`,\n          value: item.udid,\n        };\n      }),\n      suggest: (input: any, choices: any) => {\n        const regex = new RegExp(input, 'i');\n        return choices.filter((choice: any) => regex.test(choice.title));\n      },\n    });\n    Log.log(chalk.dim`\\u203A Using --device ${value}`);\n    const device = devices.find(device => device.udid === value)!;\n    const isSimulator =\n      !('deviceType' in device) ||\n      device.deviceType.startsWith('com.apple.CoreSimulator.SimDeviceType.');\n    if (isSimulator) {\n      return await Simulator.ensureSimulatorOpenAsync({ udid: device.udid });\n    }\n    return device;\n  }\n  const searchValue = device.toLowerCase();\n  const resolved = devices.find(device => {\n    return device.udid.toLowerCase() === searchValue || device.name.toLowerCase() === searchValue;\n  });\n\n  if (!resolved) {\n    throw new CommandError(`No device UDID or name matching \"${device}\"`);\n  }\n\n  const isSimulator =\n    !('deviceType' in resolved) ||\n    resolved.deviceType.startsWith('com.apple.CoreSimulator.SimDeviceType.');\n  if (isSimulator) {\n    return await Simulator.ensureSimulatorOpenAsync({ udid: resolved.udid });\n  }\n\n  return resolved;\n}\n"],"file":"resolveDeviceAsync.js"}