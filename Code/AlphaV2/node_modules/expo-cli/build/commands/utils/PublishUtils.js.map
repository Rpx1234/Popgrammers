{"version":3,"sources":["../../../src/commands/utils/PublishUtils.ts"],"names":["VERSION","getPublishHistoryAsync","projectRoot","options","count","isNaN","Error","user","UserManager","ensureLoggedInAsync","exp","skipSDKVersionRequirement","api","ApiV2","clientForUser","postAsync","owner","getProjectOwner","slug","version","releaseChannel","platform","sdkVersion","runtimeVersion","setPublishToChannelAsync","publishId","_rollbackPublicationFromChannelForPlatformAsync","historyQueryResult","history","queryResult","length","secondMostRecent","nonInteractiveOptions","parent","_printAndConfirm","publicationId","revertProgress","start","succeed","rollbackPublicationFromChannelAsync","restOfTheOptions","platforms","completedPlatforms","push","e","Log","error","filter","includes","channel","partialOptions","detailOptions","detail","getPublicationDetailAsync","printPublicationDetailAsync","nonInteractive","confirm","message","result","raw","log","JSON","stringify","manifest","generalTableString","table","printTableJson","manifestTableString"],"mappings":"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","sourcesContent":["import { getConfig } from '@expo/config';\nimport { ApiV2, UserManager } from 'xdl';\n\nimport Log from '../../log';\nimport { ora } from '../../utils/ora';\nimport { confirmAsync } from '../../utils/prompts';\nimport * as table from './cli-table';\n\nexport type HistoryOptions = {\n  releaseChannel?: string;\n  count?: number;\n  platform?: 'android' | 'ios';\n  raw?: boolean;\n  sdkVersion?: string;\n  runtimeVersion?: string;\n};\n\nexport type DetailOptions = {\n  publishId?: string;\n  raw?: boolean;\n};\n\nexport type SetOptions = { releaseChannel: string; publishId: string };\n\nexport type RollbackOptions = {\n  releaseChannel: string;\n  sdkVersion: string;\n  runtimeVersion?: string;\n  platform?: 'android' | 'ios';\n  parent?: { nonInteractive?: boolean };\n};\n\nexport type Publication = {\n  fullName: string;\n  channel: string;\n  channelId: string;\n  publicationId: string;\n  appVersion: string;\n  sdkVersion: string;\n  runtimeVersion?: string;\n  publishedTime: string;\n  platform: 'android' | 'ios';\n};\n\nexport type PublicationDetail = {\n  manifest?: {\n    [key: string]: string;\n  };\n  publishedTime: string;\n  publishingUsername: string;\n  packageUsername: string;\n  packageName: string;\n  fullName: string;\n  hash: string;\n  sdkVersion: string;\n  runtimeVersion?: string;\n  s3Key: string;\n  s3Url: string;\n  abiVersion: string | null;\n  bundleUrl: string | null;\n  platform: string;\n  version: string;\n  revisionId: string;\n  channels: { [key: string]: string }[];\n  publicationId: string;\n};\n\nconst VERSION = 2;\n\nexport async function getPublishHistoryAsync(\n  projectRoot: string,\n  options: HistoryOptions\n): Promise<any> {\n  if (options.count && (isNaN(options.count) || options.count < 1 || options.count > 100)) {\n    throw new Error('-n must be a number between 1 and 100 inclusive');\n  }\n\n  // TODO(ville): handle the API result for not authenticated user instead of checking upfront\n  const user = await UserManager.ensureLoggedInAsync();\n  const { exp } = getConfig(projectRoot, {\n    skipSDKVersionRequirement: true,\n  });\n\n  const api = ApiV2.clientForUser(user);\n  return await api.postAsync('publish/history', {\n    owner: UserManager.getProjectOwner(user, exp),\n    slug: exp.slug,\n    version: VERSION,\n    releaseChannel: options.releaseChannel,\n    count: options.count,\n    platform: options.platform,\n    sdkVersion: options.sdkVersion,\n    runtimeVersion: options.runtimeVersion,\n  });\n}\n\nexport async function setPublishToChannelAsync(\n  projectRoot: string,\n  options: SetOptions\n): Promise<any> {\n  const user = await UserManager.ensureLoggedInAsync();\n  const api = ApiV2.clientForUser(user);\n  const exp = getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp;\n  return await api.postAsync('publish/set', {\n    releaseChannel: options.releaseChannel,\n    publishId: options.publishId,\n    slug: exp.slug,\n  });\n}\n\nasync function _rollbackPublicationFromChannelForPlatformAsync(\n  projectRoot: string,\n  platform: 'android' | 'ios',\n  options: Omit<RollbackOptions, 'platform'>\n) {\n  const { releaseChannel, sdkVersion, runtimeVersion } = options;\n  // get the 2 most recent things in the channel history\n  const historyQueryResult = await getPublishHistoryAsync(projectRoot, {\n    releaseChannel,\n    platform,\n    sdkVersion,\n    runtimeVersion,\n    count: 2,\n  });\n\n  const history = historyQueryResult.queryResult as Publication[];\n  if (history.length === 0) {\n    throw new Error(\n      `There isn't anything published for release channel: ${releaseChannel}, sdk version: ${sdkVersion}, platform: ${platform}`\n    );\n  } else if (history.length === 1) {\n    throw new Error(\n      `There is only 1 publication for release channel: ${releaseChannel}, sdk version: ${sdkVersion}, platform: ${platform}. There won't be anything for users to receive if we rollback.`\n    );\n  }\n\n  // The second most recent publication in the history\n  const secondMostRecent = history[history.length - 1];\n\n  const nonInteractiveOptions = options.parent ? { parent: options.parent } : {};\n  // confirm that users will be receiving the secondMostRecent item in the Publish history\n  await _printAndConfirm(\n    projectRoot,\n    secondMostRecent.publicationId,\n    releaseChannel,\n    platform,\n    nonInteractiveOptions\n  );\n\n  // apply the revert publication to channel\n  const revertProgress = ora(\n    `${platform}: Applying a revert publication to channel ${releaseChannel}`\n  ).start();\n  await setPublishToChannelAsync(projectRoot, {\n    releaseChannel,\n    publishId: secondMostRecent.publicationId,\n  });\n  revertProgress.succeed(\n    `${platform}: Successfully applied revert publication. You can view it with \\`publish:history\\``\n  );\n}\n\nexport async function rollbackPublicationFromChannelAsync(\n  projectRoot: string,\n  options: RollbackOptions\n) {\n  const { platform, ...restOfTheOptions } = options;\n\n  if (platform) {\n    return await _rollbackPublicationFromChannelForPlatformAsync(\n      projectRoot,\n      platform,\n      restOfTheOptions\n    );\n  }\n\n  const platforms = ['android', 'ios'] as ('android' | 'ios')[];\n  const completedPlatforms = [] as ('android' | 'ios')[];\n  try {\n    for (const platform of platforms) {\n      await _rollbackPublicationFromChannelForPlatformAsync(\n        projectRoot,\n        platform,\n        restOfTheOptions\n      );\n      completedPlatforms.push(platform);\n    }\n  } catch (e) {\n    if (completedPlatforms.length > 0) {\n      Log.error(\n        `The platforms ${platforms.filter(\n          platform => !completedPlatforms.includes(platform)\n        )} have not been rolled back. You can complete the missing platforms by running \\`expo publish:rollback\\` with the --platform flag`\n      );\n    }\n    throw e;\n  }\n}\n\nasync function _printAndConfirm(\n  projectRoot: string,\n  publicationId: string,\n  channel: string,\n  platform: string,\n  partialOptions: { parent?: { nonInteractive?: boolean } }\n): Promise<void> {\n  const detailOptions = {\n    publishId: publicationId,\n  };\n  const detail = await getPublicationDetailAsync(projectRoot, detailOptions);\n  await printPublicationDetailAsync(detail, detailOptions);\n\n  if (partialOptions.parent && partialOptions.parent.nonInteractive) {\n    return;\n  }\n  const confirm = await confirmAsync({\n    message: `${platform}: Users on the '${channel}' channel will receive the above publication as a result of the rollback.`,\n  });\n\n  if (!confirm) {\n    throw new Error(`You can run 'publish:set' to send the desired publication to users`);\n  }\n}\n\nexport async function getPublicationDetailAsync(\n  projectRoot: string,\n  options: DetailOptions\n): Promise<PublicationDetail> {\n  // TODO(ville): handle the API result for not authenticated user instead of checking upfront\n  const user = await UserManager.ensureLoggedInAsync();\n  const { exp } = getConfig(projectRoot, {\n    skipSDKVersionRequirement: true,\n  });\n\n  const api = ApiV2.clientForUser(user);\n  const result = await api.postAsync('publish/details', {\n    owner: UserManager.getProjectOwner(user, exp),\n    publishId: options.publishId,\n    slug: exp.slug,\n  });\n\n  if (!result.queryResult) {\n    throw new Error('No records found matching your query.');\n  }\n\n  return result.queryResult;\n}\n\nexport async function printPublicationDetailAsync(\n  detail: PublicationDetail,\n  options: DetailOptions\n) {\n  if (options.raw) {\n    Log.log(JSON.stringify(detail));\n    return;\n  }\n\n  const manifest = detail.manifest;\n  delete detail.manifest;\n\n  // Print general release info\n  const generalTableString = table.printTableJson(detail, 'Release Description');\n  Log.log(generalTableString);\n\n  if (manifest) {\n    // Print manifest info\n    const manifestTableString = table.printTableJson(manifest, 'Manifest Details');\n    Log.log(manifestTableString);\n  }\n}\n"],"file":"PublishUtils.js"}