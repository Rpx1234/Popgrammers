{"version":3,"sources":["../../../src/commands/utils/autoAddConfigPluginsAsync.ts"],"names":["packageHasConfigPlugin","projectRoot","packageName","info","isPluginFile","plugin","getNamedPlugins","plugins","namedPlugins","normal","push","autoPlugins","autoAddConfigPluginsAsync","exp","packages","Log","debug","currentPlugins","normalized","join","filter","pkg","includes","length"],"mappings":";;;;;;;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAIA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASA,sBAAT,CAAgCC,WAAhC,EAAqDC,WAArD,EAA0E;AACxE,MAAI;AACF,UAAMC,IAAI,GAAG,2DAAoCF,WAApC,EAAiDC,WAAjD,CAAb;;AACA,QAAIC,IAAI,CAACC,YAAT,EAAuB;AACrB,aAAOD,IAAI,CAACE,MAAZ;AACD;AACF,GALD,CAKE,MAAM,CAAE;;AACV,SAAO,KAAP;AACD;;AAEM,SAASC,eAAT,CAAyBC,OAAzB,EAAgF;AACrF,QAAMC,YAAY,GAAG,EAArB;;AACA,OAAK,MAAMH,MAAX,IAAqBE,OAArB,EAA8B;AAC5B,QAAI;AACF;AACA,YAAM,CAACE,MAAD,IAAW,6CAAsBJ,MAAtB,CAAjB;;AACA,UAAI,OAAOI,MAAP,KAAkB,QAAtB,EAAgC;AAC9BD,QAAAA,YAAY,CAACE,IAAb,CAAkBD,MAAlB;AACD;AACF,KAND,CAME,MAAM,CACN;AACD;AACF;;AACD,SAAOD,YAAP;AACD;;AAED,MAAMG,WAAW,GAAG,uCAApB;;AAEO,eAAeC,yBAAf,CACLX,WADK,EAELY,GAFK,EAGLC,QAHK,EAIL;AACAC,iBAAIC,KAAJ,CAAU,4BAAV;;AAEA,QAAMC,cAAc,GAAGJ,GAAG,CAACN,OAAJ,IAAe,EAAtC;AACA,QAAMW,UAAU,GAAGZ,eAAe,CAACW,cAAD,CAAlC;;AAEAF,iBAAIC,KAAJ,CAAW,qBAAoBE,UAAU,CAACC,IAAX,CAAgB,IAAhB,CAAsB,EAArD;;AAEA,QAAMZ,OAAO,GAAGO,QAAQ,CAACM,MAAT,CAAgBC,GAAG,IAAI;AACrC,QAAIH,UAAU,CAACI,QAAX,CAAoBD,GAApB,CAAJ,EAA8B;AAC5B;AACA,aAAO,KAAP;AACD,KAJoC,CAKrC;;;AACA,UAAMhB,MAAM,GAAGL,sBAAsB,CAACC,WAAD,EAAcoB,GAAd,CAArC;;AAEAN,mBAAIC,KAAJ,CACG,YAAWK,GAAI,iBAAgB,CAAC,CAAChB,MAAO,EAAzC,IAA8CA,MAAM,GAAI,WAAUA,MAAM,CAACkB,MAAO,GAA5B,GAAiC,EAArF,CADF;;AAIA,QAAIZ,WAAW,CAACW,QAAZ,CAAqBD,GAArB,CAAJ,EAA+B;AAC7BN,qBAAIC,KAAJ,CAAW,YAAWK,GAAI,kCAA1B;;AACA,aAAO,KAAP;AACD;;AAED,WAAO,CAAC,CAAChB,MAAT;AACD,GAlBe,CAAhB;AAoBA,QAAM,oDAA0BJ,WAA1B,EAAuCY,GAAvC,EAA4CN,OAA5C,CAAN;AACD","sourcesContent":["import { ExpoConfig } from '@expo/config';\nimport {\n  normalizeStaticPlugin,\n  resolveConfigPluginFunctionWithInfo,\n} from '@expo/config-plugins/build/utils/plugin-resolver';\nimport { getAutoPlugins } from '@expo/prebuild-config';\n\nimport Log from '../../log';\nimport { attemptAddingPluginsAsync } from './modifyConfigAsync';\n\n/**\n * Resolve if a package has a config plugin.\n * For sanity, we'll only support config plugins that use the `app.config.js` entry file,\n * this is because a package like `lodash` could be a \"valid\" config plugin and break the prebuild process.\n *\n * @param projectRoot\n * @param packageName\n * @returns\n */\nfunction packageHasConfigPlugin(projectRoot: string, packageName: string) {\n  try {\n    const info = resolveConfigPluginFunctionWithInfo(projectRoot, packageName);\n    if (info.isPluginFile) {\n      return info.plugin;\n    }\n  } catch {}\n  return false;\n}\n\nexport function getNamedPlugins(plugins: NonNullable<ExpoConfig['plugins']>): string[] {\n  const namedPlugins = [];\n  for (const plugin of plugins) {\n    try {\n      // @ts-ignore\n      const [normal] = normalizeStaticPlugin(plugin);\n      if (typeof normal === 'string') {\n        namedPlugins.push(normal);\n      }\n    } catch {\n      // ignore assertions\n    }\n  }\n  return namedPlugins;\n}\n\nconst autoPlugins = getAutoPlugins();\n\nexport async function autoAddConfigPluginsAsync(\n  projectRoot: string,\n  exp: Pick<ExpoConfig, 'plugins'>,\n  packages: string[]\n) {\n  Log.debug('Checking config plugins...');\n\n  const currentPlugins = exp.plugins || [];\n  const normalized = getNamedPlugins(currentPlugins);\n\n  Log.debug(`Existing plugins: ${normalized.join(', ')}`);\n\n  const plugins = packages.filter(pkg => {\n    if (normalized.includes(pkg)) {\n      // already included in plugins array\n      return false;\n    }\n    // Check if the package has a valid plugin. Must be a well-made plugin for it to work with this.\n    const plugin = packageHasConfigPlugin(projectRoot, pkg);\n\n    Log.debug(\n      `Package \"${pkg}\" has plugin: ${!!plugin}` + (plugin ? ` (args: ${plugin.length})` : '')\n    );\n\n    if (autoPlugins.includes(pkg)) {\n      Log.debug(`Package \"${pkg}\" is an auto plugin, skipping...`);\n      return false;\n    }\n\n    return !!plugin;\n  });\n\n  await attemptAddingPluginsAsync(projectRoot, exp, plugins);\n}\n"],"file":"autoAddConfigPluginsAsync.js"}