{"version":3,"sources":["../../../src/commands/utils/validateDependenciesVersions.ts"],"names":["validateDependenciesVersionsAsync","projectRoot","exp","pkg","fixDependencies","Versions","gteSdkVersion","bundledNativeModules","sdkVersion","Log","warn","chalk","bold","packagesToCheck","getPackagesToCheck","dependencies","packageVersions","resolvePackageVersionsAsync","incorrectDeps","findIncorrectDependencies","length","forEach","packageName","expectedVersionOrRange","actualVersion","underline","map","dep","inverse","dependencyNames","Object","keys","result","dependencyName","push","packages","packageVersionsFromPackageJSON","Promise","all","getPackageVersionAsync","reduce","acc","idx","packageJsonPath","error","code","message","match","CommandError","packageJson","JsonFile","readAsync","version","semver","intersects"],"mappings":"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","sourcesContent":["import { ExpoConfig, PackageJSONConfig } from '@expo/config';\nimport JsonFile from '@expo/json-file';\nimport assert from 'assert';\nimport chalk from 'chalk';\nimport resolveFrom from 'resolve-from';\nimport semver from 'semver';\nimport { Versions } from 'xdl';\n\nimport CommandError from '../../CommandError';\nimport Log from '../../log';\nimport { actionAsync } from '../installAsync';\nimport { BundledNativeModules, getBundledNativeModulesAsync } from './bundledNativeModules';\n\nexport async function validateDependenciesVersionsAsync(\n  projectRoot: string,\n  exp: Pick<ExpoConfig, 'sdkVersion'>,\n  pkg: PackageJSONConfig,\n  fixDependencies: boolean = false\n): Promise<boolean> {\n  // expo package for SDK < 33.0.0 does not have bundledNativeModules.json\n  if (!Versions.gteSdkVersion(exp, '33.0.0')) {\n    return false;\n  }\n\n  let bundledNativeModules: BundledNativeModules | null = null;\n  try {\n    assert(exp.sdkVersion);\n    bundledNativeModules = await getBundledNativeModulesAsync(\n      projectRoot,\n      // sdkVersion is defined here because we ran the >= 33.0.0 check before\n      exp.sdkVersion\n    );\n  } catch {\n    Log.warn(\n      `Your project uses Expo SDK version >= 33.0.0, but the ${chalk.bold(\n        'expo'\n      )} package version seems to be older.`\n    );\n    return false;\n  }\n\n  // intersection of packages from package.json and bundled native modules\n  const packagesToCheck = getPackagesToCheck(pkg.dependencies, bundledNativeModules);\n  // read package versions from the file system (node_modules)\n  const packageVersions = await resolvePackageVersionsAsync(projectRoot, packagesToCheck);\n  // find incorrect dependencies by comparing the actual package versions with the bundled native module version ranges\n  const incorrectDeps = findIncorrectDependencies(packageVersions, bundledNativeModules);\n\n  if (incorrectDeps.length > 0) {\n    Log.warn('Some dependencies are incompatible with the installed expo package version:');\n    incorrectDeps.forEach(({ packageName, expectedVersionOrRange, actualVersion }) => {\n      Log.warn(\n        ` - ${chalk.underline(packageName)} - expected version: ${chalk.underline(\n          expectedVersionOrRange\n        )} - actual version installed: ${chalk.underline(actualVersion)}`\n      );\n    });\n    if (fixDependencies) {\n      await actionAsync(\n        incorrectDeps.map(dep => dep.packageName),\n        {}\n      );\n    } else {\n      Log.warn(\n        'Your project may not work correctly until you install the correct versions of the packages.\\n' +\n          `To install the correct versions of these packages, please run: ${chalk.inverse(\n            'expo doctor --fix-dependencies'\n          )},\\n` +\n          `or install individual packages by running ${chalk.inverse(\n            'expo install [package-name ...]'\n          )}`\n      );\n    }\n\n    return false;\n  }\n  return true;\n}\n\nfunction getPackagesToCheck(\n  dependencies: Record<string, string> | null | undefined,\n  bundledNativeModules: BundledNativeModules\n): string[] {\n  const dependencyNames = Object.keys(dependencies ?? {});\n  const result: string[] = [];\n  for (const dependencyName of dependencyNames) {\n    if (dependencyName in bundledNativeModules) {\n      result.push(dependencyName);\n    }\n  }\n  return result;\n}\n\nasync function resolvePackageVersionsAsync(\n  projectRoot: string,\n  packages: string[]\n): Promise<Record<string, string>> {\n  const packageVersionsFromPackageJSON = await Promise.all(\n    packages.map(packageName => getPackageVersionAsync(projectRoot, packageName))\n  );\n  return packages.reduce((acc, packageName, idx) => {\n    acc[packageName] = packageVersionsFromPackageJSON[idx];\n    return acc;\n  }, {} as Record<string, string>);\n}\n\nasync function getPackageVersionAsync(projectRoot: string, packageName: string): Promise<string> {\n  let packageJsonPath: string | undefined;\n  try {\n    packageJsonPath = resolveFrom(projectRoot, `${packageName}/package.json`);\n  } catch (error: any) {\n    // This is a workaround for packages using `exports`. If this doesn't\n    // include `package.json`, we have to use the error message to get the location.\n    if (error.code === 'ERR_PACKAGE_PATH_NOT_EXPORTED') {\n      packageJsonPath = error.message.match(/(\"exports\"|defined) in (.*)$/i)?.[2];\n    }\n  }\n  if (!packageJsonPath) {\n    throw new CommandError(\n      `\"${packageName}\" is added as a dependency in your project's package.json but it doesn't seem to be installed. Please run \"yarn\" or \"npm install\" to fix this issue.`\n    );\n  }\n  const packageJson = await JsonFile.readAsync<BundledNativeModules>(packageJsonPath);\n  return packageJson.version;\n}\n\ninterface IncorrectDependency {\n  packageName: string;\n  expectedVersionOrRange: string;\n  actualVersion: string;\n}\n\nfunction findIncorrectDependencies(\n  packageVersions: Record<string, string>,\n  bundledNativeModules: BundledNativeModules\n): IncorrectDependency[] {\n  const packages = Object.keys(packageVersions);\n  const incorrectDeps: IncorrectDependency[] = [];\n  for (const packageName of packages) {\n    const expectedVersionOrRange = bundledNativeModules[packageName];\n    const actualVersion = packageVersions[packageName];\n    if (\n      typeof expectedVersionOrRange === 'string' &&\n      !semver.intersects(expectedVersionOrRange, actualVersion)\n    ) {\n      incorrectDeps.push({\n        packageName,\n        expectedVersionOrRange,\n        actualVersion,\n      });\n    }\n  }\n  return incorrectDeps;\n}\n"],"file":"validateDependenciesVersions.js"}