{"version":3,"sources":["../../../../src/commands/utils/typescript/ensureTypeScriptSetup.ts"],"names":["ensureTypeScriptSetupAsync","projectRoot","isTypeScriptSetupDisabled","Log","log","chalk","dim","tsConfigPath","path","join","intent","shouldSetupTypeScriptAsync","ensureRequiredDependenciesAsync","program","nonInteractive","isBootstrapping","content","fs","readFile","encoding","then","txt","trim","isBlankConfig","typescriptFile","queryFirstProjectTypeScriptFileAsync","getSDKVersionsAsync","exp","skipSDKVersionRequirement","sdkVersion","sdkVersions","Versions","releasedSdkVersionsAsync","skipPrompt","resolutions","missing","length","typescript","versions","relatedPackages","pkg","version","readableMissingPackages","map","p","isYarn","PackageManager","isUsingYarn","title","message","cyan","process","stdout","columns","initial","installPackagesAsync","devPackages","col","installCommand","disableMessage","solution","bold","reset","CommandError","packageManager","createForProject","yarn","silent","isDebug","packagesStr","newLine","installingPackageStep","addDevAsync","e","fail","succeed"],"mappings":";;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAKA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;;;AAEO,eAAeA,0BAAf,CAA0CC,WAA1C,EAA8E;AACnF,MAAIC,2CAAJ,EAA+B;AAC7BC,mBAAIC,GAAJ,CAAQC,iBAAMC,GAAN,CAAU,yCAAV,CAAR;;AACA;AACD;;AAED,QAAMC,YAAY,GAAGC,IAAI,GAACC,IAAL,CAAUR,WAAV,EAAuB,eAAvB,CAArB,CANmF,CAQnF;;AACA,QAAMS,MAAM,GAAG,MAAMC,0BAA0B,CAACV,WAAD,CAA/C;;AACA,MAAI,CAACS,MAAL,EAAa;AACX;AACD,GAZkF,CAcnF;;;AACA,QAAME,+BAA+B,CACnCX,WADmC,EAEnC;AACAY,uBAAQC,cAH2B,CAArC,CAfmF,CAqBnF;;AACA,QAAM,2CAAoB;AAAEb,IAAAA,WAAF;AAAeM,IAAAA,YAAf;AAA6BQ,IAAAA,eAAe,EAAEL,MAAM,CAACK;AAArD,GAApB,CAAN;AACD;;AAEM,eAAeJ,0BAAf,CACLV,WADK,EAEyC;AAC9C,QAAMM,YAAY,GAAG,MAAM,mCAAYN,WAAZ,CAA3B,CAD8C,CAG9C;;AACA,MAAIM,YAAJ,EAAkB;AAChB,UAAMS,OAAO,GAAG,MAAMC,EAAE,GAACC,QAAH,CAAYX,YAAZ,EAA0B;AAAEY,MAAAA,QAAQ,EAAE;AAAZ,KAA1B,EAAgDC,IAAhD,CACpBC,GAAG,IAAIA,GAAG,CAACC,IAAJ,EADa,EAEpB,MAAM,IAFc,CAAtB;AAIA,UAAMC,aAAa,GAAGP,OAAO,KAAK,EAAZ,IAAkBA,OAAO,KAAK,IAApD;AACA,WAAO;AAAED,MAAAA,eAAe,EAAEQ;AAAnB,KAAP;AACD,GAX6C,CAY9C;AACA;;;AACA,QAAMC,cAAc,GAAG,MAAM,oCAAcC,sDAAd,EAAoDxB,WAApD,CAA7B;;AACA,MAAIuB,cAAJ,EAAoB;AAClB,WAAO;AAAET,MAAAA,eAAe,EAAE;AAAnB,KAAP;AACD;;AAED,SAAO,IAAP;AACD;;AAED,eAAeW,mBAAf,CAAmCzB,WAAnC,EAA6F;AAC3F,MAAI;AACF,UAAM;AAAE0B,MAAAA;AAAF,QAAU,yBAAU1B,WAAV,EAAuB;AAAE2B,MAAAA,yBAAyB,EAAE;AAA7B,KAAvB,CAAhB;;AACA,QAAID,GAAG,CAACE,UAAR,EAAoB;AAAA;;AAClB,YAAMC,WAAW,GAAG,MAAMC,gBAASC,wBAAT,EAA1B;AACA,sCAAOF,WAAW,CAACH,GAAG,CAACE,UAAL,CAAlB,yEAAsC,IAAtC;AACD;AACF,GAND,CAME,MAAM,CACN;AACD;;AACD,SAAO,IAAP;AACD;;AAED,eAAejB,+BAAf,CACEX,WADF,EAEEgC,UAAmB,GAAG,KAFxB,EAGmB;AACjB,QAAM;AAAEC,IAAAA,WAAF;AAAeC,IAAAA;AAAf,MAA2B,8CAAuBlC,WAAvB,CAAjC;;AACA,MAAI,CAACkC,OAAO,CAACC,MAAb,EAAqB;AACnB,WAAOF,WAAW,CAACG,UAAnB;AACD,GAJgB,CAMjB;;;AACA,QAAMC,QAAQ,GAAG,MAAMZ,mBAAmB,CAACzB,WAAD,CAA1C;;AACA,MAAIqC,QAAJ,aAAIA,QAAJ,eAAIA,QAAQ,CAAEC,eAAd,EAA+B;AAC7B,SAAK,MAAMC,GAAX,IAAkBL,OAAlB,EAA2B;AACzB,UAAIK,GAAG,CAACA,GAAJ,IAAWF,QAAQ,CAACC,eAAxB,EAAyC;AACvCC,QAAAA,GAAG,CAACC,OAAJ,GAAcH,QAAQ,CAACC,eAAT,CAAyBC,GAAG,CAACA,GAA7B,CAAd;AACD;AACF;AACF,GAdgB,CAgBjB;;;AACA,QAAME,uBAAuB,GAAGP,OAAO,CAACQ,GAAR,CAAYC,CAAC,IAAIA,CAAC,CAACJ,GAAnB,EAAwB/B,IAAxB,CAA6B,IAA7B,CAAhC;AAEA,QAAMoC,MAAM,GAAGC,cAAc,GAACC,WAAf,CAA2B9C,WAA3B,CAAf;AAEA,MAAI+C,KAAK,GAAI,mGAAb;;AAEA,MAAI,CAACf,UAAL,EAAiB;AACf,QACE,MAAM,6BAAa;AACjBgB,MAAAA,OAAO,EAAE,yBACPD,KAAK,GAAI,8BAA6B3C,iBAAM6C,IAAN,CAAWR,uBAAX,CAAoC,GADnE,EAEP;AACAS,MAAAA,OAAO,CAACC,MAAR,CAAeC,OAAf,IAA0B,EAHnB,CADQ;AAMjBC,MAAAA,OAAO,EAAE;AANQ,KAAb,CADR,EASE;AACA,YAAMC,oBAAoB,CAACtD,WAAD,EAAc;AACtC4C,QAAAA,MADsC;AAEtCW,QAAAA,WAAW,EAAErB,OAAO,CAACQ,GAAR,CAAY,CAAC;AAAEH,UAAAA,GAAF;AAAOC,UAAAA;AAAP,SAAD,KAAsB;AAC7C,cAAIA,OAAJ,EAAa;AACX,mBAAO,CAACD,GAAD,EAAMC,OAAN,EAAehC,IAAf,CAAoB,GAApB,CAAP;AACD;;AACD,iBAAO+B,GAAP;AACD,SALY;AAFyB,OAAd,CAA1B,CADA,CAUA;;AACA,aAAO,MAAM5B,+BAA+B,CAACX,WAAD,EAAc,IAAd,CAA5C;AACD,KAtBc,CAwBf;;;AACA+C,IAAAA,KAAK,GAAG,EAAR;AACD,GA1BD,MA0BO;AACLA,IAAAA,KAAK,IAAI,MAAT;AACD;;AAED,QAAMS,GAAG,GAAGN,OAAO,CAACC,MAAR,CAAeC,OAAf,IAA0B,EAAtC;AAEA,QAAMK,cAAc,GAClB,CAACb,MAAM,GAAG,gBAAH,GAAsB,wBAA7B,IACA,GADA,GAEAV,OAAO,CACJQ,GADH,CACO,CAAC;AAAEH,IAAAA,GAAF;AAAOC,IAAAA;AAAP,GAAD,KAAsB;AACzB,QAAIA,OAAJ,EAAa;AACX,aAAO,CAACD,GAAD,EAAMC,OAAN,EAAehC,IAAf,CAAoB,GAApB,CAAP;AACD;;AACD,WAAO+B,GAAP;AACD,GANH,EAOG/B,IAPH,CAOQ,GAPR,CAHF;AAYA,MAAIkD,cAAc,GAChB,sFADF;;AAGA,MAAI,MAAM,mCAAY1D,WAAZ,CAAV,EAAoC;AAClC0D,IAAAA,cAAc,IAAK,gCAAnB;AACD,GAFD,MAEO;AACLA,IAAAA,cAAc,IAAI,GAAlB;AACD;;AAED,QAAMC,QAAQ,GAAI,kBAAiBvD,iBAAMwD,IAAN,CACjCnB,uBADiC,CAEjC,qBAAoBrC,iBAAMyD,KAAN,CAAYD,IAAZ,CAAiBH,cAAjB,CAAiC,MAFvD,CA5EiB,CAgFjB;;AACA,QAAM,KAAIK,uBAAJ,EAAiB,yBAASf,KAAK,GAAGY,QAAR,GAAmBD,cAAnB,GAAoC,IAA7C,EAAmDF,GAAnD,CAAjB,CAAN;AACD;;AAED,eAAeF,oBAAf,CACEtD,WADF,EAEE;AAAE4C,EAAAA,MAAF;AAAUW,EAAAA;AAAV,CAFF,EAGE;AACA,QAAMQ,cAAc,GAAGlB,cAAc,GAACmB,gBAAf,CAAgChE,WAAhC,EAA6C;AAClEiE,IAAAA,IAAI,EAAErB,MAD4D;AAElEzC,IAAAA,GAAG,EAAED,eAAIC,GAFyD;AAGlE+D,IAAAA,MAAM,EAAE,CAAChE,eAAIiE;AAHqD,GAA7C,CAAvB;;AAMA,QAAMC,WAAW,GAAGhE,iBAAMwD,IAAN,CAAWL,WAAW,CAAC/C,IAAZ,CAAiB,IAAjB,CAAX,CAApB;;AACAN,iBAAImE,OAAJ;;AACA,QAAMC,qBAAqB,GAAG,0BAAe,cAAaF,WAAY,EAAxC,CAA9B;;AACA,MAAI;AACF,UAAML,cAAc,CAACQ,WAAf,CAA2B,GAAGhB,WAA9B,CAAN;AACD,GAFD,CAEE,OAAOiB,CAAP,EAAU;AACVF,IAAAA,qBAAqB,CAACG,IAAtB,CAA4B,qBAAoBL,WAAY,gBAAeI,CAAC,CAACxB,OAAQ,EAArF;AACA,UAAMwB,CAAN;AACD;;AACDF,EAAAA,qBAAqB,CAACI,OAAtB,CAA+B,aAAYN,WAAY,EAAvD;AACD","sourcesContent":["import { getConfig } from '@expo/config';\nimport * as PackageManager from '@expo/package-manager';\nimport chalk from 'chalk';\nimport program from 'commander';\nimport * as fs from 'fs-extra';\nimport * as path from 'path';\nimport wrapAnsi from 'wrap-ansi';\nimport { Versions } from 'xdl';\n\nimport CommandError from '../../../CommandError';\nimport Log from '../../../log';\nimport { logNewSection } from '../../../utils/ora';\nimport { confirmAsync } from '../../../utils/prompts';\nimport { profileMethod } from '../profileMethod';\nimport {\n  collectMissingPackages,\n  hasTSConfig,\n  queryFirstProjectTypeScriptFileAsync,\n} from './resolveModules';\nimport { isTypeScriptSetupDisabled, updateTSConfigAsync } from './updateTSConfig';\n\nexport async function ensureTypeScriptSetupAsync(projectRoot: string): Promise<void> {\n  if (isTypeScriptSetupDisabled) {\n    Log.log(chalk.dim('\\u203A Skipping TypeScript verification'));\n    return;\n  }\n\n  const tsConfigPath = path.join(projectRoot, 'tsconfig.json');\n\n  // Ensure the project is TypeScript before continuing.\n  const intent = await shouldSetupTypeScriptAsync(projectRoot);\n  if (!intent) {\n    return;\n  }\n\n  // Ensure TypeScript packages are installed\n  await ensureRequiredDependenciesAsync(\n    projectRoot,\n    // Don't prompt in CI\n    program.nonInteractive\n  );\n\n  // Update the config\n  await updateTSConfigAsync({ projectRoot, tsConfigPath, isBootstrapping: intent.isBootstrapping });\n}\n\nexport async function shouldSetupTypeScriptAsync(\n  projectRoot: string\n): Promise<{ isBootstrapping: boolean } | null> {\n  const tsConfigPath = await hasTSConfig(projectRoot);\n\n  // Enable TS setup if the project has a `tsconfig.json`\n  if (tsConfigPath) {\n    const content = await fs.readFile(tsConfigPath, { encoding: 'utf8' }).then(\n      txt => txt.trim(),\n      () => null\n    );\n    const isBlankConfig = content === '' || content === '{}';\n    return { isBootstrapping: isBlankConfig };\n  }\n  // This is a somewhat heavy check in larger projects.\n  // Test that this is reasonably paced by running expo start in `expo/apps/native-component-list`\n  const typescriptFile = await profileMethod(queryFirstProjectTypeScriptFileAsync)(projectRoot);\n  if (typescriptFile) {\n    return { isBootstrapping: true };\n  }\n\n  return null;\n}\n\nasync function getSDKVersionsAsync(projectRoot: string): Promise<Versions.SDKVersion | null> {\n  try {\n    const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n    if (exp.sdkVersion) {\n      const sdkVersions = await Versions.releasedSdkVersionsAsync();\n      return sdkVersions[exp.sdkVersion] ?? null;\n    }\n  } catch {\n    // This is a convenience method and we should avoid making this halt the process.\n  }\n  return null;\n}\n\nasync function ensureRequiredDependenciesAsync(\n  projectRoot: string,\n  skipPrompt: boolean = false\n): Promise<string> {\n  const { resolutions, missing } = collectMissingPackages(projectRoot);\n  if (!missing.length) {\n    return resolutions.typescript!;\n  }\n\n  // Ensure the versions are right for the SDK that the project is currently using.\n  const versions = await getSDKVersionsAsync(projectRoot);\n  if (versions?.relatedPackages) {\n    for (const pkg of missing) {\n      if (pkg.pkg in versions.relatedPackages) {\n        pkg.version = versions.relatedPackages[pkg.pkg];\n      }\n    }\n  }\n\n  // Prompt to install or bail out...\n  const readableMissingPackages = missing.map(p => p.pkg).join(', ');\n\n  const isYarn = PackageManager.isUsingYarn(projectRoot);\n\n  let title = `It looks like you're trying to use TypeScript but don't have the required dependencies installed.`;\n\n  if (!skipPrompt) {\n    if (\n      await confirmAsync({\n        message: wrapAnsi(\n          title + ` Would you like to install ${chalk.cyan(readableMissingPackages)}?`,\n          // This message is a bit too long, so wrap it to fit smaller terminals\n          process.stdout.columns || 80\n        ),\n        initial: true,\n      })\n    ) {\n      await installPackagesAsync(projectRoot, {\n        isYarn,\n        devPackages: missing.map(({ pkg, version }) => {\n          if (version) {\n            return [pkg, version].join('@');\n          }\n          return pkg;\n        }),\n      });\n      // Try again but skip prompting twice.\n      return await ensureRequiredDependenciesAsync(projectRoot, true);\n    }\n\n    // Reset the title so it doesn't print twice in interactive mode.\n    title = '';\n  } else {\n    title += '\\n\\n';\n  }\n\n  const col = process.stdout.columns || 80;\n\n  const installCommand =\n    (isYarn ? 'yarn add --dev' : 'npm install --save-dev') +\n    ' ' +\n    missing\n      .map(({ pkg, version }) => {\n        if (version) {\n          return [pkg, version].join('@');\n        }\n        return pkg;\n      })\n      .join(' ');\n\n  let disableMessage =\n    \"If you're not using TypeScript, please remove the TypeScript files from your project\";\n\n  if (await hasTSConfig(projectRoot)) {\n    disableMessage += ` and delete the tsconfig.json.`;\n  } else {\n    disableMessage += '.';\n  }\n\n  const solution = `Please install ${chalk.bold(\n    readableMissingPackages\n  )} by running:\\n\\n  ${chalk.reset.bold(installCommand)}\\n\\n`;\n\n  // This prevents users from starting a misconfigured JS or TS project by default.\n  throw new CommandError(wrapAnsi(title + solution + disableMessage + '\\n', col));\n}\n\nasync function installPackagesAsync(\n  projectRoot: string,\n  { isYarn, devPackages }: { isYarn: boolean; devPackages: string[] }\n) {\n  const packageManager = PackageManager.createForProject(projectRoot, {\n    yarn: isYarn,\n    log: Log.log,\n    silent: !Log.isDebug,\n  });\n\n  const packagesStr = chalk.bold(devPackages.join(', '));\n  Log.newLine();\n  const installingPackageStep = logNewSection(`Installing ${packagesStr}`);\n  try {\n    await packageManager.addDevAsync(...devPackages);\n  } catch (e) {\n    installingPackageStep.fail(`Failed to install ${packagesStr} with error: ${e.message}`);\n    throw e;\n  }\n  installingPackageStep.succeed(`Installed ${packagesStr}`);\n}\n"],"file":"ensureTypeScriptSetup.js"}