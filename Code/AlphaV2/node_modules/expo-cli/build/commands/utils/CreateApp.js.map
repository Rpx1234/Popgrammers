{"version":3,"sources":["../../../src/commands/utils/CreateApp.ts"],"names":["validateName","name","test","FORBIDDEN_NAMES","isFolderNameForbidden","folderName","includes","TOLERABLE_FILES","getConflictsForDirectory","projectRoot","tolerableFiles","fs","readdirSync","filter","file","assertFolderEmptyAsync","path","dirname","overwrite","conflicts","length","Log","addNewLineIfNone","nested","chalk","green","newLine","Promise","all","map","conflict","remove","join","resolvePackageManager","options","packageManager","yarn","npm","PackageManager","shouldUseYarn","install","log","dim","EXPO_DEBUG","getenv","boolish","installNodeDependenciesAsync","flags","silent","cwd","YarnPackageManager","version","versionAsync","nodeLinker","getConfigAsync","semver","satisfies","yarnRc","yamlString","readFileSync","error","code","config","yaml","safeLoad","warn","writeFileSync","safeDump","installAsync","NpmPackageManager","getChangeDirectoryPath","cdPath","relative","process","installCocoaPodsAsync","step","platform","succeed","CocoaPodsPackageManager","isCLIInstalledAsync","text","stopAndPersist","installCLIAsync","nonInteractive","spawnOptions","stdio","e","symbol","red","CocoaPodsError","message","spinner","catch"],"mappings":";;;;;;;;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;;;AAEO,SAASA,YAAT,CAAsBC,IAAtB,EAAoD;AACzD,MAAI,OAAOA,IAAP,KAAgB,QAAhB,IAA4BA,IAAI,KAAK,EAAzC,EAA6C;AAC3C,WAAO,oCAAP;AACD;;AACD,MAAI,CAAC,oBAAoBC,IAApB,CAAyBD,IAAzB,CAAL,EAAqC;AACnC,WAAO,uFAAP;AACD;;AACD,SAAO,IAAP;AACD;;AAED,MAAME,eAAe,GAAG,CAAC,cAAD,EAAiB,OAAjB,EAA0B,WAA1B,EAAuC,kBAAvC,EAA2D,MAA3D,CAAxB;;AAEO,SAASC,qBAAT,CAA+BC,UAA/B,EAA4D;AACjE,SAAOF,eAAe,CAACG,QAAhB,CAAyBD,UAAzB,CAAP;AACD,C,CAED;;;AACA,MAAME,eAAe,GAAG,CACtB;AACA,WAFsB,EAGtB,WAHsB,EAItB;AACA,MALsB,EAMtB,gBANsB,EAOtB,YAPsB,EAQtB;AACA,YATsB,EAUtB,aAVsB,EAWtB,SAXsB,EAYtB,MAZsB,EAatB,OAbsB,EActB;AACA,eAfsB,EAgBtB,gBAhBsB,EAiBtB,gBAjBsB,CAAxB;;AAoBO,SAASC,wBAAT,CACLC,WADK,EAELC,cAAwB,GAAGH,eAFtB,EAGK;AACV,SAAOI,mBACJC,WADI,CACQH,WADR,EAEJI,MAFI,CAEIC,IAAD,IAAkB,EAAE,SAASZ,IAAT,CAAcY,IAAd,KAAuBJ,cAAc,CAACJ,QAAf,CAAwBQ,IAAxB,CAAzB,CAFrB,CAAP;AAGD;;AAEM,eAAeC,sBAAf,CAAsC;AAC3CN,EAAAA,WAD2C;AAE3CJ,EAAAA,UAAU,GAAGW,IAAI,GAACC,OAAL,CAAaR,WAAb,CAF8B;AAG3CS,EAAAA;AAH2C,CAAtC,EAQc;AACnB,QAAMC,SAAS,GAAGX,wBAAwB,CAACC,WAAD,CAA1C;;AACA,MAAIU,SAAS,CAACC,MAAd,EAAsB;AACpBC,mBAAIC,gBAAJ;;AACAD,mBAAIE,MAAJ,CAAY,iBAAgBC,iBAAMC,KAAN,CAAYpB,UAAZ,CAAwB,uCAApD;;AACAgB,mBAAIK,OAAJ;;AACA,SAAK,MAAMZ,IAAX,IAAmBK,SAAnB,EAA8B;AAC5BE,qBAAIE,MAAJ,CAAY,KAAIT,IAAK,EAArB;AACD;;AAED,QAAII,SAAJ,EAAe;AACbG,qBAAIK,OAAJ;;AACAL,qBAAIE,MAAJ,CAAY,gCAA+BC,iBAAMC,KAAN,CAAYpB,UAAZ,CAAwB,EAAnE;;AACA,YAAMsB,OAAO,CAACC,GAAR,CAAYT,SAAS,CAACU,GAAV,CAAcC,QAAQ,IAAInB,mBAAGoB,MAAH,CAAUf,IAAI,GAACgB,IAAL,CAAUvB,WAAV,EAAuBqB,QAAvB,CAAV,CAA1B,CAAZ,CAAN;AACA,aAAO,IAAP;AACD;;AAED,WAAO,KAAP;AACD;;AACD,SAAO,IAAP;AACD;;AAIM,SAASG,qBAAT,CAA+BC,OAA/B,EAIgB;AACrB,MAAIC,cAAkC,GAAG,KAAzC;;AACA,MAAID,OAAO,CAACE,IAAR,IAAiB,CAACF,OAAO,CAACG,GAAT,IAAgBC,cAAc,GAACC,aAAf,EAArC,EAAsE;AACpEJ,IAAAA,cAAc,GAAG,MAAjB;AACD,GAFD,MAEO;AACLA,IAAAA,cAAc,GAAG,KAAjB;AACD;;AACD,MAAID,OAAO,CAACM,OAAZ,EAAqB;AACnBnB,mBAAIoB,GAAJ,CACEN,cAAc,KAAK,MAAnB,GACK,sCAAqCX,iBAAMkB,GAAN,CAAU,gCAAV,CAA4C,EADtF,GAEI,mCAHN;AAKD;;AAED,SAAOP,cAAP;AACD;;AAED,MAAMQ,UAAU,GAAGC,kBAAOC,OAAP,CAAe,YAAf,EAA6B,KAA7B,CAAnB;;AAEO,eAAeC,4BAAf,CACLrC,WADK,EAEL0B,cAFK,EAGLY,KAA0B,GAAG;AAC3B;AACAC,EAAAA,MAAM,EAAE,CAACL;AAFkB,CAHxB,EAOL;AACA,QAAMT,OAAO,GAAG;AAAEe,IAAAA,GAAG,EAAExC,WAAP;AAAoBuC,IAAAA,MAAM,EAAED,KAAK,CAACC;AAAlC,GAAhB;;AACA,MAAIb,cAAc,KAAK,MAAvB,EAA+B;AAC7B,UAAMC,IAAI,GAAG,KAAIE,cAAc,GAACY,kBAAnB,EAAsChB,OAAtC,CAAb;AACA,UAAMiB,OAAO,GAAG,MAAMf,IAAI,CAACgB,YAAL,EAAtB;AACA,UAAMC,UAAU,GAAG,MAAMjB,IAAI,CAACkB,cAAL,CAAoB,YAApB,CAAzB;;AACA,QAAIC,kBAAOC,SAAP,CAAiBL,OAAjB,EAA0B,eAA1B,KAA8CE,UAAU,KAAK,cAAjE,EAAiF;AAC/E,YAAMI,MAAM,GAAGzC,IAAI,GAACgB,IAAL,CAAUvB,WAAV,EAAuB,aAAvB,CAAf;AACA,UAAIiD,UAAU,GAAG,EAAjB;;AACA,UAAI;AACFA,QAAAA,UAAU,GAAG/C,mBAAGgD,YAAH,CAAgBF,MAAhB,EAAwB,MAAxB,CAAb;AACD,OAFD,CAEE,OAAOG,KAAP,EAAc;AACd,YAAIA,KAAK,CAACC,IAAN,KAAe,QAAnB,EAA6B;AAC3B,gBAAMD,KAAN;AACD;AACF;;AACD,YAAME,MAAM,GAAGJ,UAAU,GAAGK,kBAAKC,QAAL,CAAcN,UAAd,CAAH,GAA+B,EAAxD;AACAI,MAAAA,MAAM,CAACT,UAAP,GAAoB,cAApB;AACA,OAACN,KAAK,CAACC,MAAP,IACE3B,eAAI4C,IAAJ,CACG,SAAQd,OAAQ,iFADnB,CADF;AAIA,OAACJ,KAAK,CAACC,MAAP,IAAiB3B,eAAIoB,GAAJ,CAAS,WAAUgB,MAAO,KAA1B,CAAjB;;AACA9C,yBAAGuD,aAAH,CAAiBT,MAAjB,EAAyBM,kBAAKI,QAAL,CAAcL,MAAd,CAAzB;AACD;;AACD,UAAM1B,IAAI,CAACgC,YAAL,EAAN;AACD,GAxBD,MAwBO;AACL,UAAM,KAAI9B,cAAc,GAAC+B,iBAAnB,EAAqCnC,OAArC,EAA8CkC,YAA9C,EAAN;AACD;AACF;;AAEM,SAASE,sBAAT,CAAgC7D,WAAhC,EAA6D;AAClE,QAAM8D,MAAM,GAAGvD,IAAI,GAACwD,QAAL,CAAcC,OAAO,CAACxB,GAAR,EAAd,EAA6BxC,WAA7B,CAAf;;AACA,MAAI8D,MAAM,CAACnD,MAAP,IAAiBX,WAAW,CAACW,MAAjC,EAAyC;AACvC,WAAOmD,MAAP;AACD;;AACD,SAAO9D,WAAP;AACD;;AAEM,eAAeiE,qBAAf,CAAqCjE,WAArC,EAA0D;AAC/D,MAAIkE,IAAI,GAAG,0BAAc,yBAAd,CAAX;;AACA,MAAIF,OAAO,CAACG,QAAR,KAAqB,QAAzB,EAAmC;AACjCD,IAAAA,IAAI,CAACE,OAAL,CAAa,wEAAb;AACA,WAAO,KAAP;AACD;;AAED,QAAM1C,cAAc,GAAG,KAAIG,cAAc,GAACwC,uBAAnB,EAA2C;AAChE7B,IAAAA,GAAG,EAAEjC,IAAI,GAACgB,IAAL,CAAUvB,WAAV,EAAuB,KAAvB,CAD2D;AAEhEuC,IAAAA,MAAM,EAAE,CAACL;AAFuD,GAA3C,CAAvB;;AAKA,MAAI,EAAE,MAAMR,cAAc,CAAC4C,mBAAf,EAAR,CAAJ,EAAmD;AACjD,QAAI;AACF;AACAJ,MAAAA,IAAI,CAACK,IAAL,GAAY,0DAAZ;AACAL,MAAAA,IAAI,CAACM,cAAL;AACA,YAAM3C,cAAc,GAACwC,uBAAf,CAAuCI,eAAvC,CAAuD;AAC3DC,QAAAA,cAAc,EAAE,IAD2C;AAE3DC,QAAAA,YAAY,EAAE,EACZ,GAAGjD,cAAc,CAACD,OADN;AAEZ;AACAmD,UAAAA,KAAK,EAAE,CAAC,SAAD,EAAY,SAAZ,EAAuB,MAAvB;AAHK;AAF6C,OAAvD,CAAN;AAQAV,MAAAA,IAAI,CAACE,OAAL,CAAa,0BAAb;AACAF,MAAAA,IAAI,GAAG,0BAAc,+CAAd,CAAP;AACD,KAdD,CAcE,OAAOW,CAAP,EAAU;AACVX,MAAAA,IAAI,CAACM,cAAL,CAAoB;AAClBM,QAAAA,MAAM,EAAE,KADU;AAElBP,QAAAA,IAAI,EAAExD,iBAAMgE,GAAN,CAAU,sCAAV;AAFY,OAApB;;AAIA,UAAIF,CAAC,YAAYhD,cAAc,GAACmD,cAAhC,EAAgD;AAC9CpE,uBAAIoB,GAAJ,CAAQ6C,CAAC,CAACI,OAAV;AACD,OAFD,MAEO;AACLrE,uBAAIoB,GAAJ,CAAS,kBAAiB6C,CAAC,CAACI,OAAQ,EAApC;AACD;;AACD,aAAO,KAAP;AACD;AACF;;AAED,MAAI;AACF,UAAMvD,cAAc,CAACiC,YAAf,CAA4B;AAAEuB,MAAAA,OAAO,EAAEhB;AAAX,KAA5B,CAAN,CADE,CAEF;;AACA,UAAM,yDAAyClE,WAAzC,EAAsDmF,KAAtD,CAA4D,MAAM,IAAlE,CAAN;AACAjB,IAAAA,IAAI,CAACE,OAAL,CAAa,iDAAb;AACA,WAAO,IAAP;AACD,GAND,CAME,OAAOS,CAAP,EAAU;AACVX,IAAAA,IAAI,CAACM,cAAL,CAAoB;AAClBM,MAAAA,MAAM,EAAE,KADU;AAElBP,MAAAA,IAAI,EAAExD,iBAAMgE,GAAN,CAAU,oEAAV;AAFY,KAApB;;AAIA,QAAIF,CAAC,YAAYhD,cAAc,GAACmD,cAAhC,EAAgD;AAC9CpE,qBAAIoB,GAAJ,CAAQ6C,CAAC,CAACI,OAAV;AACD,KAFD,MAEO;AACLrE,qBAAIoB,GAAJ,CAAS,kBAAiB6C,CAAC,CAACI,OAAQ,EAApC;AACD;;AACD,WAAO,KAAP;AACD;AACF","sourcesContent":["import * as PackageManager from '@expo/package-manager';\nimport chalk from 'chalk';\nimport fs from 'fs-extra';\nimport getenv from 'getenv';\nimport yaml from 'js-yaml';\nimport * as path from 'path';\nimport semver from 'semver';\n\nimport Log from '../../log';\nimport { logNewSection } from '../../utils/ora';\nimport { hasPackageJsonDependencyListChangedAsync } from '../run/ios/Podfile';\n\nexport function validateName(name?: string): string | true {\n  if (typeof name !== 'string' || name === '') {\n    return 'The project name can not be empty.';\n  }\n  if (!/^[a-z0-9@.\\-_]+$/i.test(name)) {\n    return 'The project name can only contain URL-friendly characters (alphanumeric and @ . -  _)';\n  }\n  return true;\n}\n\nconst FORBIDDEN_NAMES = ['react-native', 'react', 'react-dom', 'react-native-web', 'expo'];\n\nexport function isFolderNameForbidden(folderName: string): boolean {\n  return FORBIDDEN_NAMES.includes(folderName);\n}\n\n// Any of these files are allowed to exist in the projectRoot\nconst TOLERABLE_FILES = [\n  // System\n  '.DS_Store',\n  'Thumbs.db',\n  // Git\n  '.git',\n  '.gitattributes',\n  '.gitignore',\n  // Project\n  '.npmignore',\n  '.travis.yml',\n  'LICENSE',\n  'docs',\n  '.idea',\n  // Package manager\n  'npm-debug.log',\n  'yarn-debug.log',\n  'yarn-error.log',\n];\n\nexport function getConflictsForDirectory(\n  projectRoot: string,\n  tolerableFiles: string[] = TOLERABLE_FILES\n): string[] {\n  return fs\n    .readdirSync(projectRoot)\n    .filter((file: string) => !(/\\.iml$/.test(file) || tolerableFiles.includes(file)));\n}\n\nexport async function assertFolderEmptyAsync({\n  projectRoot,\n  folderName = path.dirname(projectRoot),\n  overwrite,\n}: {\n  projectRoot: string;\n  folderName?: string;\n  overwrite: boolean;\n}): Promise<boolean> {\n  const conflicts = getConflictsForDirectory(projectRoot);\n  if (conflicts.length) {\n    Log.addNewLineIfNone();\n    Log.nested(`The directory ${chalk.green(folderName)} has files that might be overwritten:`);\n    Log.newLine();\n    for (const file of conflicts) {\n      Log.nested(`  ${file}`);\n    }\n\n    if (overwrite) {\n      Log.newLine();\n      Log.nested(`Removing existing files from ${chalk.green(folderName)}`);\n      await Promise.all(conflicts.map(conflict => fs.remove(path.join(projectRoot, conflict))));\n      return true;\n    }\n\n    return false;\n  }\n  return true;\n}\n\nexport type PackageManagerName = 'npm' | 'yarn';\n\nexport function resolvePackageManager(options: {\n  yarn?: boolean;\n  npm?: boolean;\n  install?: boolean;\n}): PackageManagerName {\n  let packageManager: PackageManagerName = 'npm';\n  if (options.yarn || (!options.npm && PackageManager.shouldUseYarn())) {\n    packageManager = 'yarn';\n  } else {\n    packageManager = 'npm';\n  }\n  if (options.install) {\n    Log.log(\n      packageManager === 'yarn'\n        ? `🧶 Using Yarn to install packages. ${chalk.dim('Pass --npm to use npm instead.')}`\n        : '📦 Using npm to install packages.'\n    );\n  }\n\n  return packageManager;\n}\n\nconst EXPO_DEBUG = getenv.boolish('EXPO_DEBUG', false);\n\nexport async function installNodeDependenciesAsync(\n  projectRoot: string,\n  packageManager: PackageManagerName,\n  flags: { silent: boolean } = {\n    // default to silent\n    silent: !EXPO_DEBUG,\n  }\n) {\n  const options = { cwd: projectRoot, silent: flags.silent };\n  if (packageManager === 'yarn') {\n    const yarn = new PackageManager.YarnPackageManager(options);\n    const version = await yarn.versionAsync();\n    const nodeLinker = await yarn.getConfigAsync('nodeLinker');\n    if (semver.satisfies(version, '>=2.0.0-rc.24') && nodeLinker !== 'node-modules') {\n      const yarnRc = path.join(projectRoot, '.yarnrc.yml');\n      let yamlString = '';\n      try {\n        yamlString = fs.readFileSync(yarnRc, 'utf8');\n      } catch (error) {\n        if (error.code !== 'ENOENT') {\n          throw error;\n        }\n      }\n      const config = yamlString ? yaml.safeLoad(yamlString) : {};\n      config.nodeLinker = 'node-modules';\n      !flags.silent &&\n        Log.warn(\n          `Yarn v${version} detected, enabling experimental Yarn v2 support using the node-modules plugin.`\n        );\n      !flags.silent && Log.log(`Writing ${yarnRc}...`);\n      fs.writeFileSync(yarnRc, yaml.safeDump(config));\n    }\n    await yarn.installAsync();\n  } else {\n    await new PackageManager.NpmPackageManager(options).installAsync();\n  }\n}\n\nexport function getChangeDirectoryPath(projectRoot: string): string {\n  const cdPath = path.relative(process.cwd(), projectRoot);\n  if (cdPath.length <= projectRoot.length) {\n    return cdPath;\n  }\n  return projectRoot;\n}\n\nexport async function installCocoaPodsAsync(projectRoot: string) {\n  let step = logNewSection('Installing CocoaPods...');\n  if (process.platform !== 'darwin') {\n    step.succeed('Skipped installing CocoaPods because operating system is not on macOS.');\n    return false;\n  }\n\n  const packageManager = new PackageManager.CocoaPodsPackageManager({\n    cwd: path.join(projectRoot, 'ios'),\n    silent: !EXPO_DEBUG,\n  });\n\n  if (!(await packageManager.isCLIInstalledAsync())) {\n    try {\n      // prompt user -- do you want to install cocoapods right now?\n      step.text = 'CocoaPods CLI not found in your PATH, installing it now.';\n      step.stopAndPersist();\n      await PackageManager.CocoaPodsPackageManager.installCLIAsync({\n        nonInteractive: true,\n        spawnOptions: {\n          ...packageManager.options,\n          // Don't silence this part\n          stdio: ['inherit', 'inherit', 'pipe'],\n        },\n      });\n      step.succeed('Installed CocoaPods CLI.');\n      step = logNewSection('Running `pod install` in the `ios` directory.');\n    } catch (e) {\n      step.stopAndPersist({\n        symbol: '⚠️ ',\n        text: chalk.red('Unable to install the CocoaPods CLI.'),\n      });\n      if (e instanceof PackageManager.CocoaPodsError) {\n        Log.log(e.message);\n      } else {\n        Log.log(`Unknown error: ${e.message}`);\n      }\n      return false;\n    }\n  }\n\n  try {\n    await packageManager.installAsync({ spinner: step });\n    // Create cached list for later\n    await hasPackageJsonDependencyListChangedAsync(projectRoot).catch(() => null);\n    step.succeed('Installed pods and initialized Xcode workspace.');\n    return true;\n  } catch (e) {\n    step.stopAndPersist({\n      symbol: '⚠️ ',\n      text: chalk.red('Something went wrong running `pod install` in the `ios` directory.'),\n    });\n    if (e instanceof PackageManager.CocoaPodsError) {\n      Log.log(e.message);\n    } else {\n      Log.log(`Unknown error: ${e.message}`);\n    }\n    return false;\n  }\n}\n"],"file":"CreateApp.js"}