{"version":3,"sources":["../../../src/commands/publish/getUsageAsync.ts"],"names":["getUsageAsync","projectRoot","_getUsageAsync","e","Log","warn","_getGenericUsage","allPlatforms","publishesResult","releaseChannel","count","length","publishes","queryResult","uniquePlatforms","publish","platform","details","Promise","all","map","publication","detailOptions","publishId","publicationId","uniqueRevisionIds","detail","revisionId","channel","publishedTime","sdkVersion","timeDifferenceString","_getTimeDifferenceString","Date","t0","t1","minutesInMs","hourInMs","dayInMs","diffMs","Math","abs","getTime","diffDays","round","diffHours","diffMinutes"],"mappings":"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","sourcesContent":["import uniqBy from 'lodash/uniqBy';\n\nimport Log from '../../log';\nimport {\n  getPublicationDetailAsync,\n  getPublishHistoryAsync,\n  Publication,\n} from '../utils/PublishUtils';\n\nexport async function getUsageAsync(projectRoot: string): Promise<string> {\n  try {\n    return await _getUsageAsync(projectRoot);\n  } catch (e) {\n    Log.warn(e);\n    // couldn't print out warning for some reason\n    return _getGenericUsage();\n  }\n}\n\nasync function _getUsageAsync(projectRoot: string): Promise<string> {\n  const allPlatforms = ['ios', 'android'];\n  const publishesResult = await getPublishHistoryAsync(projectRoot, {\n    releaseChannel: 'default', // not specifying a channel will return most recent publishes but this is not neccesarily the most recent entry in a channel (user could have set an older publish to top of the channel)\n    count: allPlatforms.length,\n  });\n  const publishes = publishesResult.queryResult as Publication[];\n\n  // If the user published normally, there would be a publish for each platform with the same revisionId\n  const uniquePlatforms = uniqBy(publishes, publish => publish.platform);\n  if (uniquePlatforms.length !== allPlatforms.length) {\n    // User probably applied some custom `publish:set` or `publish:rollback` command\n    return _getGenericUsage();\n  }\n\n  const details = await Promise.all(\n    publishes.map(async publication => {\n      const detailOptions = {\n        publishId: publication.publicationId,\n      };\n      return await getPublicationDetailAsync(projectRoot, detailOptions);\n    })\n  );\n\n  const uniqueRevisionIds = uniqBy(details, detail => detail.revisionId);\n  if (uniqueRevisionIds.length !== 1) {\n    // User probably applied some custom `publish:set` or `publish:rollback` command\n    return _getGenericUsage();\n  }\n\n  const { channel } = publishes[0];\n  const { revisionId, publishedTime, sdkVersion } = details[0];\n  const timeDifferenceString = _getTimeDifferenceString(new Date(), new Date(publishedTime));\n\n  return (\n    `--release-channel and either --sdk-version or --runtime-version arguments are required. \\n` +\n    `For example, to roll back the revision [${revisionId}] on release channel [${channel}] (published ${timeDifferenceString}), \\n` +\n    `run: expo publish:rollback --release-channel ${channel} --sdk-version ${sdkVersion}`\n  );\n}\n\nfunction _getTimeDifferenceString(t0: Date, t1: Date): string {\n  const minutesInMs = 60 * 1000;\n  const hourInMs = 60 * minutesInMs;\n  const dayInMs = 24 * hourInMs; // hours*minutes*seconds*milliseconds\n  const diffMs = Math.abs(t1.getTime() - t0.getTime());\n\n  const diffDays = Math.round(diffMs / dayInMs);\n  if (diffDays > 0) {\n    return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;\n  }\n\n  const diffHours = Math.round(diffMs / hourInMs);\n  if (diffHours > 0) {\n    return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;\n  }\n\n  const diffMinutes = Math.round(diffMs / minutesInMs);\n  if (diffMinutes > 0) {\n    return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;\n  }\n\n  return 'recently';\n}\n\nfunction _getGenericUsage(): string {\n  return (\n    `--release-channel and either --sdk-version or --runtime-version arguments are required. \\n` +\n    `For example, to roll back the latest publishes on the default channel for sdk 37.0.0, \\n` +\n    `run: expo publish:rollback --release-channel default --sdk-version 37.0.0 \\n` +\n    `To rollback a specific platform, use the --platform flag.`\n  );\n}\n"],"file":"getUsageAsync.js"}