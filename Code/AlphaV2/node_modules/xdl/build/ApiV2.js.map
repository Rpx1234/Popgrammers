{"version":3,"sources":["../src/ApiV2.ts"],"names":["MAX_CONTENT_LENGTH","MAX_BODY_LENGTH","_rootBaseUrl","Config","api","scheme","host","_apiBaseUrl","rootBaseUrl","port","_convertFormDataToBuffer","formData","Promise","resolve","pipe","encoding","data","ApiV2Error","Error","constructor","message","code","ApiV2Client","clientForUser","user","setClientName","name","exponentClient","options","accessToken","sessionSecret","getAsync","methodName","args","extraOptions","returnEntireResponse","_requestAsync","httpMethod","queryParameters","postAsync","body","putAsync","patchAsync","deleteAsync","uploadFormDataAsync","uploadOptions","headers","getHeaders","undefined","extraRequestOptions","url","reqOptions","method","params","paramsSerializer","QueryString","stringify","hasOwnProperty","ConnectionStatus","isOffline","timeout","maxContentLength","maxBodyLength","response","result","axios","request","e","errors","length","responseError","error","serverStack","stack","details","metadata"],"mappings":"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","sourcesContent":["import { JSONObject, JSONValue } from '@expo/json-file';\nimport axios, { AxiosRequestConfig } from 'axios';\nimport concat from 'concat-stream';\nimport FormData from 'form-data';\nimport merge from 'lodash/merge';\nimport QueryString from 'querystring';\n\nimport { Config, ConnectionStatus } from './internal';\n\nconst MAX_CONTENT_LENGTH = 100 /* MB */ * 1024 * 1024;\nconst MAX_BODY_LENGTH = 100 /* MB */ * 1024 * 1024;\n\n// These aren't constants because some commands switch between staging and prod\nfunction _rootBaseUrl() {\n  return `${Config.api.scheme}://${Config.api.host}`;\n}\n\nfunction _apiBaseUrl() {\n  let rootBaseUrl = _rootBaseUrl();\n  if (Config.api.port) {\n    rootBaseUrl += ':' + Config.api.port;\n  }\n  return rootBaseUrl + '/--/api/v2';\n}\n\nasync function _convertFormDataToBuffer(formData: FormData): Promise<{ data: Buffer }> {\n  return new Promise(resolve => {\n    formData.pipe(concat({ encoding: 'buffer' }, data => resolve({ data })));\n  });\n}\n\nexport class ApiV2Error extends Error {\n  readonly name = 'ApiV2Error';\n  code: string;\n  details?: JSONValue;\n  serverStack?: string;\n  metadata?: object;\n  readonly _isApiError = true;\n\n  constructor(message: string, code: string = 'UNKNOWN') {\n    super(message);\n    this.code = code;\n  }\n}\n\ntype RequestOptions = {\n  httpMethod: 'get' | 'post' | 'put' | 'patch' | 'delete';\n  queryParameters?: QueryParameters;\n  body?: JSONObject;\n  timeout?: number;\n};\n\ntype UploadOptions = {\n  headers: any;\n  data: any;\n};\n\ntype QueryParameters = { [key: string]: string | number | boolean | null | undefined };\n\ntype APIV2ClientOptions = {\n  sessionSecret?: string;\n  accessToken?: string;\n};\n\nexport default class ApiV2Client {\n  static exponentClient: string = 'xdl';\n  sessionSecret: string | null = null;\n  accessToken: string | null = null;\n\n  static clientForUser(user?: APIV2ClientOptions | null): ApiV2Client {\n    if (user) {\n      return new ApiV2Client(user);\n    }\n\n    return new ApiV2Client();\n  }\n\n  static setClientName(name: string) {\n    ApiV2Client.exponentClient = name;\n  }\n\n  constructor(options: APIV2ClientOptions = {}) {\n    if (options.accessToken) {\n      this.accessToken = options.accessToken;\n    }\n    if (options.sessionSecret) {\n      this.sessionSecret = options.sessionSecret;\n    }\n  }\n\n  async getAsync(\n    methodName: string,\n    args: QueryParameters = {},\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'get',\n        queryParameters: args,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async postAsync(\n    methodName: string,\n    data?: JSONObject,\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'post',\n        body: data,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async putAsync(\n    methodName: string,\n    data: JSONObject,\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'put',\n        body: data,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async patchAsync(\n    methodName: string,\n    data: JSONObject,\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'patch',\n        body: data,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async deleteAsync(\n    methodName: string,\n    args: QueryParameters = {},\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'delete',\n        queryParameters: args,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async uploadFormDataAsync(methodName: string, formData: FormData) {\n    const options: RequestOptions = { httpMethod: 'put' };\n    const { data } = await _convertFormDataToBuffer(formData);\n    const uploadOptions: UploadOptions = {\n      headers: formData.getHeaders(),\n      data,\n    };\n    return await this._requestAsync(methodName, options, undefined, false, uploadOptions);\n  }\n\n  async _requestAsync(\n    methodName: string,\n    options: RequestOptions,\n    extraRequestOptions: Partial<RequestOptions> = {},\n    returnEntireResponse: boolean = false,\n    uploadOptions?: UploadOptions\n  ) {\n    const url = `${_apiBaseUrl()}/${methodName}`;\n    let reqOptions: AxiosRequestConfig = {\n      url,\n      method: options.httpMethod,\n      headers: {\n        'Exponent-Client': ApiV2Client.exponentClient,\n      },\n    };\n\n    // Handle auth method, prioritizing authorization tokens before session secrets\n    if (this.accessToken) {\n      reqOptions.headers['Authorization'] = `Bearer ${this.accessToken}`;\n    } else if (this.sessionSecret) {\n      reqOptions.headers['Expo-Session'] = this.sessionSecret;\n    }\n\n    // Handle qs\n    if (options.queryParameters) {\n      reqOptions.params = options.queryParameters;\n      reqOptions.paramsSerializer = QueryString.stringify;\n    }\n\n    // Handle body\n    if (options.body) {\n      reqOptions.data = options.body;\n    }\n\n    if (!extraRequestOptions.hasOwnProperty('timeout') && ConnectionStatus.isOffline()) {\n      reqOptions.timeout = 1;\n    }\n\n    reqOptions = merge({}, reqOptions, extraRequestOptions, uploadOptions, {\n      maxContentLength: MAX_CONTENT_LENGTH,\n      maxBodyLength: MAX_BODY_LENGTH,\n    });\n\n    let response;\n    let result;\n    try {\n      response = await axios.request(reqOptions);\n      result = response.data;\n    } catch (e) {\n      if (e?.response?.data?.errors?.length) {\n        result = e.response.data;\n      } else {\n        throw e;\n      }\n    }\n\n    if (result.errors && result.errors.length) {\n      const responseError = result.errors[0];\n      const error = new ApiV2Error(responseError.message, responseError.code);\n      error.serverStack = responseError.stack;\n      error.details = responseError.details;\n      error.metadata = responseError.metadata;\n      throw error;\n    }\n\n    return returnEntireResponse ? response : result.data;\n  }\n}\n"],"file":"ApiV2.js"}