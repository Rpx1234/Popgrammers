{"version":3,"sources":["../../../../../src/apple/native-run/ios/lib/manager.ts"],"names":["ClientManager","constructor","pairRecord","device","lockdowndClient","connections","socket","create","udid","usbmuxClient","UsbmuxdClient","connectUsbmuxdSocket","getDevice","readPairRecord","Properties","SerialNumber","lockdownSocket","connect","lockdownClient","LockdowndClient","doHandshake","getUsbmuxdClient","push","getLockdowndClient","getLockdowndClientWithHandshake","getAFCClient","getServiceClient","AFCClient","getInstallationProxyClient","InstallationProxyClient","getMobileImageMounterClient","MobileImageMounterClient","getDebugserverClient","DebugserverClient","name","ServiceType","disableSSL","port","servicePort","enableServiceSSL","startService","usbmuxdSocket","tlsOptions","rejectUnauthorized","secureContext","tls","createSecureContext","secureProtocol","cert","RootCertificate","key","RootPrivateKey","proxy","UsbmuxdProxy","Promise","resolve","reject","timeoutId","setTimeout","Error","clearTimeout","destroy","client","end","err","Duplex","usbmuxdSock","on","data","_write","chunk","encoding","callback","write","_read","size","_destroy","removeAllListeners"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) 2021 Expo, Inc.\n * Copyright (c) 2018 Drifty Co.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport type * as net from 'net';\nimport { Duplex } from 'stream';\nimport * as tls from 'tls';\n\nimport type { ServiceClient } from './client';\nimport { AFCClient } from './client/afc';\nimport { DebugserverClient } from './client/debugserver';\nimport { InstallationProxyClient } from './client/installation_proxy';\nimport { LockdowndClient } from './client/lockdownd';\nimport { MobileImageMounterClient } from './client/mobile_image_mounter';\nimport type { UsbmuxdDevice, UsbmuxdPairRecord } from './client/usbmuxd';\nimport { UsbmuxdClient } from './client/usbmuxd';\n\nexport class ClientManager {\n  private connections: net.Socket[];\n  constructor(\n    public pairRecord: UsbmuxdPairRecord,\n    public device: UsbmuxdDevice,\n    private lockdowndClient: LockdowndClient\n  ) {\n    this.connections = [lockdowndClient.socket];\n  }\n\n  static async create(udid?: string) {\n    const usbmuxClient = new UsbmuxdClient(UsbmuxdClient.connectUsbmuxdSocket());\n    const device = await usbmuxClient.getDevice(udid);\n    const pairRecord = await usbmuxClient.readPairRecord(device.Properties.SerialNumber);\n    const lockdownSocket = await usbmuxClient.connect(device, 62078);\n    const lockdownClient = new LockdowndClient(lockdownSocket);\n    await lockdownClient.doHandshake(pairRecord);\n    return new ClientManager(pairRecord, device, lockdownClient);\n  }\n\n  async getUsbmuxdClient() {\n    const usbmuxClient = new UsbmuxdClient(UsbmuxdClient.connectUsbmuxdSocket());\n    this.connections.push(usbmuxClient.socket);\n    return usbmuxClient;\n  }\n\n  async getLockdowndClient() {\n    const usbmuxClient = new UsbmuxdClient(UsbmuxdClient.connectUsbmuxdSocket());\n    const lockdownSocket = await usbmuxClient.connect(this.device, 62078);\n    const lockdownClient = new LockdowndClient(lockdownSocket);\n    this.connections.push(lockdownClient.socket);\n    return lockdownClient;\n  }\n\n  async getLockdowndClientWithHandshake() {\n    const lockdownClient = await this.getLockdowndClient();\n    await lockdownClient.doHandshake(this.pairRecord);\n    return lockdownClient;\n  }\n\n  async getAFCClient() {\n    return this.getServiceClient('com.apple.afc', AFCClient);\n  }\n\n  async getInstallationProxyClient() {\n    return this.getServiceClient('com.apple.mobile.installation_proxy', InstallationProxyClient);\n  }\n\n  async getMobileImageMounterClient() {\n    return this.getServiceClient('com.apple.mobile.mobile_image_mounter', MobileImageMounterClient);\n  }\n\n  async getDebugserverClient() {\n    try {\n      // iOS 14 added support for a secure debug service so try to connect to that first\n      return await this.getServiceClient(\n        'com.apple.debugserver.DVTSecureSocketProxy',\n        DebugserverClient\n      );\n    } catch {\n      // otherwise, fall back to the previous implementation\n      return this.getServiceClient('com.apple.debugserver', DebugserverClient, true);\n    }\n  }\n\n  private async getServiceClient<T extends ServiceClient<any>>(\n    name: string,\n    ServiceType: new (...args: any[]) => T,\n    disableSSL = false\n  ) {\n    const { port: servicePort, enableServiceSSL } = await this.lockdowndClient.startService(name);\n    const usbmuxClient = new UsbmuxdClient(UsbmuxdClient.connectUsbmuxdSocket());\n    let usbmuxdSocket = await usbmuxClient.connect(this.device, servicePort);\n\n    if (enableServiceSSL) {\n      const tlsOptions: tls.ConnectionOptions = {\n        rejectUnauthorized: false,\n        secureContext: tls.createSecureContext({\n          secureProtocol: 'TLSv1_method',\n          cert: this.pairRecord.RootCertificate,\n          key: this.pairRecord.RootPrivateKey,\n        }),\n      };\n\n      // Some services seem to not support TLS/SSL after the initial handshake\n      // More info: https://github.com/libimobiledevice/libimobiledevice/issues/793\n      if (disableSSL) {\n        // According to https://nodejs.org/api/tls.html#tls_tls_connect_options_callback we can\n        // pass any Duplex in to tls.connect instead of a Socket. So we'll use our proxy to keep\n        // the TLS wrapper and underlying usbmuxd socket separate.\n        const proxy: any = new UsbmuxdProxy(usbmuxdSocket);\n        tlsOptions.socket = proxy;\n\n        await new Promise<void>((resolve, reject) => {\n          const timeoutId = setTimeout(() => {\n            reject(new Error('The TLS handshake failed to complete after 5s.'));\n          }, 5000);\n          tls.connect(tlsOptions, function (this: tls.TLSSocket) {\n            clearTimeout(timeoutId);\n            // After the handshake, we don't need TLS or the proxy anymore,\n            // since we'll just pass in the naked usbmuxd socket to the service client\n            this.destroy();\n            resolve();\n          });\n        });\n      } else {\n        tlsOptions.socket = usbmuxdSocket;\n        usbmuxdSocket = tls.connect(tlsOptions);\n      }\n    }\n    const client = new ServiceType(usbmuxdSocket);\n    this.connections.push(client.socket);\n    return client;\n  }\n\n  end() {\n    for (const socket of this.connections) {\n      // may already be closed\n      try {\n        socket.end();\n      } catch (err) {\n        // ignore\n      }\n    }\n  }\n}\n\nclass UsbmuxdProxy extends Duplex {\n  constructor(private usbmuxdSock: net.Socket) {\n    super();\n\n    this.usbmuxdSock.on('data', data => {\n      this.push(data);\n    });\n  }\n\n  _write(chunk: any, encoding: string, callback: (err?: Error) => void) {\n    this.usbmuxdSock.write(chunk);\n    callback();\n  }\n\n  _read(size: number) {\n    // Stub so we don't error, since we push everything we get from usbmuxd as it comes in.\n    // TODO: better way to do this?\n  }\n\n  _destroy() {\n    this.usbmuxdSock.removeAllListeners();\n  }\n}\n"],"file":"manager.js"}