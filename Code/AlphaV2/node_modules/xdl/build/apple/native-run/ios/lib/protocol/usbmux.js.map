{"version":3,"sources":["../../../../../../src/apple/native-run/ios/lib/protocol/usbmux.ts"],"names":["debug","USBMUXD_HEADER_SIZE","UsbmuxProtocolClient","ProtocolClient","constructor","socket","ProtocolReaderFactory","UsbmuxProtocolReader","UsbmuxProtocolWriter","PlistProtocolReader","callback","parseHeader","data","readUInt32LE","parseBody","resp","JSON","stringify","write","msg","messageType","extraFields","plistMessage","plist","build","BundleID","ClientVersionString","MessageType","ProgName","kLibUSBMuxVersion","dataSize","length","protocolVersion","messageCode","header","Buffer","alloc","writeUInt32LE","useTag"],"mappings":";;;;;;;AAQA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAIA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;AAEA,MAAMA,KAAK,GAAG,sBAAM,kCAAN,CAAd;AAEO,MAAMC,mBAAmB,GAAG,EAA5B;;;AAOA,MAAMC,oBAAN,SAAmCC,0BAAnC,CAAiE;AACtEC,EAAAA,WAAW,CAACC,MAAD,EAAqB;AAC9B,UAAMA,MAAN,EAAc,KAAIC,iCAAJ,EAA0BC,oBAA1B,CAAd,EAA+D,IAAIC,oBAAJ,EAA/D;AACD;;AAHqE;;;;AAMjE,MAAMD,oBAAN,SAAmCE,+BAAnC,CAAuD;AAC5DL,EAAAA,WAAW,CAACM,QAAD,EAA+B;AACxC,UAAMT,mBAAN,EAA2BS,QAA3B;AACD;;AAEDC,EAAAA,WAAW,CAACC,IAAD,EAAe;AACxB,WAAOA,IAAI,CAACC,YAAL,CAAkB,CAAlB,IAAuBZ,mBAA9B;AACD;;AAEDa,EAAAA,SAAS,CAACF,IAAD,EAAe;AACtB,UAAMG,IAAI,GAAG,MAAMD,SAAN,CAAgBF,IAAhB,CAAb;AACAZ,IAAAA,KAAK,CAAE,aAAYgB,IAAI,CAACC,SAAL,CAAeF,IAAf,CAAqB,EAAnC,CAAL;AACA,WAAOA,IAAP;AACD;;AAb2D;;;;AAgBvD,MAAMP,oBAAN,CAAqD;AAAA;AAAA,oCACzC,CADyC;AAAA;;AAG1DU,EAAAA,KAAK,CAACb,MAAD,EAAqBc,GAArB,EAAyC;AAC5C;AACAnB,IAAAA,KAAK,CAAE,iBAAgBgB,IAAI,CAACC,SAAL,CAAeE,GAAf,CAAoB,EAAtC,CAAL;AACA,UAAM;AAAEC,MAAAA,WAAF;AAAeC,MAAAA;AAAf,QAA+BF,GAArC;;AACA,UAAMG,YAAY,GAAGC,iBAAMC,KAAN,CAAY;AAC/BC,MAAAA,QAAQ,EAAE,qBADqB;AACE;AACjCC,MAAAA,mBAAmB,EAAE,WAFU;AAEG;AAClCC,MAAAA,WAAW,EAAEP,WAHkB;AAI/BQ,MAAAA,QAAQ,EAAE,YAJqB;AAIP;AACxBC,MAAAA,iBAAiB,EAAE,CALY;AAM/B,SAAGR;AAN4B,KAAZ,CAArB;;AASA,UAAMS,QAAQ,GAAGR,YAAY,GAAGA,YAAY,CAACS,MAAhB,GAAyB,CAAtD;AACA,UAAMC,eAAe,GAAG,CAAxB;AACA,UAAMC,WAAW,GAAG,CAApB;AAEA,UAAMC,MAAM,GAAGC,MAAM,CAACC,KAAP,CAAanC,mBAAb,CAAf;AACAiC,IAAAA,MAAM,CAACG,aAAP,CAAqBpC,mBAAmB,GAAG6B,QAA3C,EAAqD,CAArD;AACAI,IAAAA,MAAM,CAACG,aAAP,CAAqBL,eAArB,EAAsC,CAAtC;AACAE,IAAAA,MAAM,CAACG,aAAP,CAAqBJ,WAArB,EAAkC,CAAlC;AACAC,IAAAA,MAAM,CAACG,aAAP,CAAqB,KAAKC,MAAL,EAArB,EAAoC,EAApC,EArB4C,CAqBH;;AACzCjC,IAAAA,MAAM,CAACa,KAAP,CAAagB,MAAb;AACA7B,IAAAA,MAAM,CAACa,KAAP,CAAaI,YAAb;AACD;;AA3ByD","sourcesContent":["/**\n * Copyright (c) 2021 Expo, Inc.\n * Copyright (c) 2018 Drifty Co.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport plist from '@expo/plist';\nimport Debug from 'debug';\nimport type * as net from 'net';\n\nimport type { ProtocolWriter } from './protocol';\nimport { PlistProtocolReader, ProtocolClient, ProtocolReaderFactory } from './protocol';\n\nconst debug = Debug('expo:xdl:ios:lib:protocol:usbmux');\n\nexport const USBMUXD_HEADER_SIZE = 16;\n\nexport interface UsbmuxMessage {\n  messageType: string;\n  extraFields?: { [key: string]: any };\n}\n\nexport class UsbmuxProtocolClient extends ProtocolClient<UsbmuxMessage> {\n  constructor(socket: net.Socket) {\n    super(socket, new ProtocolReaderFactory(UsbmuxProtocolReader), new UsbmuxProtocolWriter());\n  }\n}\n\nexport class UsbmuxProtocolReader extends PlistProtocolReader {\n  constructor(callback: (data: any) => any) {\n    super(USBMUXD_HEADER_SIZE, callback);\n  }\n\n  parseHeader(data: Buffer) {\n    return data.readUInt32LE(0) - USBMUXD_HEADER_SIZE;\n  }\n\n  parseBody(data: Buffer) {\n    const resp = super.parseBody(data);\n    debug(`Response: ${JSON.stringify(resp)}`);\n    return resp;\n  }\n}\n\nexport class UsbmuxProtocolWriter implements ProtocolWriter {\n  private useTag = 0;\n\n  write(socket: net.Socket, msg: UsbmuxMessage) {\n    // TODO Usbmux message type\n    debug(`socket write: ${JSON.stringify(msg)}`);\n    const { messageType, extraFields } = msg;\n    const plistMessage = plist.build({\n      BundleID: 'dev.expo.native-run', // TODO\n      ClientVersionString: 'usbmux.js', // TODO\n      MessageType: messageType,\n      ProgName: 'native-run', // TODO\n      kLibUSBMuxVersion: 3,\n      ...extraFields,\n    });\n\n    const dataSize = plistMessage ? plistMessage.length : 0;\n    const protocolVersion = 1;\n    const messageCode = 8;\n\n    const header = Buffer.alloc(USBMUXD_HEADER_SIZE);\n    header.writeUInt32LE(USBMUXD_HEADER_SIZE + dataSize, 0);\n    header.writeUInt32LE(protocolVersion, 4);\n    header.writeUInt32LE(messageCode, 8);\n    header.writeUInt32LE(this.useTag++, 12); // TODO\n    socket.write(header);\n    socket.write(plistMessage);\n  }\n}\n"],"file":"usbmux.js"}