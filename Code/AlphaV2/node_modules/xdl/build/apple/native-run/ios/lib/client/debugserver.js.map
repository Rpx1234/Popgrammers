{"version":3,"sources":["../../../../../../src/apple/native-run/ios/lib/client/debugserver.ts"],"names":["debug","DebugserverClient","ServiceClient","constructor","socket","GDBProtocolClient","setMaxPacketSize","size","sendCommand","toString","setWorkingDir","workingDir","checkLaunchSuccess","attachByName","name","hexName","Buffer","from","continue","halt","protocolClient","write","kill","msg","cmd","args","sendMessage","resp","resolve","reject","parts","split","part","includes","launchApp","appPath","executableName","fullPath","path","join","hexAppPath","appCommand","length"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) 2021 Expo, Inc.\n * Copyright (c) 2018 Drifty Co.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport Debug from 'debug';\nimport type * as net from 'net';\nimport * as path from 'path';\n\nimport { GDBProtocolClient } from '../protocol/gdb';\nimport { ServiceClient } from './client';\n\nconst debug = Debug('expo:xdl:ios:lib:client:debugserver');\n\nexport class DebugserverClient extends ServiceClient<GDBProtocolClient> {\n  constructor(public socket: net.Socket) {\n    super(socket, new GDBProtocolClient(socket));\n  }\n\n  async setMaxPacketSize(size: number) {\n    return this.sendCommand('QSetMaxPacketSize:', [size.toString()]);\n  }\n\n  async setWorkingDir(workingDir: string) {\n    return this.sendCommand('QSetWorkingDir:', [workingDir]);\n  }\n\n  async checkLaunchSuccess() {\n    return this.sendCommand('qLaunchSuccess', []);\n  }\n\n  async attachByName(name: string) {\n    const hexName = Buffer.from(name).toString('hex');\n    return this.sendCommand(`vAttachName;${hexName}`, []);\n  }\n\n  async continue() {\n    return this.sendCommand('c', []);\n  }\n\n  halt() {\n    // ^C\n    debug('Sending ^C to debugserver');\n    return this.protocolClient.socket.write('\\u0003');\n  }\n\n  async kill() {\n    const msg: any = { cmd: 'k', args: [] };\n    return this.protocolClient.sendMessage(msg, (resp: string, resolve: any, reject: any) => {\n      this.protocolClient.socket.write('+');\n      const parts = resp.split(';');\n      for (const part of parts) {\n        if (part.includes('description')) {\n          // description:{hex encoded message like: \"Terminated with signal 9\"}\n          resolve(Buffer.from(part.split(':')[1], 'hex').toString('ascii'));\n        }\n      }\n    });\n  }\n\n  // TODO support app args\n  // https://sourceware.org/gdb/onlinedocs/gdb/Packets.html#Packets\n  // A arglen,argnum,arg,\n  async launchApp(appPath: string, executableName: string) {\n    const fullPath = path.join(appPath, executableName);\n    const hexAppPath = Buffer.from(fullPath).toString('hex');\n    const appCommand = `A${hexAppPath.length},0,${hexAppPath}`;\n    return this.sendCommand(appCommand, []);\n  }\n\n  async sendCommand(cmd: string, args: string[]) {\n    const msg = { cmd, args };\n    debug(`Sending command: ${cmd}, args: ${args}`);\n    const resp = await this.protocolClient.sendMessage(msg);\n    // we need to ACK as well\n    this.protocolClient.socket.write('+');\n    return resp;\n  }\n}\n"],"file":"debugserver.js"}