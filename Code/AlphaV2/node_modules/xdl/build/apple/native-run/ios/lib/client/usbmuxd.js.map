{"version":3,"sources":["../../../../../../src/apple/native-run/ios/lib/client/usbmuxd.ts"],"names":["debug","isUsbmuxdConnectResponse","resp","MessageType","Number","undefined","isUsbmuxdDeviceResponse","DeviceList","isUsbmuxdPairRecordResponse","PairRecordData","UsbmuxdClient","ServiceClient","constructor","socket","UsbmuxProtocolClient","connectUsbmuxdSocket","process","platform","net","connect","port","host","path","device","DeviceID","protocolClient","sendMessage","messageType","extraFields","PortNumber","htons","ResponseError","getDevices","getDevice","udid","devices","length","Error","Properties","SerialNumber","readPairRecord","PairRecordID","BPLIST_MAGIC","Buffer","from","compare","plist","parse","toString","n"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) 2021 Expo, Inc.\n * Copyright (c) 2018 Drifty Co.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport plist from '@expo/plist';\nimport Debug from 'debug';\nimport * as net from 'net';\n\nimport { parsePlistBuffer } from '../../../../../utils/parseBinaryPlistAsync';\nimport { UsbmuxProtocolClient } from '../protocol/usbmux';\nimport { ResponseError, ServiceClient } from './client';\n\nconst debug = Debug('expo:xdl:ios:lib:client:usbmuxd');\n\nexport interface UsbmuxdDeviceProperties {\n  ConnectionSpeed: number;\n  ConnectionType: 'USB';\n  DeviceID: number;\n  LocationID: number;\n  ProductID: number;\n  SerialNumber: string;\n}\n\nexport interface UsbmuxdDevice {\n  DeviceID: number;\n  MessageType: 'Attached'; // TODO: what else?\n  Properties: UsbmuxdDeviceProperties;\n}\n\nexport interface UsbmuxdConnectResponse {\n  MessageType: 'Result';\n  Number: number;\n}\n\nexport interface UsbmuxdDeviceResponse {\n  DeviceList: UsbmuxdDevice[];\n}\n\nexport interface UsbmuxdPairRecordResponse {\n  PairRecordData: Buffer;\n}\n\nexport interface UsbmuxdPairRecord {\n  DeviceCertificate: Buffer;\n  EscrowBag: Buffer;\n  HostCertificate: Buffer;\n  HostID: string;\n  HostPrivateKey: Buffer;\n  RootCertificate: Buffer;\n  RootPrivateKey: Buffer;\n  SystemBUID: string;\n  WiFiMACAddress: string;\n}\n\nfunction isUsbmuxdConnectResponse(resp: any): resp is UsbmuxdConnectResponse {\n  return resp.MessageType === 'Result' && resp.Number !== undefined;\n}\n\nfunction isUsbmuxdDeviceResponse(resp: any): resp is UsbmuxdDeviceResponse {\n  return resp.DeviceList !== undefined;\n}\n\nfunction isUsbmuxdPairRecordResponse(resp: any): resp is UsbmuxdPairRecordResponse {\n  return resp.PairRecordData !== undefined;\n}\n\nexport class UsbmuxdClient extends ServiceClient<UsbmuxProtocolClient> {\n  constructor(public socket: net.Socket) {\n    super(socket, new UsbmuxProtocolClient(socket));\n  }\n\n  static connectUsbmuxdSocket() {\n    debug('connectUsbmuxdSocket');\n    if (process.platform === 'win32') {\n      return net.connect({ port: 27015, host: 'localhost' });\n    } else {\n      return net.connect({ path: '/var/run/usbmuxd' });\n    }\n  }\n\n  async connect(device: UsbmuxdDevice, port: number) {\n    debug(`connect: ${device.DeviceID} on port ${port}`);\n\n    const resp = await this.protocolClient.sendMessage({\n      messageType: 'Connect',\n      extraFields: {\n        DeviceID: device.DeviceID,\n        PortNumber: htons(port),\n      },\n    });\n\n    if (isUsbmuxdConnectResponse(resp) && resp.Number === 0) {\n      return this.protocolClient.socket;\n    } else {\n      throw new ResponseError(\n        `There was an error connecting to ${device.DeviceID} on port ${port}`,\n        resp\n      );\n    }\n  }\n\n  async getDevices() {\n    debug('getDevices');\n\n    const resp = await this.protocolClient.sendMessage({\n      messageType: 'ListDevices',\n    });\n\n    if (isUsbmuxdDeviceResponse(resp)) {\n      return resp.DeviceList;\n    } else {\n      throw new ResponseError('Invalid response from getDevices', resp);\n    }\n  }\n\n  async getDevice(udid?: string) {\n    debug(`getDevice ${udid ? 'udid: ' + udid : ''}`);\n    const devices = await this.getDevices();\n\n    if (!devices.length) {\n      throw new Error('No devices found');\n    }\n\n    if (!udid) {\n      return devices[0];\n    }\n\n    for (const device of devices) {\n      if (device.Properties && device.Properties.SerialNumber === udid) {\n        return device;\n      }\n    }\n\n    throw new Error(`No device with udid ${udid} found`);\n  }\n\n  async readPairRecord(udid: string): Promise<UsbmuxdPairRecord> {\n    debug(`readPairRecord: ${udid}`);\n\n    const resp = await this.protocolClient.sendMessage({\n      messageType: 'ReadPairRecord',\n      extraFields: { PairRecordID: udid },\n    });\n\n    if (isUsbmuxdPairRecordResponse(resp)) {\n      // the pair record can be created as a binary plist\n      const BPLIST_MAGIC = Buffer.from('bplist00');\n      if (BPLIST_MAGIC.compare(resp.PairRecordData, 0, 8) === 0) {\n        debug('Binary plist pair record detected.');\n        return parsePlistBuffer(resp.PairRecordData)[0];\n      } else {\n        // TODO: use parsePlistBuffer\n        return plist.parse(resp.PairRecordData.toString()) as any; // TODO: type guard\n      }\n    } else {\n      throw new ResponseError(`There was an error reading pair record for udid: ${udid}`, resp);\n    }\n  }\n}\n\nfunction htons(n: number) {\n  return ((n & 0xff) << 8) | ((n >> 8) & 0xff);\n}\n"],"file":"usbmuxd.js"}