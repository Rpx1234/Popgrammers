{"version":3,"sources":["../../src/logs/PackagerLogsStream.ts"],"names":["PackagerLogsStream","constructor","projectRoot","getCurrentOpenProjectId","updateLogs","onStartBuildBundle","onProgressBuildBundle","onFinishBuildBundle","getSnippetForError","chunk","msg","bundleDetails","bundleDetailsCache","buildID","type","String","_metroEventType","_handleNewBundleTransformStarted","_bundleBuildChunkID","_handleUpdateBundleTransformProgress","_updateLogs","logs","_logsToAdd","length","nextLogs","concat","match","replace","_projectRoot","_getCurrentOpenProjectId","_onStartBuildBundle","_onProgressBuildBundle","_onFinishBuildBundle","_getSnippetForError","_attachLoggerStream","projectId","ProjectUtils","attachLoggerStream","stream","write","_handleChunk","bind","tag","_maybeParseMsgJSON","_cleanUpNodeErrors","_handleMetroEvent","_enqueueAppendLogChunk","originalChunk","includes","getenv","boolish","_handleBundleTransformEvent","code","error","port","_formatModuleResolutionError","_formatBundlingError","level","Logger","ERROR","warning","WARN","reason","_formatWorkerChunk","JSON","stringify","getPlatformTagForBuildDetails","platform","formatted","ios","android","web","chalk","bold","id","_bundleBuildStart","Date","progressChunk","percentProgress","bundleComplete","duration","getTime","percentage","transformedFileCount","totalFileCount","roundedPercentProgress","Math","floor","progress","start","end","forEach","log","message","exec","originModulePath","moduleName","relativePath","path","relative","DOCS_PAGE_URL","NODE_STDLIB_MODULES","Array","isArray","errors","description","red","snippet","isAmbiguousError","name","isComprehensiveTransformError","filename","stack","gray","origin","shouldHide","push","_enqueueFlushLogsToAdd","parsedMsg","parse","e"],"mappings":";;;;;;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;AAsKe,MAAMA,kBAAN,CAAyB;AAYtCC,EAAAA,WAAW,CAAC;AACVC,IAAAA,WADU;AAEVC,IAAAA,uBAFU;AAGVC,IAAAA,UAHU;AAIVC,IAAAA,kBAJU;AAKVC,IAAAA,qBALU;AAMVC,IAAAA,mBANU;AAOVC,IAAAA;AAPU,GAAD,EAgBR;AAAA;;AAAA;;AAAA;;AAAA,wCAxBuB,EAwBvB;;AAAA,iDAvBkC,IAuBlC;;AAAA;;AAAA;;AAAA;;AAAA,+CAnB8B,IAmB9B;;AAAA;;AAAA;;AAAA,gDA0IiD,EA1IjD;;AAAA,yDA6I4BC,KAAD,IAA2B;AACvD,YAAMC,GAAG,GAAGD,KAAK,CAACC,GAAlB;AAEA,YAAMC,aAAa,GAAG,aAAaD,GAAb,GAAmB,KAAKE,kBAAL,CAAwBF,GAAG,CAACG,OAA5B,KAAwC,IAA3D,GAAkE,IAAxF;;AAEA,UAAIH,GAAG,CAACI,IAAJ,KAAa,sBAAjB,EAAyC;AACvC;AACA,aAAKF,kBAAL,CAAwBG,MAAM,CAACL,GAAG,CAACG,OAAL,CAA9B,IAA+CH,GAAG,CAACC,aAAnD;AACAF,QAAAA,KAAK,CAACO,eAAN,GAAwB,eAAxB;;AACA,aAAKC,gCAAL,CAAsCR,KAAtC,EAA6CC,GAAG,CAACC,aAAjD;AACD,OALD,MAKO,IAAID,GAAG,CAACI,IAAJ,KAAa,6BAAb,IAA8C,KAAKI,mBAAvD,EAA4E;AACjFT,QAAAA,KAAK,CAACO,eAAN,GAAwB,gBAAxB;;AACA,aAAKG,oCAAL,CAA0CV,KAA1C,EAAiDE,aAAjD;AACD,OAHM,MAGA,IAAID,GAAG,CAACI,IAAJ,KAAa,qBAAb,IAAsC,KAAKI,mBAA/C,EAAoE;AACzET,QAAAA,KAAK,CAACO,eAAN,GAAwB,cAAxB;;AACA,aAAKG,oCAAL,CAA0CV,KAA1C,EAAiDE,aAAjD;AACD,OAHM,MAGA,IAAID,GAAG,CAACI,IAAJ,KAAa,mBAAb,IAAoC,KAAKI,mBAA7C,EAAkE;AACvET,QAAAA,KAAK,CAACO,eAAN,GAAwB,YAAxB;;AACA,aAAKG,oCAAL,CAA0CV,KAA1C,EAAiDE,aAAjD;AACD;AACF,KAjKE;;AAAA,oDAyVsB,MAAM;AAC7B,WAAKS,WAAL,CAAiBC,IAAI,IAAI;AACvB,YAAI,KAAKC,UAAL,CAAgBC,MAAhB,KAA2B,CAA/B,EAAkC;AAChC,iBAAOF,IAAP;AACD;;AAED,cAAMG,QAAQ,GAAGH,IAAI,CAACI,MAAL,CAAY,KAAKH,UAAjB,CAAjB;AACA,aAAKA,UAAL,GAAkB,EAAlB;AACA,eAAOE,QAAP;AACD,OARD;AASD,KAnWE;;AAAA,gDAgXmBf,KAAD,IAAsB;AACzC,UAAI,OAAOA,KAAK,CAACC,GAAb,KAAqB,QAAzB,EAAmC;AACjC,eAAOD,KAAP;AACD;;AAED,UAAIA,KAAK,CAACC,GAAN,CAAUgB,KAAV,CAAgB,eAAhB,CAAJ,EAAsC;AACpC;AACA;AACA,YAAIjB,KAAK,CAACC,GAAN,CAAUgB,KAAV,CAAgB,kCAAhB,CAAJ,EAAyD;AACvDjB,UAAAA,KAAK,CAACC,GAAN,GAAYD,KAAK,CAACC,GAAN,CAAUiB,OAAV,CAAkB,4BAAlB,EAAgD,EAAhD,CAAZ;;AACA,cAAIlB,KAAK,CAACC,GAAN,CAAUgB,KAAV,CAAgB,0BAAhB,CAAJ,EAAiD;AAC/CjB,YAAAA,KAAK,CAACC,GAAN,GAAYD,KAAK,CAACC,GAAN,CAAUiB,OAAV,CAAkB,eAAlB,EAAmC,EAAnC,CAAZ;AACD;AACF,SALD,MAKO,IAAIlB,KAAK,CAACC,GAAN,CAAUgB,KAAV,CAAgB,oBAAhB,CAAJ,EAA2C;AAChDjB,UAAAA,KAAK,CAACC,GAAN,GAAY,EAAZ;AACD;AACF;;AAED,aAAOD,KAAP;AACD,KAnYE;;AACD,SAAKmB,YAAL,GAAoB1B,WAApB;;AACA,SAAK2B,wBAAL,GAAgC1B,uBAAuB,KAAK,MAAM,CAAX,CAAvD;;AACA,SAAKiB,WAAL,GAAmBhB,UAAnB,CAHC,CAKD;AACA;;AACA,SAAK0B,mBAAL,GAA2BzB,kBAA3B;AACA,SAAK0B,sBAAL,GAA8BzB,qBAA9B;AACA,SAAK0B,oBAAL,GAA4BzB,mBAA5B,CATC,CAWD;AACA;;AACA,SAAK0B,mBAAL,GAA2BzB,kBAA3B;;AAEA,SAAK0B,mBAAL;AACD;;AAIDA,EAAAA,mBAAmB,GAAG;AACpB,SAAKC,SAAL,GAAiB,KAAKN,wBAAL,EAAjB;;AAEAO,6BAAaC,kBAAb,CAAgC,KAAKT,YAArC,EAAmD;AACjDU,MAAAA,MAAM,EAAE;AACNC,QAAAA,KAAK,EAAE,KAAKC,YAAL,CAAkBC,IAAlB,CAAuB,IAAvB;AADD,OADyC;AAIjD3B,MAAAA,IAAI,EAAE;AAJ2C,KAAnD;AAMD;;AAED0B,EAAAA,YAAY,CAAC/B,KAAD,EAAmB;AAC7B,QAAIA,KAAK,CAACiC,GAAN,KAAc,OAAd,IAAyBjC,KAAK,CAACiC,GAAN,KAAc,MAA3C,EAAmD;AACjD;AACD,KAFD,MAEO,IAAI,KAAKb,wBAAL,OAAoC,KAAKM,SAA7C,EAAwD;AAC7D;AACA;AACA;AACD;;AAED1B,IAAAA,KAAK,GAAG,KAAKkC,kBAAL,CAAwBlC,KAAxB,CAAR;AACAA,IAAAA,KAAK,GAAG,KAAKmC,kBAAL,CAAwBnC,KAAxB,CAAR;;AACA,QAAIA,KAAK,CAACiC,GAAN,KAAc,OAAlB,EAA2B;AACzB,WAAKG,iBAAL,CAAuBpC,KAAvB;AACD,KAFD,MAEO,IAAI,OAAOA,KAAK,CAACC,GAAb,KAAqB,QAArB,IAAiCD,KAAK,CAACC,GAAN,CAAUgB,KAAV,CAAgB,IAAhB,CAAjC,IAA0DjB,KAAK,CAACC,GAAN,CAAU,CAAV,MAAiB,GAA/E,EAAoF;AACzF,WAAKoC,sBAAL,CAA4BrC,KAA5B;AACD;AACF;;AAEDoC,EAAAA,iBAAiB,CAACE,aAAD,EAAgC;AAC/C,UAAMtC,KAAK,GAAG,EAAE,GAAGsC;AAAL,KAAd;AACA,UAAM;AAAErC,MAAAA;AAAF,QAAUD,KAAhB;;AAEA,QAAI,OAAOC,GAAP,KAAe,QAAnB,EAA6B;AAC3B,UAAKA,GAAD,CAAgBsC,QAAhB,CAAyB,UAAzB,KAAwC,CAACC,kBAAOC,OAAP,CAAe,YAAf,EAA6B,KAA7B,CAA7C,EAAkF,CAChF;AACD,OAFD,MAEO;AACL;AACA,aAAKJ,sBAAL,CAA4BrC,KAA5B;AACD;;AACD;AACD;;AAED,YAAQC,GAAG,CAACI,IAAZ;AACE;AACA,WAAK,sBAAL;AACA,WAAK,6BAAL;AACA,WAAK,qBAAL;AACA,WAAK,mBAAL;AACE,aAAKqC,2BAAL,CAAiC1C,KAAjC;;AACA;;AAEF,WAAK,oBAAL;AACEA,QAAAA,KAAK,CAACO,eAAN,GAAwB,0BAAxB;AACAP,QAAAA,KAAK,CAACC,GAAN,GAAY,wBAAZ;AACA;;AACF,WAAK,iBAAL;AACED,QAAAA,KAAK,CAACC,GAAN,GAAa,uBAAb;AACA;;AACF,WAAK,mBAAL;AAA0B;AACxB;AACA,gBAAM0C,IAAI,GAAG1C,GAAG,CAAC2C,KAAJ,CAAUD,IAAvB;AACA3C,UAAAA,KAAK,CAACC,GAAN,GACE0C,IAAI,KAAK,YAAT,GACK,sCAAqC1C,GAAG,CAAC4C,IAAK,uBADnD,GAEK,yCAAwCF,IAAK,GAHpD;AAIA;AACD;;AACD,WAAK,gBAAL;AACE3C,QAAAA,KAAK,CAACC,GAAN,GACE,KAAK6C,4BAAL,CAAkC7C,GAAG,CAAC2C,KAAtC,KACA,KAAKG,oBAAL,CAA0B9C,GAAG,CAAC2C,KAA9B,CADA,IAEA3C,GAHF;AAIAD,QAAAA,KAAK,CAACgD,KAAN,GAAcC,mBAAOC,KAArB;AACA;;AACF,WAAK,kBAAL;AACElD,QAAAA,KAAK,CAACC,GAAN,GAAYA,GAAG,CAACkD,OAAhB;AACAnD,QAAAA,KAAK,CAACgD,KAAN,GAAcC,mBAAOG,IAArB;AACA;;AACF,WAAK,uBAAL;AACEpD,QAAAA,KAAK,CAACC,GAAN,GACE,gFADF;AAEA;;AACF,WAAK,kBAAL;AACED,QAAAA,KAAK,CAACC,GAAN,GAAa,gGAAb;AACA;;AACF,WAAK,uBAAL;AACE,YAAIA,GAAG,CAACoD,MAAJ,KAAe,iBAAnB,EAAsC;AACpCrD,UAAAA,KAAK,CAACC,GAAN,GACE,8EADF;AAED,SAHD,MAGO,IAAIA,GAAG,CAACoD,MAAJ,KAAe,iBAAnB,EAAsC;AAC3CrD,UAAAA,KAAK,CAACC,GAAN,GAAa,yFAAb;AACD,SAFM,MAEA;AACLD,UAAAA,KAAK,CAACC,GAAN,GAAa,6CAA4CA,GAAG,CAACoD,MAAO,EAApE;AACD;;AACD;;AACF,WAAK,qBAAL;AACErD,QAAAA,KAAK,CAACC,GAAN,GAAY,KAAKqD,kBAAL,CAAwB,QAAxB,EAAkCrD,GAAG,CAACD,KAAtC,CAAZ;AACA;;AACF,WAAK,qBAAL;AACEA,QAAAA,KAAK,CAACC,GAAN,GAAY,KAAKqD,kBAAL,CAAwB,QAAxB,EAAkCrD,GAAG,CAACD,KAAtC,CAAZ;AACA;AACF;;AACA,WAAK,YAAL;AACA,WAAK,mBAAL;AACA,WAAK,kBAAL;AACA,WAAK,oBAAL;AACE;;AACF;AACEA,QAAAA,KAAK,CAACC,GAAN,GAAa,uBAAsBsD,IAAI,CAACC,SAAL,CAAevD,GAAf,CAAoB,EAAvD;AACA;AAnEJ;;AAqEA,SAAKoC,sBAAL,CAA4BrC,KAA5B;AACD,GAjKqC,CAmKtC;AACA;AACA;;;AA0BoC,SAA7ByD,6BAA6B,CAACvD,aAAD,EAAuC;AAAA;;AACzE,UAAMwD,QAAQ,4BAAGxD,aAAH,aAAGA,aAAH,uBAAGA,aAAa,CAAEwD,QAAlB,yEAA8B,IAA5C;;AACA,QAAIA,QAAJ,EAAc;AACZ,YAAMC,SAAS,GAAG;AAAEC,QAAAA,GAAG,EAAE,KAAP;AAAcC,QAAAA,OAAO,EAAE,SAAvB;AAAkCC,QAAAA,GAAG,EAAE;AAAvC,QAA+CJ,QAA/C,KAA4DA,QAA9E;AACA,aAAQ,GAAEK,iBAAMC,IAAN,CAAWL,SAAX,CAAsB,GAAhC;AACD;;AAED,WAAO,EAAP;AACD;;AAEOnD,EAAAA,gCAAgC,CACtCR,KADsC,EAEtCE,aAFsC,EAGtC;AACA,QAAI,KAAKO,mBAAT,EAA8B;AAC5B;AACD;;AAED,SAAKA,mBAAL,GAA2BT,KAAK,CAACiE,EAAjC;AACA,SAAKC,iBAAL,GAAyB,IAAIC,IAAJ,EAAzB;AAEAnE,IAAAA,KAAK,CAACC,GAAN,GAAY,4BAAZ;;AAEA,QAAI,KAAKoB,mBAAT,EAA8B;AAC5B,WAAKA,mBAAL,CAAyB;AAAErB,QAAAA,KAAF;AAASE,QAAAA;AAAT,OAAzB;AACD,KAFD,MAEO;AACL,WAAKmC,sBAAL,CAA4BrC,KAA5B;AACD;AACF;;AAEOU,EAAAA,oCAAoC,CAC1C0D,aAD0C,EAE1ClE,aAF0C,EAG1C;AACA,UAAMD,GAAG,GAAGmE,aAAa,CAACnE,GAA1B;AAEA,QAAIoE,eAAJ;AACA,QAAIC,cAAc,GAAG,KAArB;;AACA,QAAIrE,GAAG,CAACI,IAAJ,KAAa,mBAAjB,EAAsC;AACpCgE,MAAAA,eAAe,GAAG,GAAlB;AACAC,MAAAA,cAAc,GAAG,IAAjB;;AACA,UAAI,KAAKJ,iBAAT,EAA4B;AAC1B,cAAMK,QAAQ,GAAG,IAAIJ,IAAJ,GAAWK,OAAX,KAAuB,KAAKN,iBAAL,CAAuBM,OAAvB,EAAxC;;AACAJ,QAAAA,aAAa,CAACnE,GAAd,GAAqB,2CAA0CsE,QAAS,KAAxE;AACD,OAHD,MAGO;AACLH,QAAAA,aAAa,CAACnE,GAAd,GAAqB,uCAArB;AACD;AACF,KATD,MASO,IAAIA,GAAG,CAACI,IAAJ,KAAa,qBAAjB,EAAwC;AAC7CgE,MAAAA,eAAe,GAAG,CAAC,CAAnB;AACAC,MAAAA,cAAc,GAAG,IAAjB;AACAF,MAAAA,aAAa,CAACnE,GAAd,GAAqB,mCAArB;AACAmE,MAAAA,aAAa,CAACpB,KAAd,GAAsBC,mBAAOC,KAA7B;AACD,KALM,MAKA,IAAIjD,GAAG,CAACI,IAAJ,KAAa,6BAAjB,EAAgD;AACrD,UAAIJ,GAAG,CAACwE,UAAR,EAAoB;AAClBJ,QAAAA,eAAe,GAAGpE,GAAG,CAACwE,UAAJ,GAAiB,GAAnC;AACD,OAFD,MAEO;AACLJ,QAAAA,eAAe,GAAIpE,GAAG,CAACyE,oBAAJ,GAA2BzE,GAAG,CAAC0E,cAAhC,GAAkD,GAApE,CADK,CAEL;AACD;;AACD,YAAMC,sBAAsB,GAAGC,IAAI,CAACC,KAAL,CAAW,MAAMT,eAAjB,IAAoC,GAAnE;AACAD,MAAAA,aAAa,CAACnE,GAAd,GAAqB,+BAA8B2E,sBAAuB,GAA1E;AACD,KATM,MASA;AACL;AACD;;AAED,QAAI,KAAKnE,mBAAT,EAA8B;AAC5B2D,MAAAA,aAAa,CAACH,EAAd,GAAmB,KAAKxD,mBAAxB;AACD;;AAED,QAAI,KAAKa,sBAAT,EAAiC;AAC/B,WAAKA,sBAAL,CAA4B;AAC1ByD,QAAAA,QAAQ,EAAEV,eADgB;AAE1BW,QAAAA,KAAK,EAAE,KAAKd,iBAFc;AAG1BlE,QAAAA,KAAK,EAAEoE,aAHmB;AAI1BlE,QAAAA;AAJ0B,OAA5B;;AAOA,UAAIoE,cAAJ,EAAoB;AAClB,YAAI,KAAK/C,oBAAL,IAA6B,KAAK2C,iBAAtC,EAAyD;AACvD,gBAAMtB,KAAK,GAAG3C,GAAG,CAACI,IAAJ,KAAa,qBAAb,GAAqC,cAArC,GAAsD,IAApE;;AACA,eAAKkB,oBAAL,CAA0B;AACxBqB,YAAAA,KADwB;AAExBoC,YAAAA,KAAK,EAAE,KAAKd,iBAFY;AAGxBe,YAAAA,GAAG,EAAE,IAAId,IAAJ,EAHmB;AAIxBnE,YAAAA,KAAK,EAAEoE,aAJiB;AAKxBlE,YAAAA;AALwB,WAA1B;AAOD;;AACD,aAAKgE,iBAAL,GAAyB,IAAzB;AACA,aAAKzD,mBAAL,GAA2B,IAA3B;AACD;AACF,KAtBD,MAsBO;AACL,WAAKE,WAAL,CAAiBC,IAAI,IAAI;AACvB,YAAI,CAACA,IAAD,IAAS,CAACA,IAAI,CAACE,MAAnB,EAA2B;AACzB,iBAAO,EAAP;AACD;;AAEDF,QAAAA,IAAI,CAACsE,OAAL,CAAaC,GAAG,IAAI;AAClB,cAAIA,GAAG,CAAClB,EAAJ,KAAW,KAAKxD,mBAApB,EAAyC;AACvC0E,YAAAA,GAAG,CAAClF,GAAJ,GAAUmE,aAAa,CAACnE,GAAxB;AACD;AACF,SAJD;;AAMA,YAAIqE,cAAJ,EAAoB;AAClB,eAAK7D,mBAAL,GAA2B,IAA3B;AACD;;AAED,eAAO,CAAC,GAAGG,IAAJ,CAAP;AACD,OAhBD;AAiBD;AACF;;AAEDkC,EAAAA,4BAA4B,CAACF,KAAD,EAAmC;AAC7D,QAAI,CAACA,KAAK,CAACwC,OAAX,EAAoB;AAClB,aAAO,IAAP;AACD;;AACD,UAAMnE,KAAK,GAAG,oCAAoCoE,IAApC,CAAyCzC,KAAK,CAACwC,OAA/C,CAAd;AACA,UAAME,gBAAgB,GAAG1C,KAAK,CAAC0C,gBAA/B;;AACA,QAAI,CAACrE,KAAD,IAAU,CAACqE,gBAAf,EAAiC;AAC/B,aAAO,IAAP;AACD;;AACD,UAAMC,UAAU,GAAGtE,KAAK,CAAC,CAAD,CAAxB;;AACA,UAAMuE,YAAY,GAAGC,gBAAKC,QAAL,CAAc,KAAKvE,YAAnB,EAAiCmE,gBAAjC,CAArB;;AAEA,UAAMK,aAAa,GACjB,6EADF;;AAGA,QAAIC,mBAAmB,CAACrD,QAApB,CAA6BgD,UAA7B,CAAJ,EAA8C;AAC5C,UAAID,gBAAgB,CAAC/C,QAAjB,CAA0B,cAA1B,CAAJ,EAA+C;AAC7C,eAAQ,mBAAkBiD,YAAa,2DAA0DD,UAAW,0GAAyGI,aAAc,EAAnO;AACD,OAFD,MAEO;AACL,eAAQ,uEAAsEJ,UAAW,WAAUC,YAAa,0GAAyGG,aAAc,EAAvO;AACD;AACF;;AACD,WAAQ,sBAAqBJ,UAAW,WAAUC,YAAa,GAA/D;AACD;;AAEDzC,EAAAA,oBAAoB,CAACH,KAAD,EAAmC;AACrD,QAAIwC,OAAO,GAAGxC,KAAK,CAACwC,OAApB;;AACA,QAAI,CAACA,OAAD,IAAYS,KAAK,CAACC,OAAN,CAAclD,KAAK,CAACmD,MAApB,CAAZ,IAA2CnD,KAAK,CAACmD,MAAN,CAAajF,MAA5D,EAAoE;AAClEsE,MAAAA,OAAO,GAAIxC,KAAK,CAACmD,MAAN,CAAa,CAAb,CAAD,CAAyBC,WAAnC;AACD;;AACD,QAAI,CAACZ,OAAL,EAAc;AACZ,aAAO,IAAP;AACD;;AAEDA,IAAAA,OAAO,GAAGrB,iBAAMkC,GAAN,CAAUb,OAAV,CAAV;AAEA,UAAMc,OAAO,GAAI,KAAK1E,mBAAL,IAA4B,KAAKA,mBAAL,CAAyBoB,KAAzB,CAA7B,IAAiEA,KAAK,CAACsD,OAAvF;;AACA,QAAIA,OAAJ,EAAa;AACXd,MAAAA,OAAO,IAAK,KAAIc,OAAQ,EAAxB;AACD,KAdoD,CAgBrD;;;AACA,UAAMC,gBAAgB,GAAG,CAACvD,KAAK,CAACwD,IAAP,IAAe,CAAC,aAAD,EAAgB7D,QAAhB,CAAyBK,KAAK,CAACwD,IAA/B,CAAxC,CAjBqD,CAkBrD;AACA;;AACA,UAAMC,6BAA6B,GAAGzD,KAAK,CAACvC,IAAN,KAAe,gBAAf,IAAmCuC,KAAK,CAAC0D,QAA/E,CApBqD,CAsBrD;;AACA,QAAI1D,KAAK,CAAC2D,KAAN,IAAeJ,gBAAf,IAAmC,CAACE,6BAAxC,EAAuE;AACrEjB,MAAAA,OAAO,IAAK,KAAIrB,iBAAMyC,IAAN,CAAW5D,KAAK,CAAC2D,KAAjB,CAAwB,EAAxC;AACD;;AACD,WAAOnB,OAAP;AACD;;AAED9B,EAAAA,kBAAkB,CAACmD,MAAD,EAA8BzG,KAA9B,EAA6C;AAC7D,WAAOA,KAAP,CAD6D,CAE7D;AACA;AACA;AACA;AACA;AACD;;AAEDqC,EAAAA,sBAAsB,CAACrC,KAAD,EAAmB;AACvC,QAAI,CAACA,KAAK,CAAC0G,UAAX,EAAuB;AACrB,WAAK7F,UAAL,CAAgB8F,IAAhB,CAAqB3G,KAArB;;AACA,WAAK4G,sBAAL;AACD;AACF;;AAcD1E,EAAAA,kBAAkB,CAAClC,KAAD,EAAmB;AACnC,QAAI;AACF,YAAM6G,SAAS,GAAGtD,IAAI,CAACuD,KAAL,CAAW9G,KAAK,CAACC,GAAjB,CAAlB;AACAD,MAAAA,KAAK,CAACC,GAAN,GAAY4G,SAAZ;AACD,KAHD,CAGE,OAAOE,CAAP,EAAU,CACV;AACD;;AAED,WAAO/G,KAAP;AACD;;AA1YqC;;;AAkaxC,MAAM4F,mBAAmB,GAAG,CAC1B,QAD0B,EAE1B,aAF0B,EAG1B,QAH0B,EAI1B,eAJ0B,EAK1B,SAL0B,EAM1B,QAN0B,EAO1B,OAP0B,EAQ1B,KAR0B,EAS1B,QAT0B,EAU1B,QAV0B,EAW1B,IAX0B,EAY1B,MAZ0B,EAa1B,OAb0B,EAc1B,KAd0B,EAe1B,IAf0B,EAgB1B,MAhB0B,EAiB1B,UAjB0B,EAkB1B,aAlB0B,EAmB1B,UAnB0B,EAoB1B,MApB0B,EAqB1B,QArB0B,EAsB1B,gBAtB0B,EAuB1B,KAvB0B,EAwB1B,KAxB0B,EAyB1B,KAzB0B,EA0B1B,MA1B0B,EA2B1B,IA3B0B,EA4B1B,IA5B0B,EA6B1B,MA7B0B,CAA5B","sourcesContent":["import { JSONObject } from '@expo/json-file';\nimport chalk from 'chalk';\nimport getenv from 'getenv';\nimport path from 'path';\n\nimport { Logger, ProjectUtils } from '../internal';\n\ntype BuildEventType =\n  | 'METRO_INITIALIZE_STARTED'\n  | 'BUILD_STARTED'\n  | 'BUILD_PROGRESS'\n  | 'BUILD_FAILED'\n  | 'BUILD_DONE';\ntype MetroLogRecord = {\n  tag: 'metro';\n  id: string;\n  shouldHide: boolean;\n  msg: ReportableEvent | string;\n  level: number;\n  _metroEventType?: BuildEventType;\n};\ntype ExpoLogRecord = {\n  tag: 'expo';\n  id: string;\n  shouldHide: boolean;\n  msg: any;\n  level: number;\n};\ntype DeviceLogRecord = {\n  tag: 'device';\n  id: string;\n  shouldHide: boolean;\n  msg: any;\n  level: number;\n  deviceId: string;\n  deviceName: string;\n};\nexport type LogRecord = (MetroLogRecord | ExpoLogRecord | DeviceLogRecord) & ProjectUtils.LogFields;\n\nexport type LogUpdater = (logState: LogRecord[]) => LogRecord[];\n\ntype ErrorObject = {\n  name?: string;\n  stack?: string;\n  message?: string;\n  code?: string;\n} & JSONObject;\n\ntype MetroError =\n  | ({\n      originModulePath: string;\n      message: string;\n      errors: { description: string; filename: string; lineNumber: number }[];\n    } & ErrorObject)\n  | ({\n      type: 'TransformError';\n      snippet: string;\n      lineNumber: number;\n      column: number;\n      filename: string;\n      errors: { description: string; filename: string; lineNumber: number }[];\n    } & ErrorObject)\n  | ErrorObject;\n\n// Metro reporter types\n// https://github.com/facebook/metro/blob/2a327fb19dd62169ab3ae9069011d8a599cfcf3e/packages/metro/src/lib/reporting.js\ntype GlobalCacheDisabledReason = 'too_many_errors' | 'too_many_misses';\ntype BundleDetails = {\n  entryFile: string;\n  platform: string;\n  dev: boolean;\n  minify: boolean;\n  bundleType: string;\n};\ntype ReportableEvent =\n  | {\n      port: number | undefined;\n      projectRoots: readonly string[];\n      type: 'initialize_started';\n    }\n  | {\n      type: 'initialize_done';\n    }\n  | {\n      type: 'client_log';\n      data: any;\n    }\n  | {\n      type: 'initialize_failed';\n      port: number;\n      error: MetroError;\n    }\n  | {\n      buildID: string;\n      type: 'bundle_build_done';\n    }\n  | {\n      buildID: string;\n      type: 'bundle_build_failed';\n    }\n  | {\n      buildID: string;\n      bundleDetails: BundleDetails;\n      type: 'bundle_build_started';\n    }\n  | {\n      error: MetroError;\n      type: 'bundling_error';\n    }\n  | {\n      // Currently only sent from Webpack\n      warning: string;\n      type: 'bundling_warning';\n    }\n  | {\n      type: 'dep_graph_loading';\n    }\n  | {\n      type: 'dep_graph_loaded';\n    }\n  | {\n      buildID: string;\n      type: 'bundle_transform_progressed';\n      transformedFileCount: number;\n      totalFileCount: number;\n\n      // A special property added for webpack support\n      percentage?: number;\n    }\n  | {\n      type: 'global_cache_error';\n      error: MetroError;\n    }\n  | {\n      type: 'global_cache_disabled';\n      reason: GlobalCacheDisabledReason;\n    }\n  | {\n      type: 'transform_cache_reset';\n    }\n  | {\n      type: 'worker_stdout_chunk';\n      chunk: string;\n    }\n  | {\n      type: 'worker_stderr_chunk';\n      chunk: string;\n    }\n  | {\n      type: 'hmr_client_error';\n      error: MetroError;\n    };\n\ntype StartBuildBundleCallback = (props: {\n  chunk: LogRecord;\n  bundleDetails: BundleDetails | null;\n}) => void;\ntype ProgressBuildBundleCallback = (props: {\n  progress: number;\n  start: Date | null;\n  chunk: any;\n  bundleDetails: BundleDetails | null;\n}) => void;\ntype FinishBuildBundleCallback = (props: {\n  error: string | null;\n  start: Date;\n  end: Date;\n  chunk: MetroLogRecord;\n  bundleDetails: BundleDetails | null;\n}) => void;\n\nexport default class PackagerLogsStream {\n  _projectRoot: string;\n  _getCurrentOpenProjectId: () => any;\n  _updateLogs: (updater: LogUpdater) => void;\n  _logsToAdd: LogRecord[] = [];\n  _bundleBuildChunkID: string | null = null;\n  _onStartBuildBundle?: StartBuildBundleCallback;\n  _onProgressBuildBundle?: ProgressBuildBundleCallback;\n  _onFinishBuildBundle?: FinishBuildBundleCallback;\n  _bundleBuildStart: Date | null = null;\n  _getSnippetForError?: (error: MetroError) => string | null;\n\n  constructor({\n    projectRoot,\n    getCurrentOpenProjectId,\n    updateLogs,\n    onStartBuildBundle,\n    onProgressBuildBundle,\n    onFinishBuildBundle,\n    getSnippetForError,\n  }: {\n    projectRoot: string;\n    getCurrentOpenProjectId?: () => any;\n    updateLogs: (updater: LogUpdater) => void;\n    onStartBuildBundle?: StartBuildBundleCallback;\n    onProgressBuildBundle?: ProgressBuildBundleCallback;\n    onFinishBuildBundle?: FinishBuildBundleCallback;\n    getSnippetForError?: (error: MetroError) => string | null;\n  }) {\n    this._projectRoot = projectRoot;\n    this._getCurrentOpenProjectId = getCurrentOpenProjectId || (() => 1);\n    this._updateLogs = updateLogs;\n\n    // Optional properties in case the consumer wants to handle updates on\n    // its own, eg: for a progress bar\n    this._onStartBuildBundle = onStartBuildBundle;\n    this._onProgressBuildBundle = onProgressBuildBundle;\n    this._onFinishBuildBundle = onFinishBuildBundle;\n\n    // Optional function for creating custom code frame snippet\n    // (e.g. with terminal colors) from a syntax error.\n    this._getSnippetForError = getSnippetForError;\n\n    this._attachLoggerStream();\n  }\n\n  projectId?: number;\n\n  _attachLoggerStream() {\n    this.projectId = this._getCurrentOpenProjectId();\n\n    ProjectUtils.attachLoggerStream(this._projectRoot, {\n      stream: {\n        write: this._handleChunk.bind(this),\n      },\n      type: 'raw',\n    });\n  }\n\n  _handleChunk(chunk: LogRecord) {\n    if (chunk.tag !== 'metro' && chunk.tag !== 'expo') {\n      return;\n    } else if (this._getCurrentOpenProjectId() !== this.projectId) {\n      // TODO: We should be confident that we are properly unsubscribing\n      // from the stream rather than doing a defensive check like this.\n      return;\n    }\n\n    chunk = this._maybeParseMsgJSON(chunk);\n    chunk = this._cleanUpNodeErrors(chunk);\n    if (chunk.tag === 'metro') {\n      this._handleMetroEvent(chunk);\n    } else if (typeof chunk.msg === 'string' && chunk.msg.match(/\\w/) && chunk.msg[0] !== '{') {\n      this._enqueueAppendLogChunk(chunk);\n    }\n  }\n\n  _handleMetroEvent(originalChunk: MetroLogRecord) {\n    const chunk = { ...originalChunk };\n    const { msg } = chunk;\n\n    if (typeof msg === 'string') {\n      if ((msg as string).includes('HTTP/1.1') && !getenv.boolish('EXPO_DEBUG', false)) {\n        // Do nothing with this message - we want to filter out network requests logged by Metro.\n      } else {\n        // If Metro crashes for some reason, it may log an error message as a plain string to stderr.\n        this._enqueueAppendLogChunk(chunk);\n      }\n      return;\n    }\n\n    switch (msg.type) {\n      // Bundle transform events\n      case 'bundle_build_started':\n      case 'bundle_transform_progressed':\n      case 'bundle_build_failed':\n      case 'bundle_build_done':\n        this._handleBundleTransformEvent(chunk);\n        return;\n\n      case 'initialize_started':\n        chunk._metroEventType = 'METRO_INITIALIZE_STARTED';\n        chunk.msg = 'Starting Metro Bundler';\n        break;\n      case 'initialize_done':\n        chunk.msg = `Started Metro Bundler`;\n        break;\n      case 'initialize_failed': {\n        // SDK <=22\n        const code = msg.error.code;\n        chunk.msg =\n          code === 'EADDRINUSE'\n            ? `Metro Bundler can't listen on port ${msg.port}. The port is in use.`\n            : `Metro Bundler failed to start. (code: ${code})`;\n        break;\n      }\n      case 'bundling_error':\n        chunk.msg =\n          this._formatModuleResolutionError(msg.error) ||\n          this._formatBundlingError(msg.error) ||\n          msg;\n        chunk.level = Logger.ERROR;\n        break;\n      case 'bundling_warning':\n        chunk.msg = msg.warning;\n        chunk.level = Logger.WARN;\n        break;\n      case 'transform_cache_reset':\n        chunk.msg =\n          'Your JavaScript transform cache is empty, rebuilding (this may take a minute).';\n        break;\n      case 'hmr_client_error':\n        chunk.msg = `A WebSocket client got a connection error. Please reload your device to get HMR working again.`;\n        break;\n      case 'global_cache_disabled':\n        if (msg.reason === 'too_many_errors') {\n          chunk.msg =\n            'The global cache is now disabled because it has been failing too many times.';\n        } else if (msg.reason === 'too_many_misses') {\n          chunk.msg = `The global cache is now disabled because it has been missing too many consecutive keys.`;\n        } else {\n          chunk.msg = `The global cache is now disabled. Reason: ${msg.reason}`;\n        }\n        break;\n      case 'worker_stdout_chunk':\n        chunk.msg = this._formatWorkerChunk('stdout', msg.chunk);\n        break;\n      case 'worker_stderr_chunk':\n        chunk.msg = this._formatWorkerChunk('stderr', msg.chunk);\n        break;\n      // Ignored events.\n      case 'client_log':\n      case 'dep_graph_loading':\n      case 'dep_graph_loaded':\n      case 'global_cache_error':\n        return;\n      default:\n        chunk.msg = `Unrecognized event: ${JSON.stringify(msg)}`;\n        break;\n    }\n    this._enqueueAppendLogChunk(chunk);\n  }\n\n  // A cache of { [buildID]: BundleDetails } which can be used to\n  // add more contextual logs. BundleDetails is currently only sent with `bundle_build_started`\n  // so we need to cache the details in order to print the platform info with other event types.\n  bundleDetailsCache: Record<string, BundleDetails> = {};\n\n  // Any event related to bundle building is handled here\n  _handleBundleTransformEvent = (chunk: MetroLogRecord) => {\n    const msg = chunk.msg as ReportableEvent;\n\n    const bundleDetails = 'buildID' in msg ? this.bundleDetailsCache[msg.buildID] || null : null;\n\n    if (msg.type === 'bundle_build_started') {\n      // Cache bundle details for later.\n      this.bundleDetailsCache[String(msg.buildID)] = msg.bundleDetails;\n      chunk._metroEventType = 'BUILD_STARTED';\n      this._handleNewBundleTransformStarted(chunk, msg.bundleDetails);\n    } else if (msg.type === 'bundle_transform_progressed' && this._bundleBuildChunkID) {\n      chunk._metroEventType = 'BUILD_PROGRESS';\n      this._handleUpdateBundleTransformProgress(chunk, bundleDetails);\n    } else if (msg.type === 'bundle_build_failed' && this._bundleBuildChunkID) {\n      chunk._metroEventType = 'BUILD_FAILED';\n      this._handleUpdateBundleTransformProgress(chunk, bundleDetails);\n    } else if (msg.type === 'bundle_build_done' && this._bundleBuildChunkID) {\n      chunk._metroEventType = 'BUILD_DONE';\n      this._handleUpdateBundleTransformProgress(chunk, bundleDetails);\n    }\n  };\n\n  static getPlatformTagForBuildDetails(bundleDetails?: BundleDetails | null) {\n    const platform = bundleDetails?.platform ?? null;\n    if (platform) {\n      const formatted = { ios: 'iOS', android: 'Android', web: 'Web' }[platform] || platform;\n      return `${chalk.bold(formatted)} `;\n    }\n\n    return '';\n  }\n\n  private _handleNewBundleTransformStarted(\n    chunk: MetroLogRecord,\n    bundleDetails: BundleDetails | null\n  ) {\n    if (this._bundleBuildChunkID) {\n      return;\n    }\n\n    this._bundleBuildChunkID = chunk.id;\n    this._bundleBuildStart = new Date();\n\n    chunk.msg = 'Building JavaScript bundle';\n\n    if (this._onStartBuildBundle) {\n      this._onStartBuildBundle({ chunk, bundleDetails });\n    } else {\n      this._enqueueAppendLogChunk(chunk);\n    }\n  }\n\n  private _handleUpdateBundleTransformProgress(\n    progressChunk: MetroLogRecord,\n    bundleDetails: BundleDetails | null\n  ) {\n    const msg = progressChunk.msg as ReportableEvent;\n\n    let percentProgress;\n    let bundleComplete = false;\n    if (msg.type === 'bundle_build_done') {\n      percentProgress = 100;\n      bundleComplete = true;\n      if (this._bundleBuildStart) {\n        const duration = new Date().getTime() - this._bundleBuildStart.getTime();\n        progressChunk.msg = `Building JavaScript bundle: finished in ${duration}ms.`;\n      } else {\n        progressChunk.msg = `Building JavaScript bundle: finished.`;\n      }\n    } else if (msg.type === 'bundle_build_failed') {\n      percentProgress = -1;\n      bundleComplete = true;\n      progressChunk.msg = `Building JavaScript bundle: error`;\n      progressChunk.level = Logger.ERROR;\n    } else if (msg.type === 'bundle_transform_progressed') {\n      if (msg.percentage) {\n        percentProgress = msg.percentage * 100;\n      } else {\n        percentProgress = (msg.transformedFileCount / msg.totalFileCount) * 100;\n        // percentProgress = Math.floor((msg.transformedFileCount / msg.totalFileCount) * 100);\n      }\n      const roundedPercentProgress = Math.floor(100 * percentProgress) / 100;\n      progressChunk.msg = `Building JavaScript bundle: ${roundedPercentProgress}%`;\n    } else {\n      return;\n    }\n\n    if (this._bundleBuildChunkID) {\n      progressChunk.id = this._bundleBuildChunkID;\n    }\n\n    if (this._onProgressBuildBundle) {\n      this._onProgressBuildBundle({\n        progress: percentProgress,\n        start: this._bundleBuildStart,\n        chunk: progressChunk,\n        bundleDetails,\n      });\n\n      if (bundleComplete) {\n        if (this._onFinishBuildBundle && this._bundleBuildStart) {\n          const error = msg.type === 'bundle_build_failed' ? 'Build failed' : null;\n          this._onFinishBuildBundle({\n            error,\n            start: this._bundleBuildStart,\n            end: new Date(),\n            chunk: progressChunk,\n            bundleDetails,\n          });\n        }\n        this._bundleBuildStart = null;\n        this._bundleBuildChunkID = null;\n      }\n    } else {\n      this._updateLogs(logs => {\n        if (!logs || !logs.length) {\n          return [];\n        }\n\n        logs.forEach(log => {\n          if (log.id === this._bundleBuildChunkID) {\n            log.msg = progressChunk.msg;\n          }\n        });\n\n        if (bundleComplete) {\n          this._bundleBuildChunkID = null;\n        }\n\n        return [...logs];\n      });\n    }\n  }\n\n  _formatModuleResolutionError(error: MetroError): string | null {\n    if (!error.message) {\n      return null;\n    }\n    const match = /^Unable to resolve module `(.+?)`/.exec(error.message);\n    const originModulePath = error.originModulePath as string | null;\n    if (!match || !originModulePath) {\n      return null;\n    }\n    const moduleName = match[1];\n    const relativePath = path.relative(this._projectRoot, originModulePath);\n\n    const DOCS_PAGE_URL =\n      'https://docs.expo.dev/workflow/using-libraries/#using-third-party-libraries';\n\n    if (NODE_STDLIB_MODULES.includes(moduleName)) {\n      if (originModulePath.includes('node_modules')) {\n        return `The package at \"${relativePath}\" attempted to import the Node standard library module \"${moduleName}\". It failed because the native React runtime does not include the Node standard library. Read more at ${DOCS_PAGE_URL}`;\n      } else {\n        return `You attempted attempted to import the Node standard library module \"${moduleName}\" from \"${relativePath}\". It failed because the native React runtime does not include the Node standard library. Read more at ${DOCS_PAGE_URL}`;\n      }\n    }\n    return `Unable to resolve \"${moduleName}\" from \"${relativePath}\"`;\n  }\n\n  _formatBundlingError(error: MetroError): string | null {\n    let message = error.message;\n    if (!message && Array.isArray(error.errors) && error.errors.length) {\n      message = (error.errors[0] as any).description;\n    }\n    if (!message) {\n      return null;\n    }\n\n    message = chalk.red(message);\n\n    const snippet = (this._getSnippetForError && this._getSnippetForError(error)) || error.snippet;\n    if (snippet) {\n      message += `\\n${snippet}`;\n    }\n\n    // Import errors are already pretty useful and don't need extra info added to them.\n    const isAmbiguousError = !error.name || ['SyntaxError'].includes(error.name);\n    // When you have a basic syntax error in application code it will tell you the file\n    // and usually also provide a well informed error.\n    const isComprehensiveTransformError = error.type === 'TransformError' && error.filename;\n\n    // console.log(require('util').inspect(error, { depth: 4 }));\n    if (error.stack && isAmbiguousError && !isComprehensiveTransformError) {\n      message += `\\n${chalk.gray(error.stack)}`;\n    }\n    return message;\n  }\n\n  _formatWorkerChunk(origin: 'stdout' | 'stderr', chunk: string) {\n    return chunk;\n    // const lines = chunk.split('\\n');\n    // if (lines.length >= 1 && lines[lines.length - 1] === '') {\n    //   lines.splice(lines.length - 1, 1);\n    // }\n    // return lines.map(line => `transform[${origin}]: ${line}`).join('\\n');\n  }\n\n  _enqueueAppendLogChunk(chunk: LogRecord) {\n    if (!chunk.shouldHide) {\n      this._logsToAdd.push(chunk);\n      this._enqueueFlushLogsToAdd();\n    }\n  }\n\n  _enqueueFlushLogsToAdd = () => {\n    this._updateLogs(logs => {\n      if (this._logsToAdd.length === 0) {\n        return logs;\n      }\n\n      const nextLogs = logs.concat(this._logsToAdd);\n      this._logsToAdd = [];\n      return nextLogs;\n    });\n  };\n\n  _maybeParseMsgJSON(chunk: LogRecord) {\n    try {\n      const parsedMsg = JSON.parse(chunk.msg);\n      chunk.msg = parsedMsg;\n    } catch (e) {\n      // non-JSON message\n    }\n\n    return chunk;\n  }\n\n  _cleanUpNodeErrors = (chunk: LogRecord) => {\n    if (typeof chunk.msg !== 'string') {\n      return chunk;\n    }\n\n    if (chunk.msg.match(/\\(node:.\\d*\\)/)) {\n      // Example: (node:13817) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): SyntaxError: SyntaxError /Users/brent/universe/apps/new-project-template/main.js: Unexpected token (10:6)\n      // The first part of this is totally useless, so let's remove it.\n      if (chunk.msg.match(/UnhandledPromiseRejectionWarning/)) {\n        chunk.msg = chunk.msg.replace(/\\(node:.*\\(rejection .*\\):/, '');\n        if (chunk.msg.match(/SyntaxError: SyntaxError/)) {\n          chunk.msg = chunk.msg.replace('SyntaxError: ', '');\n        }\n      } else if (chunk.msg.match(/DeprecationWarning/)) {\n        chunk.msg = '';\n      }\n    }\n\n    return chunk;\n  };\n}\n\nconst NODE_STDLIB_MODULES = [\n  'assert',\n  'async_hooks',\n  'buffer',\n  'child_process',\n  'cluster',\n  'crypto',\n  'dgram',\n  'dns',\n  'domain',\n  'events',\n  'fs',\n  'http',\n  'https',\n  'net',\n  'os',\n  'path',\n  'punycode',\n  'querystring',\n  'readline',\n  'repl',\n  'stream',\n  'string_decoder',\n  'tls',\n  'tty',\n  'url',\n  'util',\n  'v8',\n  'vm',\n  'zlib',\n];\n"],"file":"PackagerLogsStream.js"}