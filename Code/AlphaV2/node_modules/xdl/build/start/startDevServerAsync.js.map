{"version":3,"sources":["../../src/start/startDevServerAsync.ts"],"names":["startDevServerAsync","projectRoot","startOptions","port","metroPort","devClient","Number","process","env","RCT_METRO_PORT","ProjectSettings","setPackagerInfoAsync","expoServerPort","packagerPort","options","logger","ProjectUtils","getLogger","target","reset","resetCache","maxWorkers","projectConfig","skipSDKVersionRequirement","unversioned","exp","sdkVersion","server","middleware","messageSocket","useExpoUpdatesManifest","forceManifestType","ExpoUpdatesManifestHandler","getManifestHandler","ManifestHandler","use","LoadingPageHandler","getLoadingPageHandler"],"mappings":";;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAQA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AA0BO,eAAeA,mBAAf,CACLC,WADK,EAELC,YAFK,EAGuC;AAC5C,0CAAuBD,WAAvB;AAEA,MAAIE,IAAJ;;AAEA,MAAID,YAAY,CAACE,SAAb,IAA0B,IAA9B,EAAoC;AAClC;AACAD,IAAAA,IAAI,GAAGD,YAAY,CAACE,SAApB;AACD,GAHD,MAGO;AACLD,IAAAA,IAAI,GAAGD,YAAY,CAACG,SAAb,GACHC,MAAM,CAACC,OAAO,CAACC,GAAR,CAAYC,cAAb,CAAN,IAAsC,IADnC,GAEH,MAAM,kCAAiBP,YAAY,CAACE,SAAb,IAA0B,KAA3C,CAFV;AAGD;;AACD,QAAMM,4BAAgBC,oBAAhB,CAAqCV,WAArC,EAAkD;AACtDW,IAAAA,cAAc,EAAET,IADsC;AAEtDU,IAAAA,YAAY,EAAEV;AAFwC,GAAlD,CAAN;AAKA,QAAMW,OAA8B,GAAG;AACrCX,IAAAA,IADqC;AAErCY,IAAAA,MAAM,EAAEC,yBAAaC,SAAb,CAAuBhB,WAAvB,CAF6B;AAGrC;AACAiB,IAAAA,MAAM,EAAEhB,YAAY,CAACgB;AAJgB,GAAvC;;AAMA,MAAIhB,YAAY,CAACiB,KAAjB,EAAwB;AACtBL,IAAAA,OAAO,CAACM,UAAR,GAAqB,IAArB;AACD;;AACD,MAAIlB,YAAY,CAACmB,UAAb,IAA2B,IAA/B,EAAqC;AACnCP,IAAAA,OAAO,CAACO,UAAR,GAAqBnB,YAAY,CAACmB,UAAlC;AACD,GA7B2C,CA+B5C;;;AACA,QAAMC,aAAa,GAAG,yBAAUrB,WAAV,EAAuB;AAAEsB,IAAAA,yBAAyB,EAAE;AAA7B,GAAvB,CAAtB,CAhC4C,CAkC5C;;AACAT,EAAAA,OAAO,CAACU,WAAR,GACE,CAACF,aAAa,CAACG,GAAd,CAAkBC,UAAnB,IAAiCJ,aAAa,CAACG,GAAd,CAAkBC,UAAlB,KAAiC,aADpE;AAGA,QAAM;AAAEC,IAAAA,MAAF;AAAUC,IAAAA,UAAV;AAAsBC,IAAAA;AAAtB,MAAwC,MAAM,yCAAuB5B,WAAvB,EAAoCa,OAApC,CAApD;AAEA,QAAMgB,sBAAsB,GAAG5B,YAAY,CAAC6B,iBAAb,KAAmC,cAAlE,CAxC4C,CAyC5C;AACA;AACA;AACA;AACA;AACA;;AACA,sCACEH,UADF,EAEEE,sBAAsB,GAClBE,uCAA2BC,kBAA3B,CAA8ChC,WAA9C,CADkB,GAElBiC,4BAAgBD,kBAAhB,CAAmChC,WAAnC,CAJN;AAOA2B,EAAAA,UAAU,CAACO,GAAX,CAAeC,+BAAmBC,qBAAnB,CAAyCpC,WAAzC,CAAf;AAEA,SAAO,CAAC0B,MAAD,EAASC,UAAT,EAAqBC,aAArB,CAAP;AACD","sourcesContent":["import { ExpoConfig, getConfig, ProjectTarget } from '@expo/config';\nimport {\n  MessageSocket,\n  MetroDevServerOptions,\n  prependMiddleware,\n  runMetroDevServerAsync,\n} from '@expo/dev-server';\nimport http from 'http';\n\nimport {\n  assertValidProjectRoot,\n  ExpoUpdatesManifestHandler,\n  getFreePortAsync,\n  LoadingPageHandler,\n  ManifestHandler,\n  ProjectSettings,\n  ProjectUtils,\n} from '../internal';\n\nexport type StartOptions = {\n  metroPort?: number;\n  webpackPort?: number;\n  isWebSocketsEnabled?: boolean;\n  isRemoteReloadingEnabled?: boolean;\n  devClient?: boolean;\n  reset?: boolean;\n  nonInteractive?: boolean;\n  nonPersistent?: boolean;\n  maxWorkers?: number;\n  webOnly?: boolean;\n  target?: ProjectTarget;\n  platforms?: ExpoConfig['platforms'];\n  forceManifestType?: 'expo-updates' | 'classic';\n};\n\nexport async function startDevServerAsync(\n  projectRoot: string,\n  startOptions: StartOptions\n): Promise<[http.Server, any, MessageSocket]> {\n  assertValidProjectRoot(projectRoot);\n\n  let port: number;\n\n  if (startOptions.metroPort != null) {\n    // If the manually defined port is busy then an error should be thrown\n    port = startOptions.metroPort;\n  } else {\n    port = startOptions.devClient\n      ? Number(process.env.RCT_METRO_PORT) || 8081\n      : await getFreePortAsync(startOptions.metroPort || 19000);\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort: port,\n    packagerPort: port,\n  });\n\n  const options: MetroDevServerOptions = {\n    port,\n    logger: ProjectUtils.getLogger(projectRoot),\n    // @deprecated\n    target: startOptions.target,\n  };\n  if (startOptions.reset) {\n    options.resetCache = true;\n  }\n  if (startOptions.maxWorkers != null) {\n    options.maxWorkers = startOptions.maxWorkers;\n  }\n\n  // TODO: reduce getConfig calls\n  const projectConfig = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n\n  // Use the unversioned metro config.\n  options.unversioned =\n    !projectConfig.exp.sdkVersion || projectConfig.exp.sdkVersion === 'UNVERSIONED';\n\n  const { server, middleware, messageSocket } = await runMetroDevServerAsync(projectRoot, options);\n\n  const useExpoUpdatesManifest = startOptions.forceManifestType === 'expo-updates';\n  // We need the manifest handler to be the first middleware to run so our\n  // routes take precedence over static files. For example, the manifest is\n  // served from '/' and if the user has an index.html file in their project\n  // then the manifest handler will never run, the static middleware will run\n  // and serve index.html instead of the manifest.\n  // https://github.com/expo/expo/issues/13114\n  prependMiddleware(\n    middleware,\n    useExpoUpdatesManifest\n      ? ExpoUpdatesManifestHandler.getManifestHandler(projectRoot)\n      : ManifestHandler.getManifestHandler(projectRoot)\n  );\n\n  middleware.use(LoadingPageHandler.getLoadingPageHandler(projectRoot));\n\n  return [server, middleware, messageSocket];\n}\n"],"file":"startDevServerAsync.js"}