{"version":3,"sources":["../../src/start/startAsync.ts"],"names":["serverInstance","messageSocket","broadcastMessage","method","params","broadcast","startAsync","projectRoot","exp","skipSDKVersionRequirement","options","verbose","Analytics","logEvent","developerTool","Config","sdkVersion","webOnly","Webpack","port","webpackPort","Env","shouldUseDevServer","devClient","hostType","ProjectSettings","readAsync","ConnectionStatus","isOffline","e","ProjectUtils","logError","message","target","isTargetingNative","DevSession","startSession","stopDevServerAsync","Promise","resolve","reject","close","error","stopInternalAsync","stopSession","all","stopAsync","Android","maybeStopAdbDaemonAsync","forceQuitAsync","packagerPid","ngrokPid","readPackagerInfoAsync","process","kill","setPackagerInfoAsync","expoServerPort","packagerPort","expoServerNgrokUrl","packagerNgrokUrl","webpackServerPort","result","race","setTimeout"],"mappings":"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","sourcesContent":["import { ExpoConfig, getConfig } from '@expo/config';\nimport { closeJsInspector, MessageSocket } from '@expo/dev-server';\nimport { Server } from 'http';\n\nimport {\n  Analytics,\n  Android,\n  assertValidProjectRoot,\n  Config,\n  ConnectionStatus,\n  DevSession,\n  Env,\n  ProjectSettings,\n  ProjectUtils,\n  startDevServerAsync,\n  StartDevServerOptions,\n  startExpoServerAsync,\n  startReactNativeServerAsync,\n  startTunnelsAsync,\n  stopExpoServerAsync,\n  stopReactNativeServerAsync,\n  stopTunnelsAsync,\n  Webpack,\n} from '../internal';\nimport { watchBabelConfigForProject } from './watchBabelConfig';\n\nlet serverInstance: Server | null = null;\nlet messageSocket: MessageSocket | null = null;\n\n/**\n * Sends a message over web sockets to any connected device,\n * does nothing when the dev server is not running.\n *\n * @param method name of the command. In RN projects `reload`, and `devMenu` are available. In Expo Go, `sendDevCommand` is available.\n * @param params\n */\nexport function broadcastMessage(\n  method: 'reload' | 'devMenu' | 'sendDevCommand',\n  params?: Record<string, any> | undefined\n) {\n  if (messageSocket) {\n    messageSocket.broadcast(method, params);\n  }\n}\n\nexport async function startAsync(\n  projectRoot: string,\n  {\n    exp = getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp,\n    ...options\n  }: StartDevServerOptions & { exp?: ExpoConfig } = {},\n  verbose: boolean = true\n): Promise<ExpoConfig> {\n  assertValidProjectRoot(projectRoot);\n\n  Analytics.logEvent('Start Project', {\n    developerTool: Config.developerTool,\n    sdkVersion: exp.sdkVersion ?? null,\n  });\n\n  watchBabelConfigForProject(projectRoot);\n\n  if (options.webOnly) {\n    await Webpack.startAsync(projectRoot, {\n      ...options,\n      port: options.webpackPort,\n    });\n  } else if (Env.shouldUseDevServer(exp) || options.devClient) {\n    [serverInstance, , messageSocket] = await startDevServerAsync(projectRoot, options);\n  } else {\n    await startExpoServerAsync(projectRoot);\n    await startReactNativeServerAsync({ projectRoot, exp, options, verbose });\n  }\n\n  const { hostType } = await ProjectSettings.readAsync(projectRoot);\n\n  if (!ConnectionStatus.isOffline() && hostType === 'tunnel') {\n    try {\n      await startTunnelsAsync(projectRoot);\n    } catch (e: any) {\n      ProjectUtils.logError(projectRoot, 'expo', `Error starting ngrok: ${e.message}`);\n    }\n  }\n\n  const target = !options.webOnly || Webpack.isTargetingNative() ? 'native' : 'web';\n  // This is used to make Expo Go open the project in either Expo Go, or the web browser.\n  // Must come after ngrok (`startTunnelsAsync`) setup.\n  DevSession.startSession(projectRoot, exp, target);\n  return exp;\n}\n\nasync function stopDevServerAsync() {\n  return new Promise<void>((resolve, reject) => {\n    if (serverInstance) {\n      closeJsInspector();\n      serverInstance.close(error => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve();\n        }\n      });\n    }\n  });\n}\n\nasync function stopInternalAsync(projectRoot: string): Promise<void> {\n  DevSession.stopSession();\n\n  await Promise.all([\n    Webpack.stopAsync(projectRoot),\n    stopDevServerAsync(),\n    stopExpoServerAsync(projectRoot),\n    stopReactNativeServerAsync(projectRoot),\n    async () => {\n      if (!ConnectionStatus.isOffline()) {\n        try {\n          await stopTunnelsAsync(projectRoot);\n        } catch (e: any) {\n          ProjectUtils.logError(projectRoot, 'expo', `Error stopping ngrok: ${e.message}`);\n        }\n      }\n    },\n    await Android.maybeStopAdbDaemonAsync(),\n  ]);\n}\n\nasync function forceQuitAsync(projectRoot: string) {\n  // find RN packager and ngrok pids, attempt to kill them manually\n  const { packagerPid, ngrokPid } = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (packagerPid) {\n    try {\n      process.kill(packagerPid);\n    } catch (e) {}\n  }\n  if (ngrokPid) {\n    try {\n      process.kill(ngrokPid);\n    } catch (e) {}\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort: null,\n    packagerPort: null,\n    packagerPid: null,\n    expoServerNgrokUrl: null,\n    packagerNgrokUrl: null,\n    ngrokPid: null,\n    webpackServerPort: null,\n  });\n}\n\nexport async function stopAsync(projectRoot: string): Promise<void> {\n  try {\n    const result = await Promise.race([\n      stopInternalAsync(projectRoot),\n      new Promise(resolve => setTimeout(resolve, 2000, 'stopFailed')),\n    ]);\n    if (result === 'stopFailed') {\n      await forceQuitAsync(projectRoot);\n    }\n  } catch (error) {\n    await forceQuitAsync(projectRoot);\n    throw error;\n  }\n}\n"],"file":"startAsync.js"}