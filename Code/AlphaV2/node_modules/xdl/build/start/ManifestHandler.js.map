{"version":3,"sources":["../../src/start/ManifestHandler.ts"],"names":["_cachedSignedManifest","manifestString","signedManifest","blacklistedEnvironmentVariables","Set","shouldExposeEnvironmentVariableInManifest","key","has","toUpperCase","startsWith","stripPort","host","URL","hostname","getPackagerOptionsAsync","projectRoot","projectSettings","ProjectSettings","readAsync","bundleUrlPackagerOpts","JSON","parse","stringify","urlType","hostType","getBundleUrlAsync","platform","mainModuleName","queryParams","UrlUtils","constructBundleQueryParams","path","encodeURI","encodeURIComponent","constructBundleUrlAsync","getPlatformFromRequest","headers","toString","getManifestHandler","req","res","next","url","includes","pathname","Doctor","validateWithNetworkAsync","catch","error","ProjectUtils","logError","exp","hostInfo","getManifestResponseFromHeadersAsync","sdkVersion","setHeader","end","Analytics","logEvent","developerTool","Config","e","stack","statusCode","deviceIds","saveDevicesAsync","acceptSignature","getManifestResponseAsync","getExpoGoConfig","debuggerHost","logUrl","Promise","all","constructDebuggerHostAsync","constructLogUrlAsync","developer","tool","packagerOpts","__flipperHack","projectConfig","skipSDKVersionRequirement","entryPoint","Webpack","isTargetingNative","stripJSExtension","createHostInfoAsync","expoGoConfig","hostUri","constructHostUriAsync","manifest","Versions","lteSdkVersion","env","getManifestEnvironment","bundleUrl","ProjectAssets","resolveManifestAssets","resolver","match","resolveGoogleServicesFile","getManifestStringAsync","code","owner","addSigningDisabledWarning","chalk","bold","ConnectionStatus","setIsOffline","seen","reason","logWarning","Object","keys","process","reduce","prev","hostUUID","currentSession","UserManager","getSessionAsync","isOffline","id","ANONYMOUS_USERNAME","slug","getUnsignedManifestString","getSignedManifestStringAsync","UserSettings","getAnonymousIdentifierAsync","server","serverVersion","require","version","serverDriver","serverOS","os","serverOSVersion","release","user","ensureLoggedInAsync","response","ApiV2","clientForUser","postAsync","args","remoteUsername","getCurrentUsernameAsync","remotePackageName","unsignedManifest","signature"],"mappings":";;;;;;;;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAGA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;AAwCA,MAAMA,qBAA2C,GAAG;AAClDC,EAAAA,cAAc,EAAE,IADkC;AAElDC,EAAAA,cAAc,EAAE;AAFkC,CAApD;AAKA,MAAMC,+BAA+B,GAAG,IAAIC,GAAJ,CAAQ,CAC9C,qBAD8C,EAE9C,2BAF8C,EAG9C,gCAH8C,EAI9C,4BAJ8C,EAK9C,4BAL8C,EAM9C,mBAN8C,CAAR,CAAxC;;AASA,SAASC,yCAAT,CAAmDC,GAAnD,EAAgE;AAC9D,MAAIH,+BAA+B,CAACI,GAAhC,CAAoCD,GAAG,CAACE,WAAJ,EAApC,CAAJ,EAA4D;AAC1D,WAAO,KAAP;AACD;;AACD,SAAOF,GAAG,CAACG,UAAJ,CAAe,eAAf,KAAmCH,GAAG,CAACG,UAAJ,CAAe,OAAf,CAA1C;AACD;;AAEM,SAASC,SAAT,CAAmBC,IAAnB,EAAiE;AACtE,MAAI,CAACA,IAAL,EAAW;AACT,WAAOA,IAAP;AACD;;AACD,SAAO,KAAIC,UAAJ,EAAQ,GAAR,EAAc,UAASD,IAAK,EAA5B,EAA+BE,QAAtC;AACD;;AAEM,eAAeC,uBAAf,CACLC,WADK,EAEwD;AAC7D;AACA,QAAMC,eAAe,GAAG,MAAMC,4BAAgBC,SAAhB,CAA0BH,WAA1B,CAA9B;AACA,QAAMI,qBAAqB,GAAGC,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAeN,eAAf,CAAX,CAA9B;AACAG,EAAAA,qBAAqB,CAACI,OAAtB,GAAgC,MAAhC;;AACA,MAAIJ,qBAAqB,CAACK,QAAtB,KAAmC,UAAvC,EAAmD;AACjDL,IAAAA,qBAAqB,CAACK,QAAtB,GAAiC,QAAjC;AACD;;AACD,SAAO,CAACR,eAAD,EAAkBG,qBAAlB,CAAP;AACD;;AAEM,eAAeM,iBAAf,CAAiC;AACtCV,EAAAA,WADsC;AAEtCW,EAAAA,QAFsC;AAGtCV,EAAAA,eAHsC;AAItCG,EAAAA,qBAJsC;AAKtCQ,EAAAA,cALsC;AAMtCd,EAAAA;AANsC,CAAjC,EAca;AAClB,QAAMe,WAAW,GAAGC,qBAASC,0BAAT,CAAoCf,WAApC,EAAiDC,eAAjD,CAApB;;AAEA,QAAMe,IAAI,GAAI,IAAGC,SAAS,CAACL,cAAD,CAAiB,oBAAmBM,kBAAkB,CAC9EP,QAD8E,CAE9E,IAAGE,WAAY,EAFjB;AAIA,SACE,CAAC,MAAMC,qBAASK,uBAAT,CAAiCnB,WAAjC,EAA8CI,qBAA9C,EAAqEN,QAArE,CAAP,IAAyFkB,IAD3F;AAGD;;AAED,SAASI,sBAAT,CAAgCC,OAAhC,EAA2E;AACzE,SAAO,CAACA,OAAO,CAAC,mBAAD,CAAP,IAAgC,KAAjC,EAAwCC,QAAxC,EAAP;AACD;;AAEM,SAASC,kBAAT,CAA4BvB,WAA5B,EAAiD;AACtD,SAAO,OACLwB,GADK,EAELC,GAFK,EAGLC,IAHK,KAIF;AACH;AACA,QACE,CAACF,GAAG,CAACG,GAAL,IACA,CAAC,CAAC,GAAD,EAAM,WAAN,EAAmB,YAAnB,EAAiCC,QAAjC,EACC;AACA,sBAAMJ,GAAG,CAACG,GAAV,EAAeE,QAAf,IAA2BL,GAAG,CAACG,GAFhC,CAFH,EAME;AACAD,MAAAA,IAAI;AACJ;AACD;;AAED,QAAI;AAAA;;AACF;AACA;AACA;AACAI,yBAAOC,wBAAP,CAAgC/B,WAAhC,EAA6CgC,KAA7C,CAAmDC,KAAK,IAAI;AAC1DC,iCAAaC,QAAb,CACEnC,WADF,EAEE,MAFF,EAGG,wCAAuCA,WAAY,KAAIiC,KAAK,CAACX,QAAN,EAAiB,EAH3E,EAIE,6BAJF;AAMD,OAPD;;AASA,YAAM;AAAEpC,QAAAA,cAAF;AAAkBkD,QAAAA,GAAlB;AAAuBC,QAAAA;AAAvB,UAAoC,MAAMC,mCAAmC,CAAC;AAClFtC,QAAAA,WADkF;AAElFqB,QAAAA,OAAO,EAAEG,GAAG,CAACH;AAFqE,OAAD,CAAnF;AAIA,YAAMkB,UAAU,sBAAGH,GAAG,CAACG,UAAP,6DAAqB,IAArC,CAjBE,CAmBF;;AACAd,MAAAA,GAAG,CAACe,SAAJ,CAAc,iBAAd,EAAiCnC,IAAI,CAACE,SAAL,CAAe8B,QAAf,CAAjC,EApBE,CAqBF;;AACAZ,MAAAA,GAAG,CAACgB,GAAJ,CAAQvD,cAAR,EAtBE,CAwBF;;AACAwD,4BAAUC,QAAV,CAAmB,gBAAnB,EAAqC;AACnCC,QAAAA,aAAa,EAAEC,mBAAOD,aADa;AAEnCL,QAAAA;AAFmC,OAArC;AAID,KA7BD,CA6BE,OAAOO,CAAP,EAAU;AACVZ,+BAAaC,QAAb,CAAsBnC,WAAtB,EAAmC,MAAnC,EAA2C8C,CAAC,CAACC,KAA7C,EADU,CAEV;;;AACAtB,MAAAA,GAAG,CAACuB,UAAJ,GAAiB,GAAjB;AACAvB,MAAAA,GAAG,CAACgB,GAAJ,CACEpC,IAAI,CAACE,SAAL,CAAe;AACb0B,QAAAA,KAAK,EAAEa,CAAC,CAACxB,QAAF;AADM,OAAf,CADF;AAKD;;AAED,QAAI;AACF,YAAM2B,SAAS,GAAGzB,GAAG,CAACH,OAAJ,CAAY,oBAAZ,CAAlB;;AACA,UAAI4B,SAAJ,EAAe;AACb,cAAM/C,4BAAgBgD,gBAAhB,CAAiClD,WAAjC,EAA8CiD,SAA9C,CAAN;AACD;AACF,KALD,CAKE,OAAOH,CAAP,EAAU;AACVZ,+BAAaC,QAAb,CAAsBnC,WAAtB,EAAmC,MAAnC,EAA2C8C,CAAC,CAACC,KAA7C;AACD;AACF,GAjED;AAkED;;AAED,eAAeT,mCAAf,CAAmD;AACjDtC,EAAAA,WADiD;AAEjDqB,EAAAA;AAFiD,CAAnD,EAM6E;AAC3E;AACA,QAAMV,QAAQ,GAAGS,sBAAsB,CAACC,OAAD,CAAvC;AACA,QAAM8B,eAAe,GAAG9B,OAAO,CAAC,2BAAD,CAA/B;AACA,SAAO+B,wBAAwB,CAAC;AAAEpD,IAAAA,WAAF;AAAeJ,IAAAA,IAAI,EAAEyB,OAAO,CAACzB,IAA7B;AAAmCe,IAAAA,QAAnC;AAA6CwC,IAAAA;AAA7C,GAAD,CAA/B;AACD;;AAEM,eAAeE,eAAf,CAA+B;AACpCrD,EAAAA,WADoC;AAEpCC,EAAAA,eAFoC;AAGpCW,EAAAA,cAHoC;AAIpCd,EAAAA;AAJoC,CAA/B,EAUmB;AACxB,QAAM,CAACwD,YAAD,EAAeC,MAAf,IAAyB,MAAMC,OAAO,CAACC,GAAR,CAAY,CAC/C3C,qBAAS4C,0BAAT,CAAoC1D,WAApC,EAAiDF,QAAjD,CAD+C,EAE/CgB,qBAAS6C,oBAAT,CAA8B3D,WAA9B,EAA2CF,QAA3C,CAF+C,CAAZ,CAArC;AAIA,SAAO;AACL8D,IAAAA,SAAS,EAAE;AACTC,MAAAA,IAAI,EAAEhB,mBAAOD,aADJ;AAET5C,MAAAA;AAFS,KADN;AAKL8D,IAAAA,YAAY,EAAE7D,eALT;AAMLW,IAAAA,cANK;AAOL;AACA;AACA;AACA;AACAmD,IAAAA,aAAa,EAAE,kCAXV;AAYLT,IAAAA,YAZK;AAaLC,IAAAA;AAbK,GAAP;AAeD;;AAEM,eAAeH,wBAAf,CAAwC;AAC7CpD,EAAAA,WAD6C;AAE7CJ,EAAAA,IAF6C;AAG7Ce,EAAAA,QAH6C;AAI7CwC,EAAAA;AAJ6C,CAAxC,EAU2E;AAChF;AACA,QAAMa,aAAa,GAAG,yBAAUhE,WAAV,EAAuB;AAAEiE,IAAAA,yBAAyB,EAAE;AAA7B,GAAvB,CAAtB,CAFgF,CAGhF;;AACA,MAAI,CAACD,aAAa,CAAC5B,GAAd,CAAkBG,UAAvB,EAAmC;AACjCyB,IAAAA,aAAa,CAAC5B,GAAd,CAAkBG,UAAlB,GAA+B,aAA/B;AACD,GAN+E,CAOhF;;;AACA,QAAMzC,QAAQ,GAAGH,SAAS,CAACC,IAAD,CAA1B,CARgF,CAUhF;;AACA,MAAIsE,UAAU,GAAG,mCAAkBlE,WAAlB,EAA+BW,QAA/B,EAAyCqD,aAAzC,CAAjB,CAXgF,CAahF;AACA;AACA;;AACA,MAAIG,oBAAQC,iBAAR,EAAJ,EAAiC;AAC/BF,IAAAA,UAAU,GAAG,UAAb;AACD;;AACD,QAAMtD,cAAc,GAAGE,qBAASuD,gBAAT,CAA0BH,UAA1B,CAAvB,CAnBgF,CAoBhF;;;AACA,QAAM7B,QAAQ,GAAG,MAAMiC,mBAAmB,EAA1C;AACA,QAAM,CAACrE,eAAD,EAAkBG,qBAAlB,IAA2C,MAAML,uBAAuB,CAACC,WAAD,CAA9E,CAtBgF,CAuBhF;;AACA,QAAMuE,YAAY,GAAG,MAAMlB,eAAe,CAAC;AACzCrD,IAAAA,WADyC;AAEzCC,IAAAA,eAFyC;AAGzCW,IAAAA,cAHyC;AAIzCd,IAAAA;AAJyC,GAAD,CAA1C;AAMA,QAAM0E,OAAO,GAAG,MAAM1D,qBAAS2D,qBAAT,CAA+BzE,WAA/B,EAA4CF,QAA5C,CAAtB;AACA,QAAM4E,QAAyB,GAAG,EAChC,GAAIV,aAAa,CAAC5B,GADc;AAEhC,OAAGmC,YAF6B;AAGhCC,IAAAA;AAHgC,GAAlC,CA/BgF,CAoChF;AACA;;AACA,MAAIE,QAAQ,CAACnC,UAAT,IAAuBoC,qBAASC,aAAT,CAAuBF,QAAvB,EAAiC,QAAjC,CAA3B,EAAuE;AACrEA,IAAAA,QAAQ,CAACG,GAAT,GAAeC,sBAAsB,EAArC;AACD,GAxC+E,CA0ChF;;;AACAJ,EAAAA,QAAQ,CAACK,SAAT,GAAqB,MAAMrE,iBAAiB,CAAC;AAC3CV,IAAAA,WAD2C;AAE3CW,IAAAA,QAF2C;AAG3CV,IAAAA,eAH2C;AAI3CG,IAAAA,qBAJ2C;AAK3CQ,IAAAA,cAL2C;AAM3Cd,IAAAA;AAN2C,GAAD,CAA5C,CA3CgF,CAoDhF;;AACA,QAAMkF,0BAAcC,qBAAd,CAAoC;AACxCjF,IAAAA,WADwC;AAExC0E,IAAAA,QAFwC;;AAGxC,UAAMQ,QAAN,CAAelE,IAAf,EAAqB;AACnB,UAAImD,oBAAQC,iBAAR,EAAJ,EAAiC;AAC/B;AACA;AACA,eAAO,oBAAQM,QAAQ,CAACK,SAAT,CAAoBI,KAApB,CAA0B,mBAA1B,EAAgD,CAAhD,CAAR,EAA4DnE,IAA5D,CAAP;AACD;;AACD,aAAO0D,QAAQ,CAACK,SAAT,CAAoBI,KAApB,CAA0B,mBAA1B,EAAgD,CAAhD,IAAqD,SAArD,GAAiEnE,IAAxE;AACD;;AAVuC,GAApC,CAAN,CArDgF,CAiEhF;;AACA,QAAMgE,0BAAcI,yBAAd,CAAwCpF,WAAxC,EAAqD0E,QAArD,CAAN,CAlEgF,CAoEhF;;AACA,MAAIxF,cAAJ;;AACA,MAAI;AACFA,IAAAA,cAAc,GAAG,MAAMmG,sBAAsB,CAACX,QAAD,EAAWrC,QAAQ,CAACzC,IAApB,EAA0BuD,eAA1B,CAA7C;AACD,GAFD,CAEE,OAAOlB,KAAP,EAAc;AACd,QAAIA,KAAK,CAACqD,IAAN,KAAe,oBAAf,IAAuCZ,QAAQ,CAACa,KAApD,EAA2D;AACzD;AACAC,MAAAA,yBAAyB,CACvBxF,WADuB,EAEtB,2BAA0ByF,iBAAMC,IAAN,CACxB,IAAGhB,QAAQ,CAACa,KAAM,EADM,CAEzB,+DAFF,GAGG,2CAA0Cb,QAAQ,CAACa,KAAM,6DAH5D,GAIE,2BAAU,yDAAV,CANqB,CAAzB;;AAQAI,mCAAiBC,YAAjB,CAA8B,IAA9B;;AACA1G,MAAAA,cAAc,GAAG,MAAMmG,sBAAsB,CAACX,QAAD,EAAWrC,QAAQ,CAACzC,IAApB,EAA0BuD,eAA1B,CAA7C;AACD,KAZD,MAYO,IAAIlB,KAAK,CAACqD,IAAN,KAAe,WAAnB,EAAgC;AACrC;AACAE,MAAAA,yBAAyB,CACvBxF,WADuB,EAEtB,gEACCiC,KAAK,CAACnC,QAAN,IAAkB,UACnB,GAJsB,CAAzB;;AAMA6F,mCAAiBC,YAAjB,CAA8B,IAA9B;;AACA1G,MAAAA,cAAc,GAAG,MAAMmG,sBAAsB,CAACX,QAAD,EAAWrC,QAAQ,CAACzC,IAApB,EAA0BuD,eAA1B,CAA7C;AACD,KAVM,MAUA;AACL,YAAMlB,KAAN;AACD;AACF;;AAED,SAAO;AACL/C,IAAAA,cADK;AAELkD,IAAAA,GAAG,EAAEsC,QAFA;AAGLrC,IAAAA;AAHK,GAAP;AAKD;;AAED,MAAMmD,yBAAyB,GAAG,CAAC,MAAM;AACvC,MAAIK,IAAI,GAAG,KAAX;AACA,SAAO,CAAC7F,WAAD,EAAsB8F,MAAtB,KAAyC;AAC9C,QAAI,CAACD,IAAL,EAAW;AACTA,MAAAA,IAAI,GAAG,IAAP;;AACA3D,+BAAa6D,UAAb,CACE/F,WADF,EAEE,MAFF,EAGG,GAAE8F,MAAO,iCAHZ,EAIE,kBAJF;AAMD;AACF,GAVD;AAWD,CAbiC,GAAlC;;AAeA,SAAShB,sBAAT,GAAuD;AACrD,SAAOkB,MAAM,CAACC,IAAP,CAAYC,OAAO,CAACrB,GAApB,EAAyBsB,MAAzB,CAAqD,CAACC,IAAD,EAAO7G,GAAP,KAAe;AACzE,QAAID,yCAAyC,CAACC,GAAD,CAA7C,EAAoD;AAClD6G,MAAAA,IAAI,CAAC7G,GAAD,CAAJ,GAAY2G,OAAO,CAACrB,GAAR,CAAYtF,GAAZ,CAAZ;AACD;;AACD,WAAO6G,IAAP;AACD,GALM,EAKJ,EALI,CAAP;AAMD;;AAED,eAAef,sBAAf,CACEX,QADF,EAEE2B,QAFF,EAGElD,eAHF,EAImB;AACjB,QAAMmD,cAAc,GAAG,MAAMC,wBAAYC,eAAZ,EAA7B;;AACA,MAAI,CAACF,cAAD,IAAmBX,6BAAiBc,SAAjB,EAAvB,EAAqD;AACnD/B,IAAAA,QAAQ,CAACgC,EAAT,GAAe,IAAGC,8BAAmB,IAAGjC,QAAQ,CAACkC,IAAK,IAAGP,QAAS,EAAlE;AACD;;AACD,MAAI,CAAClD,eAAL,EAAsB;AACpB,WAAO9C,IAAI,CAACE,SAAL,CAAemE,QAAf,CAAP;AACD,GAFD,MAEO,IAAI,CAAC4B,cAAD,IAAmBX,6BAAiBc,SAAjB,EAAvB,EAAqD;AAC1D,WAAOI,yBAAyB,CAACnC,QAAD,CAAhC;AACD,GAFM,MAEA;AACL,WAAO,MAAMoC,4BAA4B,CAACpC,QAAD,EAAW4B,cAAX,CAAzC;AACD;AACF;;AAED,eAAehC,mBAAf,GAAwD;AACtD,QAAM1E,IAAI,GAAG,MAAMmH,yBAAaC,2BAAb,EAAnB;AAEA,SAAO;AACLpH,IAAAA,IADK;AAELqH,IAAAA,MAAM,EAAE,KAFH;AAGLC,IAAAA,aAAa,EAAEC,OAAO,CAAC,kBAAD,CAAP,CAA4BC,OAHtC;AAILC,IAAAA,YAAY,EAAExE,mBAAOD,aAJhB;AAKL0E,IAAAA,QAAQ,EAAEC,cAAG5G,QAAH,EALL;AAML6G,IAAAA,eAAe,EAAED,cAAGE,OAAH;AANZ,GAAP;AAQD;;AAEM,eAAeX,4BAAf,CACLpC,QADK,EAEL;AACA4B,cAHK,EAIL;AAAA;;AACA,QAAMpH,cAAc,GAAGmB,IAAI,CAACE,SAAL,CAAemE,QAAf,CAAvB;;AACA,MAAIzF,qBAAqB,CAACC,cAAtB,KAAyCA,cAA7C,EAA6D;AAC3D,WAAOD,qBAAqB,CAACE,cAA7B;AACD,GAJD,CAKA;AACA;;;AACA,QAAMuI,IAAI,GAAG,MAAMnB,wBAAYoB,mBAAZ,EAAnB;AACA,QAAM;AAAEC,IAAAA;AAAF,MAAe,MAAMC,kBAAMC,aAAN,CAAoBJ,IAApB,EAA0BK,SAA1B,CAAoC,eAApC,EAAqD;AAC9EC,IAAAA,IAAI,EAAE;AACJC,MAAAA,cAAc,qBAAEvD,QAAQ,CAACa,KAAX,6DAAqB,MAAMgB,wBAAY2B,uBAAZ,EADrC;AAEJC,MAAAA,iBAAiB,EAAEzD,QAAQ,CAACkC;AAFxB,KADwE;AAK9ElC,IAAAA,QAAQ,EAAEA;AALoE,GAArD,CAA3B;AAOAzF,EAAAA,qBAAqB,CAACC,cAAtB,GAAuCA,cAAvC;AACAD,EAAAA,qBAAqB,CAACE,cAAtB,GAAuCyI,QAAvC;AACA,SAAOA,QAAP;AACD;;AAEM,SAASf,yBAAT,CAAmCnC,QAAnC,EAAyD;AAC9D,QAAM0D,gBAAgB,GAAG;AACvBlJ,IAAAA,cAAc,EAAEmB,IAAI,CAACE,SAAL,CAAemE,QAAf,CADO;AAEvB2D,IAAAA,SAAS,EAAE;AAFY,GAAzB;AAIA,SAAOhI,IAAI,CAACE,SAAL,CAAe6H,gBAAf,CAAP;AACD","sourcesContent":["import { ExpoAppManifest, ExpoConfig, ExpoGoConfig, getConfig } from '@expo/config';\nimport { JSONObject } from '@expo/json-file';\nimport chalk from 'chalk';\nimport express from 'express';\nimport http from 'http';\nimport os from 'os';\nimport { parse, resolve, URL } from 'url';\n\nimport {\n  Analytics,\n  ANONYMOUS_USERNAME,\n  ApiV2,\n  Config,\n  ConnectionStatus,\n  Doctor,\n  learnMore,\n  ProjectAssets,\n  ProjectSettings,\n  ProjectUtils,\n  resolveEntryPoint,\n  UrlUtils,\n  UserManager,\n  UserSettings,\n  Versions,\n  Webpack,\n} from '../internal';\n\ninterface HostInfo {\n  host: string;\n  server: 'xdl';\n  serverVersion: string;\n  serverDriver: string | null;\n  serverOS: NodeJS.Platform;\n  serverOSVersion: string;\n}\n\ntype PackagerOptions = ProjectSettings.ProjectSettings;\n\ntype CachedSignedManifest =\n  | {\n      manifestString: null;\n      signedManifest: null;\n    }\n  | {\n      manifestString: string;\n      signedManifest: string;\n    };\n\nconst _cachedSignedManifest: CachedSignedManifest = {\n  manifestString: null,\n  signedManifest: null,\n};\n\nconst blacklistedEnvironmentVariables = new Set([\n  'EXPO_APPLE_PASSWORD',\n  'EXPO_ANDROID_KEY_PASSWORD',\n  'EXPO_ANDROID_KEYSTORE_PASSWORD',\n  'EXPO_IOS_DIST_P12_PASSWORD',\n  'EXPO_IOS_PUSH_P12_PASSWORD',\n  'EXPO_CLI_PASSWORD',\n]);\n\nfunction shouldExposeEnvironmentVariableInManifest(key: string) {\n  if (blacklistedEnvironmentVariables.has(key.toUpperCase())) {\n    return false;\n  }\n  return key.startsWith('REACT_NATIVE_') || key.startsWith('EXPO_');\n}\n\nexport function stripPort(host: string | undefined): string | undefined {\n  if (!host) {\n    return host;\n  }\n  return new URL('/', `http://${host}`).hostname;\n}\n\nexport async function getPackagerOptionsAsync(\n  projectRoot: string\n): Promise<[ProjectSettings.ProjectSettings, PackagerOptions]> {\n  // Get packager opts and then copy into bundleUrlPackagerOpts\n  const projectSettings = await ProjectSettings.readAsync(projectRoot);\n  const bundleUrlPackagerOpts = JSON.parse(JSON.stringify(projectSettings));\n  bundleUrlPackagerOpts.urlType = 'http';\n  if (bundleUrlPackagerOpts.hostType === 'redirect') {\n    bundleUrlPackagerOpts.hostType = 'tunnel';\n  }\n  return [projectSettings, bundleUrlPackagerOpts];\n}\n\nexport async function getBundleUrlAsync({\n  projectRoot,\n  platform,\n  projectSettings,\n  bundleUrlPackagerOpts,\n  mainModuleName,\n  hostname,\n}: {\n  platform: string;\n  hostname?: string;\n  mainModuleName: string;\n  projectRoot: string;\n  projectSettings: PackagerOptions;\n  bundleUrlPackagerOpts: PackagerOptions;\n}): Promise<string> {\n  const queryParams = UrlUtils.constructBundleQueryParams(projectRoot, projectSettings);\n\n  const path = `/${encodeURI(mainModuleName)}.bundle?platform=${encodeURIComponent(\n    platform\n  )}&${queryParams}`;\n\n  return (\n    (await UrlUtils.constructBundleUrlAsync(projectRoot, bundleUrlPackagerOpts, hostname)) + path\n  );\n}\n\nfunction getPlatformFromRequest(headers: http.IncomingHttpHeaders): string {\n  return (headers['exponent-platform'] || 'ios').toString();\n}\n\nexport function getManifestHandler(projectRoot: string) {\n  return async (\n    req: express.Request | http.IncomingMessage,\n    res: express.Response | http.ServerResponse,\n    next: (err?: Error) => void\n  ) => {\n    // Only support `/`, `/manifest`, `/index.exp` for the manifest middleware.\n    if (\n      !req.url ||\n      !['/', '/manifest', '/index.exp'].includes(\n        // Strip the query params\n        parse(req.url).pathname || req.url\n      )\n    ) {\n      next();\n      return;\n    }\n\n    try {\n      // We intentionally don't `await`. We want to continue trying even\n      // if there is a potential error in the package.json and don't want to slow\n      // down the request\n      Doctor.validateWithNetworkAsync(projectRoot).catch(error => {\n        ProjectUtils.logError(\n          projectRoot,\n          'expo',\n          `Error: could not load config json at ${projectRoot}: ${error.toString()}`,\n          'doctor-config-json-not-read'\n        );\n      });\n\n      const { manifestString, exp, hostInfo } = await getManifestResponseFromHeadersAsync({\n        projectRoot,\n        headers: req.headers,\n      });\n      const sdkVersion = exp.sdkVersion ?? null;\n\n      // Send the response\n      res.setHeader('Exponent-Server', JSON.stringify(hostInfo));\n      // End the request\n      res.end(manifestString);\n\n      // Log analytics\n      Analytics.logEvent('Serve Manifest', {\n        developerTool: Config.developerTool,\n        sdkVersion,\n      });\n    } catch (e) {\n      ProjectUtils.logError(projectRoot, 'expo', e.stack);\n      // 5xx = Server Error HTTP code\n      res.statusCode = 520;\n      res.end(\n        JSON.stringify({\n          error: e.toString(),\n        })\n      );\n    }\n\n    try {\n      const deviceIds = req.headers['expo-dev-client-id'];\n      if (deviceIds) {\n        await ProjectSettings.saveDevicesAsync(projectRoot, deviceIds);\n      }\n    } catch (e) {\n      ProjectUtils.logError(projectRoot, 'expo', e.stack);\n    }\n  };\n}\n\nasync function getManifestResponseFromHeadersAsync({\n  projectRoot,\n  headers,\n}: {\n  projectRoot: string;\n  headers: http.IncomingHttpHeaders;\n}): Promise<{ exp: ExpoConfig; manifestString: string; hostInfo: HostInfo }> {\n  // Read from headers\n  const platform = getPlatformFromRequest(headers);\n  const acceptSignature = headers['exponent-accept-signature'];\n  return getManifestResponseAsync({ projectRoot, host: headers.host, platform, acceptSignature });\n}\n\nexport async function getExpoGoConfig({\n  projectRoot,\n  projectSettings,\n  mainModuleName,\n  hostname,\n}: {\n  projectRoot: string;\n  projectSettings: ProjectSettings.ProjectSettings;\n  mainModuleName: string;\n  hostname: string | undefined;\n}): Promise<ExpoGoConfig> {\n  const [debuggerHost, logUrl] = await Promise.all([\n    UrlUtils.constructDebuggerHostAsync(projectRoot, hostname),\n    UrlUtils.constructLogUrlAsync(projectRoot, hostname),\n  ]);\n  return {\n    developer: {\n      tool: Config.developerTool,\n      projectRoot,\n    },\n    packagerOpts: projectSettings,\n    mainModuleName,\n    // Add this string to make Flipper register React Native / Metro as \"running\".\n    // Can be tested by running:\n    // `METRO_SERVER_PORT=19000 open -a flipper.app`\n    // Where 19000 is the port where the Expo project is being hosted.\n    __flipperHack: 'React Native packager is running',\n    debuggerHost,\n    logUrl,\n  };\n}\n\nexport async function getManifestResponseAsync({\n  projectRoot,\n  host,\n  platform,\n  acceptSignature,\n}: {\n  projectRoot: string;\n  platform: string;\n  host?: string;\n  acceptSignature?: string | string[];\n}): Promise<{ exp: ExpoAppManifest; manifestString: string; hostInfo: HostInfo }> {\n  // Read the config\n  const projectConfig = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  // Opt towards newest functionality when expo isn't installed.\n  if (!projectConfig.exp.sdkVersion) {\n    projectConfig.exp.sdkVersion = 'UNVERSIONED';\n  }\n  // Read from headers\n  const hostname = stripPort(host);\n\n  // Get project entry point and initial module\n  let entryPoint = resolveEntryPoint(projectRoot, platform, projectConfig);\n\n  // NOTE(Bacon): Webpack is currently hardcoded to index.bundle on native\n  // in the future (TODO) we should move this logic into a Webpack plugin and use\n  // a generated file name like we do on web.\n  if (Webpack.isTargetingNative()) {\n    entryPoint = 'index.js';\n  }\n  const mainModuleName = UrlUtils.stripJSExtension(entryPoint);\n  // Gather packager and host info\n  const hostInfo = await createHostInfoAsync();\n  const [projectSettings, bundleUrlPackagerOpts] = await getPackagerOptionsAsync(projectRoot);\n  // Create the manifest and set fields within it\n  const expoGoConfig = await getExpoGoConfig({\n    projectRoot,\n    projectSettings,\n    mainModuleName,\n    hostname,\n  });\n  const hostUri = await UrlUtils.constructHostUriAsync(projectRoot, hostname);\n  const manifest: ExpoAppManifest = {\n    ...(projectConfig.exp as ExpoAppManifest),\n    ...expoGoConfig,\n    hostUri,\n  };\n  // Adding the env variables to the Expo manifest is unsafe.\n  // This feature is deprecated in SDK 41 forward.\n  if (manifest.sdkVersion && Versions.lteSdkVersion(manifest, '40.0.0')) {\n    manifest.env = getManifestEnvironment();\n  }\n\n  // Add URLs to the manifest\n  manifest.bundleUrl = await getBundleUrlAsync({\n    projectRoot,\n    platform,\n    projectSettings,\n    bundleUrlPackagerOpts,\n    mainModuleName,\n    hostname,\n  });\n\n  // Resolve all assets and set them on the manifest as URLs\n  await ProjectAssets.resolveManifestAssets({\n    projectRoot,\n    manifest,\n    async resolver(path) {\n      if (Webpack.isTargetingNative()) {\n        // When using our custom dev server, just do assets normally\n        // without the `assets/` subpath redirect.\n        return resolve(manifest.bundleUrl!.match(/^https?:\\/\\/.*?\\//)![0], path);\n      }\n      return manifest.bundleUrl!.match(/^https?:\\/\\/.*?\\//)![0] + 'assets/' + path;\n    },\n  });\n  // The server normally inserts this but if we're offline we'll do it here\n  await ProjectAssets.resolveGoogleServicesFile(projectRoot, manifest);\n\n  // Create the final string\n  let manifestString;\n  try {\n    manifestString = await getManifestStringAsync(manifest, hostInfo.host, acceptSignature);\n  } catch (error) {\n    if (error.code === 'UNAUTHORIZED_ERROR' && manifest.owner) {\n      // Don't have permissions for siging, warn and enable offline mode.\n      addSigningDisabledWarning(\n        projectRoot,\n        `This project belongs to ${chalk.bold(\n          `@${manifest.owner}`\n        )} and you have not been granted the appropriate permissions.\\n` +\n          `Please request access from an admin of @${manifest.owner} or change the \"owner\" field to an account you belong to.\\n` +\n          learnMore('https://docs.expo.dev/versions/latest/config/app/#owner')\n      );\n      ConnectionStatus.setIsOffline(true);\n      manifestString = await getManifestStringAsync(manifest, hostInfo.host, acceptSignature);\n    } else if (error.code === 'ENOTFOUND') {\n      // Got a DNS error, i.e. can't access exp.host, warn and enable offline mode.\n      addSigningDisabledWarning(\n        projectRoot,\n        `Could not reach Expo servers, please check if you can access ${\n          error.hostname || 'exp.host'\n        }.`\n      );\n      ConnectionStatus.setIsOffline(true);\n      manifestString = await getManifestStringAsync(manifest, hostInfo.host, acceptSignature);\n    } else {\n      throw error;\n    }\n  }\n\n  return {\n    manifestString,\n    exp: manifest,\n    hostInfo,\n  };\n}\n\nconst addSigningDisabledWarning = (() => {\n  let seen = false;\n  return (projectRoot: string, reason: string) => {\n    if (!seen) {\n      seen = true;\n      ProjectUtils.logWarning(\n        projectRoot,\n        'expo',\n        `${reason}\\nFalling back to offline mode.`,\n        'signing-disabled'\n      );\n    }\n  };\n})();\n\nfunction getManifestEnvironment(): Record<string, any> {\n  return Object.keys(process.env).reduce<Record<string, any>>((prev, key) => {\n    if (shouldExposeEnvironmentVariableInManifest(key)) {\n      prev[key] = process.env[key];\n    }\n    return prev;\n  }, {});\n}\n\nasync function getManifestStringAsync(\n  manifest: ExpoAppManifest,\n  hostUUID: string,\n  acceptSignature?: string | string[]\n): Promise<string> {\n  const currentSession = await UserManager.getSessionAsync();\n  if (!currentSession || ConnectionStatus.isOffline()) {\n    manifest.id = `@${ANONYMOUS_USERNAME}/${manifest.slug}-${hostUUID}`;\n  }\n  if (!acceptSignature) {\n    return JSON.stringify(manifest);\n  } else if (!currentSession || ConnectionStatus.isOffline()) {\n    return getUnsignedManifestString(manifest);\n  } else {\n    return await getSignedManifestStringAsync(manifest, currentSession);\n  }\n}\n\nasync function createHostInfoAsync(): Promise<HostInfo> {\n  const host = await UserSettings.getAnonymousIdentifierAsync();\n\n  return {\n    host,\n    server: 'xdl',\n    serverVersion: require('xdl/package.json').version,\n    serverDriver: Config.developerTool,\n    serverOS: os.platform(),\n    serverOSVersion: os.release(),\n  };\n}\n\nexport async function getSignedManifestStringAsync(\n  manifest: Partial<ExpoAppManifest>,\n  // NOTE: we currently ignore the currentSession that is passed in, see the note below about analytics.\n  currentSession: { sessionSecret?: string; accessToken?: string }\n) {\n  const manifestString = JSON.stringify(manifest);\n  if (_cachedSignedManifest.manifestString === manifestString) {\n    return _cachedSignedManifest.signedManifest;\n  }\n  // WARNING: Removing the following line will regress analytics, see: https://github.com/expo/expo-cli/pull/2357\n  // TODO: make this more obvious from code\n  const user = await UserManager.ensureLoggedInAsync();\n  const { response } = await ApiV2.clientForUser(user).postAsync('manifest/sign', {\n    args: {\n      remoteUsername: manifest.owner ?? (await UserManager.getCurrentUsernameAsync()),\n      remotePackageName: manifest.slug,\n    },\n    manifest: manifest as JSONObject,\n  });\n  _cachedSignedManifest.manifestString = manifestString;\n  _cachedSignedManifest.signedManifest = response;\n  return response;\n}\n\nexport function getUnsignedManifestString(manifest: ExpoConfig) {\n  const unsignedManifest = {\n    manifestString: JSON.stringify(manifest),\n    signature: 'UNSIGNED',\n  };\n  return JSON.stringify(unsignedManifest);\n}\n"],"file":"ManifestHandler.js"}